var t=Object.defineProperty,e=(e,i,n)=>((e,i,n)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[i]=n)(e,"symbol"!=typeof i?i+"":i,n);import{P as i}from"./phaser-CmFXOKba.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class n{constructor(t){e(this,"gameObject"),e(this,"target","GAME_OBJECT"),e(this,"targetName",""),this.gameObject=t,t.__ActionTargetComp=this}static getComponent(t){return t.__ActionTargetComp}static getTargetGameObject(t,e){const i=n.getComponent(t);if(i)switch(i.target){case"GAME_OBJECT":return t.gameObject;case"ARG_1":return e[0];case"ARG_2":return e[1];case"ARG_3":return e[2];case"ARG_4":return e[3];case"ARG_5":return e[4];case"ARG_6":return e[5];case"ARG_7":return e[6];case"ARG_8":return e[7]}return t.gameObject}}class r{constructor(t){e(this,"_scene"),e(this,"_gameObject"),e(this,"_parent"),e(this,"_children"),this._parent=t,t instanceof r?(this._scene=t.scene,this._gameObject=t.gameObject,t.add(this)):t instanceof i.GameObjects.GameObject?(this._scene=t.scene,this._gameObject=t):this._scene=t;const n=this.awake!==r.prototype.awake,s=this.start!==r.prototype.start,a=this.update!==r.prototype.update,o=this.destroy!==r.prototype.destroy;if(n&&this.scene.events.once("scene-awake",this.awake,this),s&&this.scene.events.once(i.Scenes.Events.UPDATE,this.start,this),a&&this.scene.events.on(i.Scenes.Events.UPDATE,this.update,this),n||s||a||o){const t=()=>{this.scene.events.off("scene-awake",this.awake,this),this.scene.events.off(i.Scenes.Events.UPDATE,this.start,this),this.scene.events.off(i.Scenes.Events.UPDATE,this.update,this),o&&this.destroy()};this.gameObject?this.gameObject.on(i.GameObjects.Events.DESTROY,t):this.scene.events.on(i.Scenes.Events.SHUTDOWN,t)}}getActionTargetObject(t){return n.getTargetGameObject(this,t)}get scene(){return this._scene}get gameObject(){return this._gameObject}get parent(){return this._parent}get children(){return this._children||(this._children=[]),this._children}add(t){this.children.push(t)}executeChildren(...t){if(this._children)for(const e of this._children)e.execute(...t)}execute(...t){}awake(){}start(){}update(){}destroy(){}}class s extends r{constructor(t){super(t),this.scene.events.once("scene-awake",(()=>{this.executeChildren()}))}}class a extends r{constructor(t){super(t),e(this,"eventName",""),e(this,"eventEmitter","gameObject"),e(this,"once",!1)}awake(){let t;switch(this.eventEmitter){case"game.events":t=this.scene.game.events;break;case"scene.events":t=this.scene.events;break;case"scene.loader":t=this.scene.load;break;case"scene.input":t=this.scene.input;break;case"scene.input.keyboard":t=this.scene.input.keyboard;break;case"scene.anims":t=this.scene.anims;break;case"scene.physics.world":t=this.scene.physics.world;break;case"gameObject":t=this.gameObject}if(t){switch(this.once?t.once(this.eventName,this.executeChildren,this):t.on(this.eventName,this.executeChildren,this),this.eventEmitter){case"scene.anims":case"scene.events":case"scene.input":case"scene.input.keyboard":case"scene.loader":case"scene.physics.world":this.scene.events.on(i.Scenes.Events.SHUTDOWN,(()=>{null==t||t.off(this.eventName,this.executeChildren,this)}))}this.gameObject&&"gameObject"!==this.eventEmitter&&this.gameObject.once(i.GameObjects.Events.DESTROY,(()=>{null==t||t.off(this.eventName,this.executeChildren,this)}))}}}class o extends a{constructor(t){super(t),this.eventName="pointerdown"}awake(){this.gameObject&&(this.gameObject.input||this.gameObject.setInteractive(),super.awake())}}class l{constructor(t){e(this,"gameObject"),e(this,"delay",0),this.gameObject=t,t.__DelayConfigComp=this}static getComponent(t){return t.__DelayConfigComp}static getDelay(t,e){const i=l.getComponent(t);return i?i.delay:e}}class h{constructor(t){e(this,"gameObject"),e(this,"duration",250),this.gameObject=t,t.__DurationConfigComp=this}static getComponent(t){return t.__DurationConfigComp}static getDuration(t,e){const i=h.getComponent(t);return i?i.duration:e}}class u{constructor(t){e(this,"gameObject"),e(this,"ease","Linear"),this.gameObject=t,t.__EaseConfigComp=this}static getComponent(t){return t.__EaseConfigComp}static getEase(t,e){const i=u.getComponent(t);return i?i.ease:e}}class c extends r{constructor(t){super(t),e(this,"from","NONE")}execute(...t){const e=this.getActionTargetObject(t),i=h.getDuration(this,250),n=l.getDelay(this,0),r=u.getEase(this,"Expo"),{x:s,y:a}=e;let o=s,c=a;switch(this.from){case"LEFT":o=-e.displayWidth;break;case"RIGHT":o=this.scene.scale.width+e.displayWidth;break;case"TOP":c=-e.displayHeight;break;case"BOTTOM":c=this.scene.scale.height+e.displayHeight}e.setPosition(o,c),this.scene.add.tween({targets:e,x:s,y:a,duration:i,delay:n,ease:r,onComplete:()=>{this.executeChildren()}})}}class d extends r{constructor(t){super(t),e(this,"_executing",!1)}execute(t){if(this._executing)return;this._executing=!0;const e=h.getDuration(this,80),i=this.getActionTargetObject(t),{scaleX:n,scaleY:r}=i;this.scene.add.tween({targets:i,scaleX:.8*n,scaleY:.8*r,duration:e,yoyo:!0,onComplete:()=>{this._executing=!1,this.executeChildren(t)}})}}class p extends i.Scene{constructor(){super("Level")}editorCreate(){const t=this.add.image(640,257,"FufuSuperDino"),e=new o(t);new d(e);const i=new s(t),n=new c(i),r=this.add.text(640,458,"",{});r.setOrigin(.5,.5),r.text="Phaser 3 + Phaser Editor v4\nVite + TypeScript",r.setStyle({align:"center",fontFamily:"Arial",fontSize:"3em"});const a=new s(r),l=new c(a);n.from="TOP",l.from="BOTTOM",this.events.emit("scene-awake")}create(){this.editorCreate()}}class m extends r{constructor(t){super(t)}get gameObject(){return super.gameObject}awake(){const t=this.gameObject.width;this.scene.load.on(i.Loader.Events.PROGRESS,(e=>{this.gameObject.width=t*e}))}}class g extends i.Scene{constructor(){super("Preload")}editorCreate(){const t=this.add.image(505.0120544433594,360,"guapen");t.scaleX=.32715486817515643,t.scaleY=.32715486817515643;const e=this.add.rectangle(553.0120849609375,361,256,20);e.setOrigin(0,0),e.isFilled=!0,e.fillColor=14737632,new m(e);const i=this.add.rectangle(553.0120849609375,361,256,20);i.setOrigin(0,0),i.fillColor=14737632,i.isStroked=!0;const n=this.add.text(552.0120849609375,329,"",{});n.text="Loading...",n.setStyle({color:"#e0e0e0",fontFamily:"arial",fontSize:"20px"}),this.events.emit("scene-awake")}preload(){this.editorCreate(),this.load.pack("asset-pack","assets/asset-pack.json")}create(){this.scene.start("Level")}}function f(t){return 16*t}function y(t){return Math.floor(t/16)}function S(t){return Math.ceil(t/16)}const v=function(t,e){let i=0,n=0;switch(e){case"up":n=-1;break;case"down":n=1;break;case"left":i=-1;break;case"right":i=1}return t.map((t=>({x:t.x+i,y:t.y+n})))},C=20;var b,w,_,T,E,x=(t=>(t[t.IDLE=0]="IDLE",t[t.WALKING=1]="WALKING",t[t.ATTACKING=2]="ATTACKING",t))(x||{});class O extends i.Physics.Arcade.Sprite{constructor(t,i,n,r,s){super(t,f(i),f(n),r),e(this,"currentState",0),e(this,"animationStateComplete",!0),e(this,"stateData",{}),e(this,"occupiedGrids",[]),e(this,"targetGrids",[]),e(this,"grid"),e(this,"isActing",!1),e(this,"speed",C),e(this,"movingProgressRemaining"),this.grid=s,this.isActing=!1,t.add.existing(this),t.physics.add.existing(this),this.setOrigin(.5,.5),this.updateOccupiedGrids(),this.movingProgressRemaining,this.initializeAnimations(),this.setupEventListeners()}initializeAnimations(){this.scene.anims.exists("idle")||this.scene.anims.create({key:"idle",frames:this.scene.anims.generateFrameNumbers("Warrior_Blue",{frames:[0,1]}),frameRate:10,repeat:-1}),this.scene.anims.exists("walk")||this.scene.anims.create({key:"walk",frames:this.scene.anims.generateFrameNumbers("Warrior_Blue",{frames:[1,7,6,7]}),frameRate:30,repeat:-1}),this.scene.anims.exists("attack")||this.scene.anims.create({key:"attack",frames:this.scene.anims.generateFrameNumbers("Warrior_Blue",{frames:[12,13,14,15,16,17]}),frameRate:30,repeat:0})}setupEventListeners(){this.on("animationcomplete",(t=>{this.onAnimationComplete(t)}))}setCharacterState(t,e={}){2===t&&(this.animationStateComplete=!1),this.currentState=t,this.stateData=e,this.updateAnimation()}getCharacterState(){return this.currentState}updateAnimation(){switch(this.currentState){case 0:this.play("idle",!0);break;case 1:this.play("walk",!0);break;case 2:this.play("attack",!0),console.log("Attack animation started")}}getIsActing(){return this.isActing}setIsActing(t){this.isActing=t}updateOccupiedGrids(){this.occupiedGrids=[];const t=[],e=this.width*this.scaleX/2,i=this.height*this.scaleY/2,n=y(this.x-e),r=y(this.y-i),s=S(this.x+e),a=S(this.y+i);for(let o=r;o<=a;o++)for(let e=n;e<=s;e++)t.push({x:e,y:o});this.occupiedGrids=t}getOccupiedGrids(){return this.updateOccupiedGrids(),this.occupiedGrids}setTargetGrids(t){this.targetGrids=t}getTargetGrids(){return this.targetGrids}update(t){(2!==this.currentState||this.animationStateComplete)&&(this.movingProgressRemaining>0?(this.updatePosition(t),this.setCharacterState(1)):(1===this.currentState&&this.setCharacterState(0),this.setCharacterState(0)))}moveToGrid(t,e){if(this.isActing)return;this.setIsActing(!0);const i=this.calculateCenterPosition(t),n=t[0],r=f(n.x),s=f(n.y),a=r+f(i.x),o=s+f(i.y);this.moveToPosition(a,o,e)}updatePosition(t){this.speed;const{x:e,y:i}=this.getTargetPosition();this.moveToPosition(e,i,t),this.hasReachedTarget()&&(this.setPosition(e,i),this.updateOccupiedGrids(),this.setCharacterState(0),this.setIsActing(!1))}moveToPosition(t,e,n){this.movingProgressRemaining=i.Math.Distance.Between(this.x,this.y,t,e);const r=this.speed*(n/1e3);this.x=i.Math.Linear(this.x,t,r),this.y=i.Math.Linear(this.y,e,r),this.setCharacterState(1),this.setIsActing(!0)}getTargetPosition(){const{x:t,y:e}=this.calculateCenterPosition(this.targetGrids),i=this.targetGrids[0],n=f(i.x),r=f(i.y);return{x:n+f(t),y:r+f(e)}}handleInput(t,e){if(!this.isActing&&0===this.currentState)switch(t){case"up":this.moveUp(e);break;case"down":this.moveDown(e);break;case"left":this.moveLeft(e);break;case"right":this.moveRight(e)}}moveUp(t){this.setCharacterState(1,{direction:"up"});const e=v(this.getOccupiedGrids(),"up");console.log("Occupied Grids: ",this.occupiedGrids,"Next grid: ",e),this.moveToGrid(e,t)}moveDown(t){this.setCharacterState(1,{direction:"down"});const e=v(this.getOccupiedGrids(),"down");console.log("Occupied Grids: ",this.occupiedGrids,"Next grid: ",e),this.moveToGrid(e,t)}moveLeft(t){this.setCharacterState(1,{direction:"left"});const e=v(this.getOccupiedGrids(),"left");this.moveToGrid(e,t)}moveRight(t){this.setCharacterState(1,{direction:"right"});const e=v(this.getOccupiedGrids(),"right");this.moveToGrid(e,t)}stopMoving(){this.setCharacterState(0),this.setIsActing(!1)}attack(){this.setCharacterState(2)}onAnimationComplete(t){"attack"===t.key&&(this.animationStateComplete=!0,console.log("Attack animation complete!"),this.setCharacterState(0))}calculateCenterPosition(t){if(!t||0===t.length)return console.error("Grids array is empty or undefined."),{x:0,y:0};const e=t[0],i=y(e.x),n=y(e.y),r=i+this.width*this.scaleX/2,s=n+this.height*this.scaleY/2;return{x:y(r),y:y(s)}}hasReachedTarget(){return this.movingProgressRemaining<=1}}class P{constructor(t,i=16){e(this,"scene"),e(this,"cellSize"),e(this,"graphics"),e(this,"visible"),this.scene=t,this.cellSize=i,this.graphics=t.add.graphics(),this.visible=!0,this.draw(),this.scene.cameras.main.on("cameramove",this.updateGrid,this)}draw(){this.graphics.clear();const t=this.scene.physics.world.bounds;this.graphics.lineStyle(1,16777215,.5);const e=t.left,i=t.top,n=t.right,r=t.bottom;for(let s=e;s<=n;s+=this.cellSize)this.graphics.moveTo(s,i),this.graphics.lineTo(s,r);for(let s=i;s<=r;s+=this.cellSize)this.graphics.moveTo(e,s),this.graphics.lineTo(n,s);this.graphics.strokePath()}getNextPosition(t,e,i){let n=Math.floor(t/this.cellSize),r=Math.floor(e/this.cellSize);switch(i){case"up":r-=1;break;case"down":r+=1;break;case"left":n-=1;break;case"right":n+=1}return{x:n,y:r}}toggle(){this.visible=!this.visible,this.graphics.setVisible(this.visible)}show(){this.visible=!0,this.graphics.setVisible(!0)}hide(){this.visible=!1,this.graphics.setVisible(!1)}updateGrid(){this.visible&&this.draw()}destroy(){this.scene.cameras.main.off("cameramove",this.updateGrid,this),this.graphics.destroy()}getCellSize(){return this.cellSize}}class k{constructor(t,i){e(this,"scene"),e(this,"config"),e(this,"element"),e(this,"currentTextIndex"),e(this,"isRevealing"),e(this,"accumulatedText"),e(this,"characterLimit"),e(this,"onComplete"),this.scene=t,this.currentTextIndex=0,this.isRevealing=!1,this.element=null,this.accumulatedText="WELCOME TO SHADOWTIDE ISLAND.... almost!",this.characterLimit=300,this.config={...i,style:{fontSize:"48px",backgroundColor:"rgb(209, 172, 104)",textColor:"rgb(24, 20, 12)",padding:"2rem",borderRadius:"1rem",fontFamily:"Garamond, serif",transition:"all 1s ease-in-out",border:"1rem solid rgba(24, 20, 12, 0.5)",fontWeight:"bold",marginBottom:"2rem",height:"200px",overflow:"hidden",...i.style||{}},revealSpeed:i.revealSpeed||30}}create(){var t,e,i,n,r,s,a,o,l,h,u;const{width:c,height:d}=this.scene.cameras.main,p=`\n      background-color: ${null==(t=this.config.style)?void 0:t.backgroundColor}; \n      color: ${null==(e=this.config.style)?void 0:e.textColor}; \n      padding: ${null==(i=this.config.style)?void 0:i.padding}; \n      border-radius: ${null==(n=this.config.style)?void 0:n.borderRadius}; \n      font: ${null==(r=this.config.style)?void 0:r.fontWeight} ${null==(s=this.config.style)?void 0:s.fontSize} ${null==(a=this.config.style)?void 0:a.fontFamily}; \n      border: ${null==(o=this.config.style)?void 0:o.border}; \n      transition: ${null==(l=this.config.style)?void 0:l.transition};\n      width: 80%; \n      height: ${null==(h=this.config.style)?void 0:h.height}; \n      overflow: ${null==(u=this.config.style)?void 0:u.overflow};\n    `;this.element=this.scene.add.dom(c/2,d-150,"div",p,this.accumulatedText),this.element.setScrollFactor(0),this.element.addListener("click"),this.element.on("click",(()=>this.nextText())),this.scene.input.keyboard&&this.scene.input.keyboard.on("keydown-ENTER",(()=>this.nextText())),this.scene.events.emit("storyBoxTextStart",this.currentTextIndex)}nextText(){if(this.isRevealing)this.revealFullText();else if(this.currentTextIndex<this.config.texts.length){const t=this.getNextTextChunk(this.config.texts[this.currentTextIndex]);this.clearContent(),this.accumulatedText=t,this.revealText(this.accumulatedText),t.length<this.characterLimit&&this.currentTextIndex++}else this.destroy(),this.config.onComplete&&this.config.onComplete(),this.scene.events.emit("storyBoxComplete")}getNextTextChunk(t){if(t.length<=this.characterLimit)return t;{const e=this.findSuitableBreakPoint(t,this.characterLimit),i=t.slice(0,e),n=t.slice(e).trim();return this.config.texts[this.currentTextIndex]=`...${n}`,`${i}...`}}findSuitableBreakPoint(t,e){const i=[".","!","?",","," "];let n=t.lastIndexOf(" ",e);-1===n&&(n=e);for(const r of i){const i=t.lastIndexOf(r,e);i>n&&(n=i)}return n+1}revealText(t){if(this.element){this.isRevealing=!0;let e="";const i=setInterval((()=>{var n;e.length<t.length?(e+=t[e.length],null==(n=this.element)||n.setHTML(e)):(clearInterval(i),this.isRevealing=!1,this.scene.events.emit("storyBoxTextComplete",this.currentTextIndex))}),this.config.revealSpeed)}}revealFullText(){this.element&&(this.element.setHTML(this.accumulatedText),this.isRevealing=!1,this.scene.events.emit("storyBoxTextComplete",this.currentTextIndex))}clearContent(){this.element&&this.element.setHTML("")}destroy(){this.element&&(this.element.removeListener("click"),this.element.destroy()),this.scene.input.keyboard&&this.scene.input.keyboard.off("keydown-ENTER")}update(){if(this.element){const{width:t,height:e}=this.scene.cameras.main;this.element.x=t/2,this.element.y=e-150}}}class A{constructor(){e(this,"heldDirections",[]),e(this,"map",{KeyW:"up",KeyS:"down",KeyA:"left",KeyD:"right"})}get direction(){return this.heldDirections[0]}init(){document.addEventListener("keydown",(t=>{const e=this.map[t.code];e&&-1===this.heldDirections.indexOf(e)&&(this.heldDirections.unshift(e),console.log(this.heldDirections))})),document.addEventListener("keyup",(t=>{const e=this.map[t.code],i=this.heldDirections.indexOf(e);i>-1&&(this.heldDirections.splice(i,1),console.log(this.heldDirections))}))}}class N{constructor(t,i,n){e(this,"scene"),e(this,"collisionLayer"),e(this,"gridSize"),this.scene=t,this.collisionLayer=i,this.gridSize=n.getCellSize()}isPositionFree(t){return!t.some((t=>{const e=t.x*this.gridSize,i=t.y*this.gridSize,n=this.collisionLayer.getTileAtWorldXY(e,i);return n&&n.properties.collides}))}}class I{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof I.Component&&arguments[1]instanceof I){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let t=this._components.slice(1,this._components.length);return new I(t)}return I.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let t=new I;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(t){let e=new I,i=0;for(let n=0;n<t._components.length&&t._components[n].isParent;++n)i++;for(let n=0;n<this._components.length-i;++n)e._components.push(this._components[n]);for(let n=i;n<t._components.length;++n)e._components.push(t._components[n]);return e}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,null==this._componentsString||""==this._componentsString)return;"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let e=this._componentsString.split(".");for(let i of e)/^(\-|\+)?([0-9]+|Infinity)$/.test(i)?this._components.push(new I.Component(parseInt(i))):this._components.push(new I.Component(i))}toString(){return this.componentsString}Equals(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(let e=0,i=t._components.length;e<i;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(t){let e=new I;return e._components.push(...this._components),e._components.push(t),e}}function F(t,e){return t instanceof e?R(t):null}function W(t,e){if(t instanceof e)return R(t);throw new Error(`${t} is not of type ${e}`)}function V(t){return t.hasValidName&&t.name?t:null}function L(t){return void 0===t?null:t}function D(t){return"object"==typeof t&&"function"==typeof t.Equals}function R(t,e){return t}I.parentId="^",function(t){class e{constructor(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}get isIndex(){return this.index>=0}get isParent(){return this.name==t.parentId}static ToParent(){return new e(t.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}t.Component=e}(I||(I={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}t.AssertType=function(t,i,n){e(t instanceof i,n)},t.Assert=e}(b||(b={}));class j extends Error{}function G(t){throw new j(`${t} is null or undefined`)}class B{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(null===t)return null;let e=this.rootContentContainer;if(e){let i=e.ContentAtPath(t).obj;if(i){let t=i.debugMetadata;if(null!==t)return t.startLineNumber}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new I;else{let t=[],e=this,i=F(e.parent,nt);for(;null!==i;){let n=V(e);if(null!=n&&n.hasValidName){if(null===n.name)return G("namedChild.name");t.unshift(new I.Component(n.name))}else t.unshift(new I.Component(i.content.indexOf(e)));e=i,i=F(i.parent,nt)}this._path=new I(t)}return this._path}ResolvePath(t){if(null===t)return G("path");if(t.isRelative){let e=F(this,nt);return null===e&&(b.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=F(this.parent,nt),b.Assert(null!==e,"Expected parent to be a container"),b.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?G("nearestContainer"):e.ContentAtPath(t)}{let e=this.rootContentContainer;return null===e?G("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(t){let e=this.path,i=Math.min(t.length,e.length),n=-1;for(let a=0;a<i;++a){let i=e.GetComponent(a),r=t.GetComponent(a);if(!i.Equals(r))break;n=a}if(-1==n)return t;let r=e.componentCount-1-n,s=[];for(let a=0;a<r;++a)s.push(I.Component.ToParent());for(let a=n+1;a<t.componentCount;++a)s.push(t.GetComponent(a));return new I(s,!0)}CompactPathString(t){let e=null,i=null;return t.isRelative?(i=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(i=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),i.length<e.length?i:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return F(t,nt)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,i){t[e]&&(t[e]=null),t[e]=i,t[e]&&(t[e].parent=this)}Equals(t){return t===this}}class M{constructor(t){t=void 0!==t?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){null!==t&&(this.string+=t)}AppendLine(t){void 0!==t&&this.Append(t),this.string+="\n"}AppendFormat(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];this.string+=t.replace(/{(\d+)}/g,((t,e)=>void 0!==i[e]?i[e]:t))}toString(){return this.string}Clear(){this.string=""}}class z{constructor(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new z(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof z){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new z(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!z.isLikeInkListItem(e))return z.Null;let i=e;return new z(i.originName,i.itemName)}static isLikeInkListItem(t){return!("object"!=typeof t||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}}class K extends Map{constructor(){if(super(arguments[0]instanceof K?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof K){let t=arguments[0],e=t.originNames;null!==e&&(this._originNames=e.slice()),null!==t.origins&&(this.origins=t.origins.slice())}else if("string"==typeof arguments[0]){let t=arguments[0],e=arguments[1];if(this.SetInitialOriginName(t),null===e.listDefinitions)return G("originStory.listDefinitions");let i=e.listDefinitions.TryListGetDefinition(t,null);if(!i.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);if(null===i.result)return G("def.result");this.origins=[i.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}static FromString(t,e){var i;if(null==t||""==t)return new K;let n=null===(i=e.listDefinitions)||void 0===i?void 0:i.FindSingleItemListWithName(t);if(n)return null===n.value?G("listValue.value"):new K(n.value);throw new Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}AddItem(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(t instanceof z){let e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return G("this.origins");for(let t of this.origins)if(t.name==e.originName){let i=t.TryGetValueForItem(e,0);if(i.exists)return void this.Add(e,i.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}if(null!==t){let i=t,n=null;if(null===this.origins)return G("this.origins");for(let t of this.origins){if(null===i)return G("itemName");if(t.ContainsItemWithName(i)){if(null!=n)throw new Error("Could not add the item "+i+" to this list because it could come from either "+t.name+" or "+n.name);n=t}}if(null==n){if(null==e)throw new Error("Could not add the item "+i+" to this list because it isn't known to any list definitions previously associated with this list.");{let t=K.FromString(i,e).orderedItems[0];this.Add(t.Key,t.Value)}}else{let t=new z(n.name,i),e=n.ValueForItem(t);this.Add(t,e)}}}ContainsItemNamed(t){for(let[e]of this)if(z.fromSerializedKey(e).itemName==t)return!0;return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let i=t.serialized();if(this.has(i))throw new Error(`The Map already contains an entry for ${t}`);this.set(i,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every((i=>i.name!=t||(e=i,!1))),e}get originNames(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=z.fromSerializedKey(t);if(null===e.originName)return G("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=null==t?null:t.slice()}get maxItem(){let t={Key:z.Null,Value:0};for(let[e,i]of this){let n=z.fromSerializedKey(e);(t.Key.isNull||i>t.Value)&&(t={Key:n,Value:i})}return t}get minItem(){let t={Key:z.Null,Value:0};for(let[e,i]of this){let n=z.fromSerializedKey(e);(t.Key.isNull||i<t.Value)&&(t={Key:n,Value:i})}return t}get inverse(){let t=new K;if(null!=this.origins)for(let e of this.origins)for(let[i,n]of e.items){let e=z.fromSerializedKey(i);this.ContainsKey(e)||t.Add(e,n)}return t}get all(){let t=new K;if(null!=this.origins)for(let e of this.origins)for(let[i,n]of e.items){let e=z.fromSerializedKey(i);t.set(e.serialized(),n)}return t}Union(t){let e=new K(this);for(let[i,n]of t)e.set(i,n);return e}Intersect(t){let e=new K;for(let[i,n]of this)t.has(i)&&e.set(i,n);return e}HasIntersection(t){for(let[e]of this)if(t.has(e))return!0;return!1}Without(t){let e=new K(this);for(let[i]of t)e.delete(i);return e}Contains(t){if("string"==typeof t)return this.ContainsItemNamed(t);const e=t;if(0==e.size||0==this.size)return!1;for(let[i]of e)if(!this.has(i))return!1;return!0}GreaterThan(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new K(this.maxItem):new K}MinAsList(){return this.Count>0?new K(this.minItem):new K}ListWithSubRange(t,e){if(0==this.Count)return new K;let i=this.orderedItems,n=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?n=t:t instanceof K&&t.Count>0&&(n=t.minItem.Value),Number.isInteger(e)?r=e:e instanceof K&&e.Count>0&&(r=e.maxItem.Value);let s=new K;s.SetInitialOriginNames(this.originNames);for(let a of i)a.Value>=n&&a.Value<=r&&s.Add(a.Key,a.Value);return s}Equals(t){if(t instanceof K==0)return!1;if(t.Count!=this.Count)return!1;for(let[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,i]of this){let n=z.fromSerializedKey(e);t.push({Key:n,Value:i})}return t.sort(((t,e)=>null===t.Key.originName?G("x.Key.originName"):null===e.Key.originName?G("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0)),t}get singleItem(){for(let t of this.orderedItems)return t.Key;return null}toString(){let t=this.orderedItems,e=new M;for(let i=0;i<t.length;i++){i>0&&e.Append(", ");let n=t[i].Key;if(null===n.itemName)return G("item.itemName");e.Append(n.itemName)}return e.toString()}valueOf(){return NaN}}class U extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}function J(t,e,i){if(null===t)return{result:i,exists:!1};let n=t.get(e);return void 0===n?{result:i,exists:!1}:{result:n,exists:!0}}class q extends B{static Create(t,e){if(e){if(e===w.Int&&Number.isInteger(Number(t)))return new X(Number(t));if(e===w.Float&&!isNaN(t))return new Y(Number(t))}return"boolean"==typeof t?new $(Boolean(t)):"string"==typeof t?new Q(String(t)):Number.isInteger(Number(t))?new X(Number(t)):isNaN(t)?t instanceof I?new Z(W(t,I)):t instanceof K?new et(W(t,K)):null:new Y(Number(t))}Copy(){return W(q.Create(this.valueObject),B)}BadCastException(t){return new U("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}class H extends q{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return null===this.value?G("Value.value"):this.value.toString()}}class $ extends H{constructor(t){super(t||!1)}get isTruthy(){return Boolean(this.value)}get valueType(){return w.Bool}Cast(t){if(null===this.value)return G("Value.value");if(t==this.valueType)return this;if(t==w.Int)return new X(this.value?1:0);if(t==w.Float)return new Y(this.value?1:0);if(t==w.String)return new Q(this.value?"true":"false");throw this.BadCastException(t)}toString(){return this.value?"true":"false"}}class X extends H{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return w.Int}Cast(t){if(null===this.value)return G("Value.value");if(t==this.valueType)return this;if(t==w.Bool)return new $(0!==this.value);if(t==w.Float)return new Y(this.value);if(t==w.String)return new Q(""+this.value);throw this.BadCastException(t)}}class Y extends H{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return w.Float}Cast(t){if(null===this.value)return G("Value.value");if(t==this.valueType)return this;if(t==w.Bool)return new $(0!==this.value);if(t==w.Int)return new X(this.value);if(t==w.String)return new Q(""+this.value);throw this.BadCastException(t)}}class Q extends H{constructor(t){if(super(t||""),this._isNewline="\n"==this.value,this._isInlineWhitespace=!0,null===this.value)return G("Value.value");this.value.length>0&&this.value.split("").every((t=>" "==t||"\t"==t||(this._isInlineWhitespace=!1,!1)))}get valueType(){return w.String}get isTruthy(){return null===this.value?G("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==w.Int){let e=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=parseInt(t);return Number.isNaN(i)?{result:e,exists:!1}:{result:i,exists:!0}}(this.value);if(e.exists)return new X(e.result);throw this.BadCastException(t)}if(t==w.Float){let e=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=parseFloat(t);return Number.isNaN(i)?{result:e,exists:!1}:{result:i,exists:!0}}(this.value);if(e.exists)return new Y(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}class Z extends H{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:null)}get valueType(){return w.DivertTarget}get targetPath(){return null===this.value?G("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class tt extends H{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return null===this.value?G("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return w.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new tt(this.variableName,this.contextIndex)}}class et extends H{get isTruthy(){return null===this.value?G("this.value"):this.value.Count>0}get valueType(){return w.List}Cast(t){if(null===this.value)return G("Value.value");if(t==w.Int){let t=this.value.maxItem;return t.Key.isNull?new X(0):new X(t.Value)}if(t==w.Float){let t=this.value.maxItem;return t.Key.isNull?new Y(0):new Y(t.Value)}if(t==w.String){let t=this.value.maxItem;return t.Key.isNull?new Q(""):new Q(t.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof K?this.value=new K(t):t instanceof z&&"number"==typeof e&&(this.value=new K({Key:t,Value:e})):this.value=new K}static RetainListOriginsForAssignment(t,e){let i=F(t,et),n=F(e,et);return n&&null===n.value?G("newList.value"):i&&null===i.value?G("oldList.value"):void(i&&n&&0==n.value.Count&&n.value.SetInitialOriginNames(i.value.originNames))}}(E=w||(w={}))[E.Bool=-1]="Bool",E[E.Int=0]="Int",E[E.Float=1]="Float",E[E.List=2]="List",E[E.String=3]="String",E[E.DivertTarget=4]="DivertTarget",E[E.VariablePointer=5]="VariablePointer";class it{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof nt?this.obj:null}copy(){let t=new it;return t.obj=this.obj,t.approximate=this.approximate,t}}class nt extends B{constructor(){super(...arguments),this.name=null,this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,i]of this.namedContent){let n=W(i,B);t.set(e,n)}for(let e of this.content){let i=V(e);null!=i&&i.hasValidName&&t.delete(i.name)}return 0==t.size&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(null!=e)for(let[i]of e)this.namedContent.delete(i);if(null!=t)for(let[,i]of t){let t=V(i);null!=t&&this.AddToNamedContentOnly(t)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=nt.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=nt.CountFlags.Turns),this.countingAtStartOnly&&(t|=nt.CountFlags.CountStartOnly),t==nt.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&nt.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&nt.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&nt.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],e=this;for(;e instanceof nt;)e.content.length>0&&(t.push(new I.Component(0)),e=e.content[0]);return new I(t)}AddContent(t){if(t instanceof Array){let e=t;for(let t of e)this.AddContent(t)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=V(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){if(b.AssertType(t,B,"Can only add Runtime.Objects to a Runtime.Container"),W(t,B).parent=this,null===t.name)return G("namedContentObj.name");this.namedContent.set(t.name,t)}ContentAtPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;-1==i&&(i=t.length);let n=new it;n.approximate=!1;let r=this,s=this;for(let a=e;a<i;++a){let e=t.GetComponent(a);if(null==r){n.approximate=!0;break}let o=r.ContentWithPathComponent(e);if(null==o){n.approximate=!0;break}const l=F(o,nt);if(a<i-1&&null==l){n.approximate=!0;break}s=o,r=l}return n.obj=s,n}InsertContent(t,e){if(this.content.splice(e,0,t),t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content.push(...t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(null===t.name)return G("component.name");let e=J(this.namedContent,t.name,null);return e.exists?W(e.result,B):null}}BuildStringOfHierarchy(){let t;if(0==arguments.length)return t=new M,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let e=arguments[1],i=arguments[2];function n(){for(let i=0;i<4*e;++i)t.Append(" ")}n(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==i&&t.Append("  <---"),t.AppendLine(),e++;for(let s=0;s<this.content.length;++s){let r=this.content[s];r instanceof nt?r.BuildStringOfHierarchy(t,e,i):(n(),r instanceof Q?(t.Append('"'),t.Append(r.toString().replace("\n","\\n")),t.Append('"')):t.Append(r.toString())),s!=this.content.length-1&&t.Append(","),r instanceof nt||r!=i||t.Append("  <---"),t.AppendLine()}let r=new Map;for(let[s,a]of this.namedContent)this.content.indexOf(W(a,B))>=0||r.set(s,a);if(r.size>0){n(),t.AppendLine("-- named: --");for(let[,n]of r)b.AssertType(n,nt,"Can only print out named Containers"),n.BuildStringOfHierarchy(t,e,i),t.AppendLine()}e--,n(),t.Append("]")}}!function(t){var e;(e=t.CountFlags||(t.CountFlags={}))[e.Start=0]="Start",e[e.Visits=1]="Visits",e[e.Turns=2]="Turns",e[e.CountStartOnly=4]="CountStartOnly"}(nt||(nt={}));class rt extends B{toString(){return"Glue"}}class st extends B{get commandType(){return this._commandType}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:st.CommandType.NotSet;super(),this._commandType=t}Copy(){return new st(this.commandType)}static EvalStart(){return new st(st.CommandType.EvalStart)}static EvalOutput(){return new st(st.CommandType.EvalOutput)}static EvalEnd(){return new st(st.CommandType.EvalEnd)}static Duplicate(){return new st(st.CommandType.Duplicate)}static PopEvaluatedValue(){return new st(st.CommandType.PopEvaluatedValue)}static PopFunction(){return new st(st.CommandType.PopFunction)}static PopTunnel(){return new st(st.CommandType.PopTunnel)}static BeginString(){return new st(st.CommandType.BeginString)}static EndString(){return new st(st.CommandType.EndString)}static NoOp(){return new st(st.CommandType.NoOp)}static ChoiceCount(){return new st(st.CommandType.ChoiceCount)}static Turns(){return new st(st.CommandType.Turns)}static TurnsSince(){return new st(st.CommandType.TurnsSince)}static ReadCount(){return new st(st.CommandType.ReadCount)}static Random(){return new st(st.CommandType.Random)}static SeedRandom(){return new st(st.CommandType.SeedRandom)}static VisitIndex(){return new st(st.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new st(st.CommandType.SequenceShuffleIndex)}static StartThread(){return new st(st.CommandType.StartThread)}static Done(){return new st(st.CommandType.Done)}static End(){return new st(st.CommandType.End)}static ListFromInt(){return new st(st.CommandType.ListFromInt)}static ListRange(){return new st(st.CommandType.ListRange)}static ListRandom(){return new st(st.CommandType.ListRandom)}static BeginTag(){return new st(st.CommandType.BeginTag)}static EndTag(){return new st(st.CommandType.EndTag)}toString(){return"ControlCommand "+this.commandType.toString()}}!function(t){var e;(e=t.CommandType||(t.CommandType={}))[e.NotSet=-1]="NotSet",e[e.EvalStart=0]="EvalStart",e[e.EvalOutput=1]="EvalOutput",e[e.EvalEnd=2]="EvalEnd",e[e.Duplicate=3]="Duplicate",e[e.PopEvaluatedValue=4]="PopEvaluatedValue",e[e.PopFunction=5]="PopFunction",e[e.PopTunnel=6]="PopTunnel",e[e.BeginString=7]="BeginString",e[e.EndString=8]="EndString",e[e.NoOp=9]="NoOp",e[e.ChoiceCount=10]="ChoiceCount",e[e.Turns=11]="Turns",e[e.TurnsSince=12]="TurnsSince",e[e.ReadCount=13]="ReadCount",e[e.Random=14]="Random",e[e.SeedRandom=15]="SeedRandom",e[e.VisitIndex=16]="VisitIndex",e[e.SequenceShuffleIndex=17]="SequenceShuffleIndex",e[e.StartThread=18]="StartThread",e[e.Done=19]="Done",e[e.End=20]="End",e[e.ListFromInt=21]="ListFromInt",e[e.ListRange=22]="ListRange",e[e.ListRandom=23]="ListRandom",e[e.BeginTag=24]="BeginTag",e[e.EndTag=25]="EndTag",e[e.TOTAL_VALUES=26]="TOTAL_VALUES"}(st||(st={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(_||(_={}));class at{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new I.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new at(this.container,this.index)}static StartOf(t){return new at(t,0)}static get Null(){return new at(null,-1)}}class ot extends B{get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=at.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return G("this._targetPath");if(null===this._targetPath.lastComponent)return G("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return G("targetObj");this._targetPointer.container=t.parent instanceof nt?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=at.StartOf(t instanceof nt?t:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=null==t?null:new I(t)}get hasVariableTarget(){return null!=this.variableDivertName}constructor(t){super(),this._targetPath=null,this._targetPointer=at.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,void 0!==t&&(this.pushesToStack=!0,this.stackPushType=t)}Equals(t){let e=t;return e instanceof ot&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:null===this.targetPath?G("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";{let t=new M,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==_.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}}class lt extends B{constructor(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return null===this._pathOnChoice?G("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?G("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new I(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){return null===this.pathOnChoice?G("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}class ht extends B{get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=null===t?null:new I(t)}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;super(),this.pathForCount=null,this.name=t}toString(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}class ut extends B{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}class ct extends B{toString(){return"Void"}}class dt extends B{static CallWithName(t){return new dt(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return null===this._name?G("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(null===dt._nativeFunctions?G("NativeFunctionCall._nativeFunctions"):this._prototype=dt._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let r of t){if(r instanceof ct)throw new U("Attempting to perform "+this.name+' on a void value. Did you forget to "return" a value from a function you called here?');r instanceof et&&(e=!0)}if(2==t.length&&e)return this.CallBinaryListOperation(t);let i=this.CoerceValuesToSingleType(t),n=i[0].valueType;return n==w.Int||n==w.Float||n==w.String||n==w.DivertTarget||n==w.List?this.CallType(i):null}CallType(t){let e=W(t[0],H),i=e.valueType,n=e,r=t.length;if(2==r||1==r){if(null===this._operationFuncs)return G("NativeFunctionCall._operationFuncs");let s=this._operationFuncs.get(i);if(!s){const t=w[i];throw new U("Cannot perform operation "+this.name+" on "+t)}if(2==r){let e=W(t[1],H),i=s;if(null===n.value||null===e.value)return G("NativeFunctionCall.Call BinaryOp values");let r=i(n.value,e.value);return H.Create(r)}{let t=s;if(null===n.value)return G("NativeFunctionCall.Call UnaryOp value");let i=t(n.value);return this.name===dt.Int?H.Create(i,w.Int):this.name===dt.Float?H.Create(i,w.Float):H.Create(i,e.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof et&&t[1]instanceof X)return this.CallListIncrementOperation(t);let e=W(t[0],H),i=W(t[1],H);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==w.List&&i.valueType==w.List)){if(null===this._operationFuncs)return G("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(w.Int);if(null===t)return G("NativeFunctionCall.CallBinaryListOperation op");let n=function(t){if("boolean"==typeof t)return t;throw new Error(`${t} is not a boolean`)}(t(e.isTruthy?1:0,i.isTruthy?1:0));return new $(n)}if(e.valueType==w.List&&i.valueType==w.List)return this.CallType([e,i]);throw new U("Can not call use "+this.name+" operation on "+w[e.valueType]+" and "+w[i.valueType])}CallListIncrementOperation(t){let e=W(t[0],et),i=W(t[1],X),n=new K;if(null===e.value)return G("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[r,s]of e.value){let t=z.fromSerializedKey(r);if(null===this._operationFuncs)return G("NativeFunctionCall._operationFuncs");let a=this._operationFuncs.get(w.Int);if(null===i.value)return G("NativeFunctionCall.CallListIncrementOperation intVal.value");let o=a(s,i.value),l=null;if(null===e.value.origins)return G("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let i of e.value.origins)if(i.name==t.originName){l=i;break}if(null!=l){let t=l.TryGetItemWithValue(o,z.Null);t.exists&&n.Add(t.result,o)}}return new et(n)}CoerceValuesToSingleType(t){let e=w.Int,i=null;for(let r of t){let t=W(r,H);t.valueType>e&&(e=t.valueType),t.valueType==w.List&&(i=F(t,et))}let n=[];if(w[e]==w[w.List])for(let r of t){let t=W(r,H);if(t.valueType==w.List)n.push(t);else{if(t.valueType!=w.Int){const e=w[t.valueType];throw new U("Cannot mix Lists and "+e+" values in this operation")}{let e=parseInt(t.valueObject);if(i=W(i,et),null===i.value)return G("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let r=i.value.originOfMaxItem;if(null===r)return G("NativeFunctionCall.CoerceValuesToSingleType list");let s=r.TryGetItemWithValue(e,z.Null);if(!s.exists)throw new U("Could not find List item with the value "+e+" in "+r.name);{let t=new et(s.result,e);n.push(t)}}}}else for(let r of t){let t=W(r,H).Cast(e);n.push(t)}return n}constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)dt.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){let t=arguments[0];dt.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(2===arguments.length){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,((t,e)=>t+e)),this.AddIntBinaryOp(this.Subtract,((t,e)=>t-e)),this.AddIntBinaryOp(this.Multiply,((t,e)=>t*e)),this.AddIntBinaryOp(this.Divide,((t,e)=>Math.floor(t/e))),this.AddIntBinaryOp(this.Mod,((t,e)=>t%e)),this.AddIntUnaryOp(this.Negate,(t=>-t)),this.AddIntBinaryOp(this.Equal,((t,e)=>t==e)),this.AddIntBinaryOp(this.Greater,((t,e)=>t>e)),this.AddIntBinaryOp(this.Less,((t,e)=>t<e)),this.AddIntBinaryOp(this.GreaterThanOrEquals,((t,e)=>t>=e)),this.AddIntBinaryOp(this.LessThanOrEquals,((t,e)=>t<=e)),this.AddIntBinaryOp(this.NotEquals,((t,e)=>t!=e)),this.AddIntUnaryOp(this.Not,(t=>0==t)),this.AddIntBinaryOp(this.And,((t,e)=>0!=t&&0!=e)),this.AddIntBinaryOp(this.Or,((t,e)=>0!=t||0!=e)),this.AddIntBinaryOp(this.Max,((t,e)=>Math.max(t,e))),this.AddIntBinaryOp(this.Min,((t,e)=>Math.min(t,e))),this.AddIntBinaryOp(this.Pow,((t,e)=>Math.pow(t,e))),this.AddIntUnaryOp(this.Floor,dt.Identity),this.AddIntUnaryOp(this.Ceiling,dt.Identity),this.AddIntUnaryOp(this.Int,dt.Identity),this.AddIntUnaryOp(this.Float,(t=>t)),this.AddFloatBinaryOp(this.Add,((t,e)=>t+e)),this.AddFloatBinaryOp(this.Subtract,((t,e)=>t-e)),this.AddFloatBinaryOp(this.Multiply,((t,e)=>t*e)),this.AddFloatBinaryOp(this.Divide,((t,e)=>t/e)),this.AddFloatBinaryOp(this.Mod,((t,e)=>t%e)),this.AddFloatUnaryOp(this.Negate,(t=>-t)),this.AddFloatBinaryOp(this.Equal,((t,e)=>t==e)),this.AddFloatBinaryOp(this.Greater,((t,e)=>t>e)),this.AddFloatBinaryOp(this.Less,((t,e)=>t<e)),this.AddFloatBinaryOp(this.GreaterThanOrEquals,((t,e)=>t>=e)),this.AddFloatBinaryOp(this.LessThanOrEquals,((t,e)=>t<=e)),this.AddFloatBinaryOp(this.NotEquals,((t,e)=>t!=e)),this.AddFloatUnaryOp(this.Not,(t=>0==t)),this.AddFloatBinaryOp(this.And,((t,e)=>0!=t&&0!=e)),this.AddFloatBinaryOp(this.Or,((t,e)=>0!=t||0!=e)),this.AddFloatBinaryOp(this.Max,((t,e)=>Math.max(t,e))),this.AddFloatBinaryOp(this.Min,((t,e)=>Math.min(t,e))),this.AddFloatBinaryOp(this.Pow,((t,e)=>Math.pow(t,e))),this.AddFloatUnaryOp(this.Floor,(t=>Math.floor(t))),this.AddFloatUnaryOp(this.Ceiling,(t=>Math.ceil(t))),this.AddFloatUnaryOp(this.Int,(t=>Math.floor(t))),this.AddFloatUnaryOp(this.Float,dt.Identity),this.AddStringBinaryOp(this.Add,((t,e)=>t+e)),this.AddStringBinaryOp(this.Equal,((t,e)=>t===e)),this.AddStringBinaryOp(this.NotEquals,((t,e)=>!(t===e))),this.AddStringBinaryOp(this.Has,((t,e)=>t.includes(e))),this.AddStringBinaryOp(this.Hasnt,((t,e)=>!t.includes(e))),this.AddListBinaryOp(this.Add,((t,e)=>t.Union(e))),this.AddListBinaryOp(this.Subtract,((t,e)=>t.Without(e))),this.AddListBinaryOp(this.Has,((t,e)=>t.Contains(e))),this.AddListBinaryOp(this.Hasnt,((t,e)=>!t.Contains(e))),this.AddListBinaryOp(this.Intersect,((t,e)=>t.Intersect(e))),this.AddListBinaryOp(this.Equal,((t,e)=>t.Equals(e))),this.AddListBinaryOp(this.Greater,((t,e)=>t.GreaterThan(e))),this.AddListBinaryOp(this.Less,((t,e)=>t.LessThan(e))),this.AddListBinaryOp(this.GreaterThanOrEquals,((t,e)=>t.GreaterThanOrEquals(e))),this.AddListBinaryOp(this.LessThanOrEquals,((t,e)=>t.LessThanOrEquals(e))),this.AddListBinaryOp(this.NotEquals,((t,e)=>!t.Equals(e))),this.AddListBinaryOp(this.And,((t,e)=>t.Count>0&&e.Count>0)),this.AddListBinaryOp(this.Or,((t,e)=>t.Count>0||e.Count>0)),this.AddListUnaryOp(this.Not,(t=>0==t.Count?1:0)),this.AddListUnaryOp(this.Invert,(t=>t.inverse)),this.AddListUnaryOp(this.All,(t=>t.all)),this.AddListUnaryOp(this.ListMin,(t=>t.MinAsList())),this.AddListUnaryOp(this.ListMax,(t=>t.MaxAsList())),this.AddListUnaryOp(this.Count,(t=>t.Count)),this.AddListUnaryOp(this.ValueOfList,(t=>t.maxItem.Value));let t=(t,e)=>t.Equals(e),e=(t,e)=>!t.Equals(e);this.AddOpToNativeFunc(this.Equal,2,w.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,w.DivertTarget,e)}}AddOpFuncForType(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,i,n){if(null===this._nativeFunctions)return G("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new dt(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(i,n)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,w.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,w.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,w.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,w.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,w.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,w.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,w.List,e)}toString(){return'Native "'+this.name+'"'}}dt.Add="+",dt.Subtract="-",dt.Divide="/",dt.Multiply="*",dt.Mod="%",dt.Negate="_",dt.Equal="==",dt.Greater=">",dt.Less="<",dt.GreaterThanOrEquals=">=",dt.LessThanOrEquals="<=",dt.NotEquals="!=",dt.Not="!",dt.And="&&",dt.Or="||",dt.Min="MIN",dt.Max="MAX",dt.Pow="POW",dt.Floor="FLOOR",dt.Ceiling="CEILING",dt.Int="INT",dt.Float="FLOAT",dt.Has="?",dt.Hasnt="!?",dt.Intersect="^",dt.ListMin="LIST_MIN",dt.ListMax="LIST_MAX",dt.All="LIST_ALL",dt.Count="LIST_COUNT",dt.ValueOfList="LIST_VALUE",dt.Invert="LIST_INVERT",dt._nativeFunctions=null;class pt extends B{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}}class mt extends B{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.tags=null,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?G("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(t){this.targetPath=new I(t)}Clone(){let t=new mt;return t.text=this.text,t.sourcePath=this.sourcePath,t.index=this.index,t.targetPath=this.targetPath,t.originalThreadIndex=this.originalThreadIndex,t.isInvisibleDefault=this.isInvisibleDefault,null!==this.threadAtGeneration&&(t.threadAtGeneration=this.threadAtGeneration.Copy()),t}}class gt{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(let[t,e]of this._itemNameToValues){let i=new z(this.name,t);this._items.set(i.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}ContainsItem(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[i,n]of this._itemNameToValues)if(n==t)return{result:new z(this.name,i),exists:!0};return{result:z.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let i=this._itemNameToValues.get(t.itemName);return i?{result:i,exists:!0}:{result:0,exists:!1}}}class ft{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[t,i]of e.items){let e=z.fromSerializedKey(t),n=new et(e,i);if(!e.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(e.itemName,n),this._allUnambiguousListValueCache.set(e.fullName,n)}}}get lists(){let t=[];for(let[,e]of this._lists)t.push(e);return t}TryListGetDefinition(t,e){if(null===t)return{result:e,exists:!1};let i=this._lists.get(t);return i?{result:i,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(null===t)return G("name");let e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}class yt{static JArrayToRuntimeObjList(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t.length;e&&i--;let n=[];for(let r=0;r<i;r++){let e=t[r],i=this.JTokenToRuntimeObject(e);if(null===i)return G("runtimeObj");n.push(i)}return n}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(let[i,n]of e)t.WritePropertyStart(i),this.WriteRuntimeObject(t,n),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(let i of e)this.WriteRuntimeObject(t,i);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(let[i,n]of e)t.WriteIntProperty(i,n);t.WriteObjectEnd()}static WriteRuntimeObject(t,e){let i=F(e,nt);if(i)return void this.WriteRuntimeContainer(t,i);let n=F(e,ot);if(n){let e,i="->";return n.isExternal?i="x()":n.pushesToStack&&(n.stackPushType==_.Function?i="f()":n.stackPushType==_.Tunnel&&(i="->t->")),e=n.hasVariableTarget?n.variableDivertName:n.targetPathString,t.WriteObjectStart(),t.WriteProperty(i,e),n.hasVariableTarget&&t.WriteProperty("var",!0),n.isConditional&&t.WriteProperty("c",!0),n.externalArgs>0&&t.WriteIntProperty("exArgs",n.externalArgs),void t.WriteObjectEnd()}let r=F(e,lt);if(r)return t.WriteObjectStart(),t.WriteProperty("*",r.pathStringOnChoice),t.WriteIntProperty("flg",r.flags),void t.WriteObjectEnd();let s=F(e,$);if(s)return void t.WriteBool(s.value);let a=F(e,X);if(a)return void t.WriteInt(a.value);let o=F(e,Y);if(o)return void t.WriteFloat(o.value);let l=F(e,Q);if(l)return void(l.isNewline?t.Write("\n",!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(l.value),t.WriteStringEnd()));let h=F(e,et);if(h)return void this.WriteInkList(t,h);let u=F(e,Z);if(u)return t.WriteObjectStart(),null===u.value?G("divTargetVal.value"):(t.WriteProperty("^->",u.value.componentsString),void t.WriteObjectEnd());let c=F(e,tt);if(c)return t.WriteObjectStart(),t.WriteProperty("^var",c.value),t.WriteIntProperty("ci",c.contextIndex),void t.WriteObjectEnd();if(F(e,rt))return void t.Write("<>");let d=F(e,st);if(d)return void t.Write(yt._controlCommandNames[d.commandType]);let p=F(e,dt);if(p){let e=p.name;return"^"==e&&(e="L^"),void t.Write(e)}let m=F(e,ht);if(m){t.WriteObjectStart();let e=m.pathStringForCount;return null!=e?t.WriteProperty("CNT?",e):t.WriteProperty("VAR?",m.name),void t.WriteObjectEnd()}let g=F(e,ut);if(g){t.WriteObjectStart();let e=g.isGlobal?"VAR=":"temp=";return t.WriteProperty(e,g.variableName),g.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(F(e,ct))return void t.Write("void");let f=F(e,pt);if(f)return t.WriteObjectStart(),t.WriteProperty("#",f.text),void t.WriteObjectEnd();let y=F(e,mt);if(!y)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,y)}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let i in t)if(t.hasOwnProperty(i)){let n=this.JTokenToRuntimeObject(t[i]);if(null===n)return G("inkObject");e.set(i,n)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let i in t)t.hasOwnProperty(i)&&e.set(i,parseInt(t[i]));return e}static JTokenToRuntimeObject(t){if("number"==typeof t&&!isNaN(t)||"boolean"==typeof t)return H.Create(t);if("string"==typeof t){let e=t.toString(),i=e[0];if("^"==i)return new Q(e.substring(1));if("\n"==i&&1==e.length)return new Q("\n");if("<>"==e)return new rt;for(let t=0;t<yt._controlCommandNames.length;++t)if(e==yt._controlCommandNames[t])return new st(t);if("L^"==e&&(e="^"),dt.CallExistsWithName(e))return dt.CallWithName(e);if("->->"==e)return st.PopTunnel();if("~ret"==e)return st.PopFunction();if("void"==e)return new ct}if("object"==typeof t&&!Array.isArray(t)){let e,i=t;if(i["^->"])return e=i["^->"],new Z(new I(e.toString()));if(i["^var"]){e=i["^var"];let t=new tt(e.toString());return"ci"in i&&(e=i.ci,t.contextIndex=parseInt(e)),t}let n=!1,r=!1,s=_.Function,a=!1;if((e=i["->"])?n=!0:(e=i["f()"])?(n=!0,r=!0,s=_.Function):(e=i["->t->"])?(n=!0,r=!0,s=_.Tunnel):(e=i["x()"])&&(n=!0,a=!0,r=!1,s=_.Function),n){let t=new ot;t.pushesToStack=r,t.stackPushType=s,t.isExternal=a;let n=e.toString();return(e=i.var)?t.variableDivertName=n:t.targetPathString=n,t.isConditional=!!i.c,a&&(e=i.exArgs)&&(t.externalArgs=parseInt(e)),t}if(e=i["*"]){let t=new lt;return t.pathStringOnChoice=e.toString(),(e=i.flg)&&(t.flags=parseInt(e)),t}if(e=i["VAR?"])return new ht(e.toString());if(e=i["CNT?"]){let t=new ht;return t.pathStringForCount=e.toString(),t}let o=!1,l=!1;if((e=i["VAR="])?(o=!0,l=!0):(e=i["temp="])&&(o=!0,l=!1),o){let t=e.toString(),n=!i.re,r=new ut(t,n);return r.isGlobal=l,r}if(void 0!==i["#"])return e=i["#"],new pt(e.toString());if(e=i.list){let t=e,n=new K;if(e=i.origins){let t=e;n.SetInitialOriginNames(t)}for(let e in t)if(t.hasOwnProperty(e)){let i=t[e],r=new z(e),s=parseInt(i);n.Add(r,s)}return new et(n)}if(null!=i.originalChoicePath)return this.JObjectToChoice(i)}if(Array.isArray(t))return this.JArrayToContainer(t);if(null==t)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(t,["parent"]))}static toJson(t,e,i){return JSON.stringify(t,((t,i)=>(null==e?void 0:e.some((e=>e===t)))?void 0:i),i)}static WriteRuntimeContainer(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.WriteArrayStart(),null===e)return G("container");for(let o of e.content)this.WriteRuntimeObject(t,o);let n=e.namedOnlyContent,r=e.countFlags,s=null!=e.name&&!i,a=null!=n||r>0||s;if(a&&t.WriteObjectStart(),null!=n)for(let[o,l]of n){let e=o,i=F(l,nt);t.WritePropertyStart(e),this.WriteRuntimeContainer(t,i,!0),t.WritePropertyEnd()}r>0&&t.WriteIntProperty("#f",r),s&&t.WriteProperty("#n",e.name),a?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}static JArrayToContainer(t){let e=new nt;e.content=this.JArrayToRuntimeObjList(t,!0);let i=t[t.length-1];if(null!=i){let t=new Map;for(let n in i)if("#f"==n)e.countFlags=parseInt(i[n]);else if("#n"==n)e.name=i[n].toString();else{let e=this.JTokenToRuntimeObject(i[n]),r=F(e,nt);r&&(r.name=n),t.set(n,e)}e.namedOnlyContent=t}return e}static JObjectToChoice(t){let e=new mt;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e.tags=this.JArrayToTags(t),e}static JArrayToTags(t){return t.tags?t.tags:null}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),this.WriteChoiceTags(t,e),t.WriteObjectEnd()}static WriteChoiceTags(t,e){if(e.tags&&e.tags.length>0){t.WritePropertyStart("tags"),t.WriteArrayStart();for(const i of e.tags)t.Write(i);t.WriteArrayEnd(),t.WritePropertyEnd()}}static WriteInkList(t,e){let i=e.value;if(null===i)return G("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();for(let[n,r]of i){let e=z.fromSerializedKey(n),i=r;if(null===e.itemName)return G("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(e.originName?e.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(e.itemName),t.WritePropertyNameEnd(),t.Write(i),t.WritePropertyEnd()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==i.Count&&null!=i.originNames&&i.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();for(let e of i.originNames)t.Write(e);t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}static ListDefinitionsToJToken(t){let e={};for(let i of t.lists){let t={};for(let[e,n]of i.items){let i=z.fromSerializedKey(e);if(null===i.itemName)return G("item.itemName");t[i.itemName]=n}e[i.name]=t}return e}static JTokenToListDefinitions(t){let e=t,i=[];for(let n in e)if(e.hasOwnProperty(n)){let t=n.toString(),r=e[n],s=new Map;for(let i in r)if(e.hasOwnProperty(n)){let t=r[i];s.set(i,parseInt(t))}let a=new gt(t,s);i.push(a)}return new ft(i)}}yt._controlCommandNames=(()=>{let t=[];t[st.CommandType.EvalStart]="ev",t[st.CommandType.EvalOutput]="out",t[st.CommandType.EvalEnd]="/ev",t[st.CommandType.Duplicate]="du",t[st.CommandType.PopEvaluatedValue]="pop",t[st.CommandType.PopFunction]="~ret",t[st.CommandType.PopTunnel]="->->",t[st.CommandType.BeginString]="str",t[st.CommandType.EndString]="/str",t[st.CommandType.NoOp]="nop",t[st.CommandType.ChoiceCount]="choiceCnt",t[st.CommandType.Turns]="turn",t[st.CommandType.TurnsSince]="turns",t[st.CommandType.ReadCount]="readc",t[st.CommandType.Random]="rnd",t[st.CommandType.SeedRandom]="srnd",t[st.CommandType.VisitIndex]="visit",t[st.CommandType.SequenceShuffleIndex]="seq",t[st.CommandType.StartThread]="thread",t[st.CommandType.Done]="done",t[st.CommandType.End]="end",t[st.CommandType.ListFromInt]="listInt",t[st.CommandType.ListRange]="range",t[st.CommandType.ListRandom]="lrnd",t[st.CommandType.BeginTag]="#",t[st.CommandType.EndTag]="/#";for(let e=0;e<st.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t})();class St{get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){b.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}constructor(){if(this._threadCounter=0,this._startOfRoot=at.Null,arguments[0]instanceof xt){let t=arguments[0];this._startOfRoot=at.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot.copy()}}Reset(){this._threads=[],this._threads.push(new St.Thread),this._threads[0].callstack.push(new St.Element(_.Tunnel,this._startOfRoot))}SetJsonToken(t,e){this._threads.length=0;let i=t.threads;for(let n of i){let t=n,i=new St.Thread(t,e);this._threads.push(i)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=at.StartOf(e.rootContentContainer)}WriteJson(t){t.WriteObject((t=>{t.WritePropertyStart("threads"),t.WriteArrayStart();for(let e of this._threads)e.WriteJson(t);t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(this._threadCounter),t.WritePropertyEnd()}))}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){let t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==_.FunctionEvaluationFromGame}Push(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=new St.Element(t,this.currentElement.currentPointer,!1);n.evaluationStackHeightWhenPushed=e,n.functionStartInOutputStream=i,this.callStack.push(n)}CanPop(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==t||this.currentElement.type==t)}Pop(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==e&&(e=this.currentElementIndex+1);let i=J(this.callStack[e-1].temporaryVariables,t,null);return i.exists?i.result:null}SetTemporaryVariable(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;-1==n&&(n=this.currentElementIndex+1);let r=this.callStack[n-1];if(!i&&!r.temporaryVariables.get(t))throw new Error("Could not find temporary variable to set: "+t);let s=J(r.temporaryVariables,t,null);s.exists&&et.RetainListOriginsForAssignment(s.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){let e=this._threads.filter((e=>{if(e.threadIndex==t)return e}));return e.length>0?e[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new M;for(let e=0;e<this._threads.length;e++){let i=this._threads[e],n=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,n?"(current) ":"");for(let e=0;e<i.callstack.length;e++){i.callstack[e].type==_.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let n=i.callstack[e].currentPointer;if(!n.isNull){if(t.Append("<SOMEWHERE IN "),null===n.container)return G("pointer.container");t.Append(n.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}!function(t){class e{constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=i,this.temporaryVariables=new Map,this.type=t}Copy(){let t=new e(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}t.Element=e;class i{constructor(){if(this.threadIndex=0,this.previousPointer=at.Null,this.callstack=[],arguments[0]&&arguments[1]){let t=arguments[0],i=arguments[1];this.threadIndex=parseInt(t.threadIndex);let n=t.callstack;for(let s of n){let t,n=s,r=parseInt(n.type),a=at.Null,o=n.cPath;if(void 0!==o){t=o.toString();let e=i.ContentAtPath(new I(t));if(a.container=e.container,a.index=parseInt(n.idx),null==e.obj)throw new Error("When loading state, internal story location couldn't be found: "+t+". Has the story changed since this save data was created?");e.approximate&&(null!==a.container?i.Warning("When loading state, exact internal story location couldn't be found: '"+t+"', so it was approximated to '"+a.container.path.toString()+"' to recover. Has the story changed since this save data was created?"):i.Warning("When loading state, exact internal story location couldn't be found: '"+t+"' and it may not be recoverable. Has the story changed since this save data was created?"))}let l=!!n.exp,h=new e(r,a,l),u=n.temp;void 0!==u?h.temporaryVariables=yt.JObjectToDictionaryRuntimeObjs(u):h.temporaryVariables.clear(),this.callstack.push(h)}let r=t.previousContentObject;if(void 0!==r){let t=new I(r.toString());this.previousPointer=i.PointerAtPath(t)}}}Copy(){let t=new i;t.threadIndex=this.threadIndex;for(let e of this.callstack)t.callstack.push(e.Copy());return t.previousPointer=this.previousPointer.copy(),t}WriteJson(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();for(let e of this.callstack){if(t.WriteObjectStart(),!e.currentPointer.isNull){if(null===e.currentPointer.container)return G("el.currentPointer.container");t.WriteProperty("cPath",e.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",e.currentPointer.index)}t.WriteProperty("exp",e.inExpressionEvaluation),t.WriteIntProperty("type",e.type),e.temporaryVariables.size>0&&(t.WritePropertyStart("temp"),yt.WriteDictionaryRuntimeObjs(t,e.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let e=this.previousPointer.Resolve();if(null===e)return G("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",e.path.toString())}t.WriteObjectEnd()}}t.Thread=i}(St||(St={}));class vt extends class{}{variableChangedEvent(t,e){for(let i of this.variableChangedEventCallbacks)i(t,e)}StartVariableObservation(){this._batchObservingVariableChanges=!0,this._changedVariablesForBatchObs=new Set}CompleteVariableObservation(){this._batchObservingVariableChanges=!1;let t=new Map;if(null!=this._changedVariablesForBatchObs)for(let e of this._changedVariablesForBatchObs){let t=this._globalVariables.get(e);this.variableChangedEvent(e,t)}if(null!=this.patch)for(let e of this.patch.changedVariables){let i=this.patch.TryGetGlobal(e,null);i.exists&&t.set(e,i)}return this._changedVariablesForBatchObs=null,t}NotifyObservers(t){for(const[e,i]of t)this.variableChangedEvent(e,i)}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(void 0===e){let e=null;return null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists)?e.result.valueObject:(e=this._globalVariables.get(t),void 0===e&&(e=this._defaultGlobalVariables.get(t)),void 0!==e?e.valueObject:null)}{if(void 0===this._defaultGlobalVariables.get(t))throw new U("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let i=H.Create(e);if(null==i)throw null==e?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}}constructor(t,e){super(),this.variableChangedEventCallbacks=[],this.patch=null,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._batchObservingVariableChanges=!1,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(t,e)=>e in t?t[e]:t.$(e),set:(t,e,i)=>(e in t?t[e]=i:t.$(e,i),!0)})}catch(i){}}ApplyPatch(){if(null===this.patch)return G("this.patch");for(let[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(null!==this._changedVariablesForBatchObs)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(let[e,i]of this._defaultGlobalVariables){let n=t[e];if(void 0!==n){let t=yt.JTokenToRuntimeObject(n);if(null===t)return G("tokenInkObject");this._globalVariables.set(e,t)}else this._globalVariables.set(e,i)}}WriteJson(t){t.WriteObjectStart();for(let[e,i]of this._globalVariables){let n=e,r=i;if(vt.dontSaveDefaultValues&&this._defaultGlobalVariables.has(n)){let t=this._defaultGlobalVariables.get(n);if(this.RuntimeObjectsEqual(r,t))continue}t.WritePropertyStart(n),yt.WriteRuntimeObject(t,r),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(null===t)return G("obj1");if(null===e)return G("obj2");if(t.constructor!==e.constructor)return!1;let i=F(t,$);if(null!==i)return i.value===W(e,$).value;let n=F(t,X);if(null!==n)return n.value===W(e,X).value;let r=F(t,Y);if(null!==r)return r.value===W(e,Y).value;let s=F(t,H),a=F(e,H);if(null!==s&&null!==a)return D(s.valueObject)&&D(a.valueObject)?s.valueObject.Equals(a.valueObject):s.valueObject===a.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,i=this.GetRawVariableWithName(t,e),n=F(i,tt);return null!==n&&(i=this.ValueAtVariablePointer(n)),i}TryGetDefaultVariableValue(t){let e=J(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(t,e){let i=null;if(0==e||-1==e){let e=null;if(null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists))return e.result;if(e=J(this._globalVariables,t,null),e.exists)return e.result;if(null!==this._defaultGlobalVariables&&(e=J(this._defaultGlobalVariables,t,null),e.exists))return e.result;if(null===this._listDefsOrigin)return G("VariablesState._listDefsOrigin");let i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return i=this._callStack.GetTemporaryVariableWithName(t,e),i}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let i=t.variableName;if(null===i)return G("name");let n=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(i),t.isNewDeclaration){let t=F(e,tt);null!==t&&(e=this.ResolveVariablePointer(t))}else{let t=null;do{t=F(this.GetRawVariableWithName(i,n),tt),null!=t&&(i=t.variableName,n=t.contextIndex,r=0==n)}while(null!=t)}r?this.SetGlobal(i,e):this._callStack.SetTemporaryVariable(i,e,t.isNewDeclaration,n)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let i=W(t,et),n=W(e,et);i.value&&n.value&&0==n.value.Count&&n.value.SetInitialOriginNames(i.value.originNames)}SetGlobal(t,e){let i=null;if(null===this.patch&&(i=J(this._globalVariables,t,null)),null!==this.patch&&(i=this.patch.TryGetGlobal(t,null),i.exists||(i=J(this._globalVariables,t,null))),et.RetainListOriginsForAssignment(i.result,e),null===t)return G("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==i&&e!==i.result)if(this._batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return G("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let i=F(this.GetRawVariableWithName(t.variableName,e),tt);return null!=i?i:new tt(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}vt.dontSaveDefaultValues=!0;class Ct{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=48271*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class bt{get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){let t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}TryGetGlobal(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}class wt{static TextToDictionary(t){return new wt.Reader(t).ToDictionary()}static TextToArray(t){return new wt.Reader(t).ToArray()}}!function(t){t.Reader=class{constructor(t){this._rootObject=JSON.parse(t)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class e{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let e={};if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(t,e){if(this.WritePropertyStart(t),arguments[1]instanceof Function)(0,arguments[1])(this);else{let t=arguments[1];this.Write(t)}this.WritePropertyEnd()}WriteIntProperty(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}WriteFloatProperty(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}WritePropertyStart(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}WriteArrayStart(){this.StartNewObject(!0);let e=[];if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(t){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null value")}WriteBool(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(t))}WriteInt(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}WriteFloat(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(e){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}toString(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}StartNewObject(e){e?this.Assert(this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array):this.Assert(this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}Assert(t){if(!t)throw Error("Assert failed while writing JSON")}_addToCurrentObject(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}}var i,n;t.Writer=e,(n=(i=e=t.Writer||(t.Writer={})).State||(i.State={}))[n.None=0]="None",n[n.Object=1]="Object",n[n.Array=2]="Array",n[n.Property=3]="Property",n[n.PropertyName=4]="PropertyName",n[n.String=5]="String",i.StateElement=class{constructor(e){this.type=t.Writer.State.None,this.childCount=0,this.type=e}}}(wt||(wt={}));class _t{constructor(){let t=arguments[0],e=arguments[1];if(this.name=t,this.callStack=new St(e),arguments[2]){let t=arguments[2];this.callStack.SetJsonToken(t.callstack,e),this.outputStream=yt.JArrayToRuntimeObjList(t.outputStream),this.currentChoices=yt.JArrayToRuntimeObjList(t.currentChoices);let i=t.choiceThreads;void 0!==i&&this.LoadFlowChoiceThreads(i,e)}else this.outputStream=[],this.currentChoices=[]}WriteJson(t){t.WriteObjectStart(),t.WriteProperty("callstack",(t=>this.callStack.WriteJson(t))),t.WriteProperty("outputStream",(t=>yt.WriteListRuntimeObjs(t,this.outputStream)));let e=!1;for(let i of this.currentChoices){if(null===i.threadAtGeneration)return G("c.threadAtGeneration");i.originalThreadIndex=i.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(i.originalThreadIndex)&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(i.originalThreadIndex),i.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",(t=>{t.WriteArrayStart();for(let e of this.currentChoices)yt.WriteChoice(t,e);t.WriteArrayEnd()})),t.WriteObjectEnd()}LoadFlowChoiceThreads(t,e){for(let i of this.currentChoices){let n=this.callStack.ThreadWithIndex(i.originalThreadIndex);if(null!==n)i.threadAtGeneration=n.Copy();else{let n=t[`${i.originalThreadIndex}`];i.threadAtGeneration=new St.Thread(n,e)}}}}class Tt{ToJson(){let t=new wt.Writer;return this.WriteJson(t),t.toString()}toJson(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.ToJson(t)}LoadJson(t){let e=wt.TextToDictionary(t);this.LoadJsonObj(e),null!==this.onDidLoadState&&this.onDidLoadState()}VisitCountAtPathString(t){let e;if(null!==this._patch){let i=this.story.ContentAtPath(new I(t)).container;if(null===i)throw new Error("Content at path not found: "+t);if(e=this._patch.TryGetVisitCount(i,0),e.exists)return e.result}return e=J(this._visitCounts,t,null),e.exists?e.result:0}VisitCountForContainer(t){if(null===t)return G("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){let e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}let e=t.path.toString(),i=J(this._visitCounts,e,null);return i.exists?i.result:0}IncrementVisitCountForContainer(t){if(null!==this._patch){let e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}let e=t.path.toString(),i=J(this._visitCounts,e,null);i.exists?this._visitCounts.set(e,i.result+1):this._visitCounts.set(e,1)}RecordTurnIndexVisitToContainer(t){if(null!==this._patch)return void this._patch.SetTurnIndex(t,this.currentTurnIndex);let e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}TurnsSinceForContainer(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){let e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}let e=t.path.toString(),i=J(this._turnIndices,e,0);return i.exists?this.currentTurnIndex-i.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._currentFlow.outputStream}get currentChoices(){return this.canContinue?[]:this._currentFlow.currentChoices}get generatedChoices(){return this._currentFlow.currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get callStack(){return this._currentFlow.callStack}get evaluationStack(){return this._evaluationStack}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){let t=this.currentPointer;return t.isNull?null:null===t.path?G("pointer.path"):t.path.toString()}get previousPathString(){let t=this.previousPointer;return t.isNull?null:null===t.path?G("previousPointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&this.currentErrors.length>0}get hasWarning(){return null!=this.currentWarnings&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new M,e=!1;for(let i of this.outputStream){let n=F(i,Q);if(e||null===n){let t=F(i,st);null!==t&&(t.commandType==st.CommandType.BeginTag?e=!0:t.commandType==st.CommandType.EndTag&&(e=!1))}else t.Append(n.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new M,i=-1,n=0;for(let r=0;r<t.length;r++){let s=t.charAt(r),a=" "==s||"\t"==s;a&&-1==i&&(i=r),a||("\n"!=s&&i>0&&i!=n&&e.Append(" "),i=-1),"\n"==s&&(n=r+1),a||e.Append(s)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];let t=!1,e=new M;for(let i of this.outputStream){let n=F(i,st);if(null!=n){if(n.commandType==st.CommandType.BeginTag){if(t&&e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}t=!0}else if(n.commandType==st.CommandType.EndTag){if(e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}t=!1}}else if(t){let t=F(i,Q);null!==t&&e.Append(t.value)}else{let t=F(i,pt);null!=t&&null!=t.text&&t.text.length>0&&this._currentTags.push(t.text)}}if(e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}this._outputStreamTagsDirty=!1}return this._currentTags}get currentFlowName(){return this._currentFlow.name}get currentFlowIsDefaultFlow(){return this._currentFlow.name==this.kDefaultFlowName}get aliveFlowNames(){if(this._aliveFlowNamesDirty){if(this._aliveFlowNames=[],null!=this._namedFlows)for(let t of this._namedFlows.keys())t!=this.kDefaultFlowName&&this._aliveFlowNames.push(t);this._aliveFlowNamesDirty=!1}return this._aliveFlowNames}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}constructor(t){this.kInkSaveStateVersion=10,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=at.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._aliveFlowNames=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this._aliveFlowNamesDirty=!0,this.story=t,this._currentFlow=new _t(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this._evaluationStack=[],this._variablesState=new vt(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let e=(new Date).getTime();this.storySeed=new Ct(e).next()%100,this.previousRandom=0,this.GoToStart()}GoToStart(){this.callStack.currentElement.currentPointer=at.StartOf(this.story.mainContentContainer)}SwitchFlow_Internal(t){if(null===t)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),t===this._currentFlow.name)return;let e,i=J(this._namedFlows,t,null);i.exists?e=i.result:(e=new _t(t,this.story),this._namedFlows.set(t,e),this._aliveFlowNamesDirty=!0),this._currentFlow=e,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}SwitchToDefaultFlow_Internal(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}RemoveFlow_Internal(t){if(null===t)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return G("this._namedFlows");this._namedFlows.delete(t),this._aliveFlowNamesDirty=!0}CopyAndStartPatching(t){let e=new Tt(this.story);if(e._patch=new bt(this._patch),e._currentFlow.name=this._currentFlow.name,e._currentFlow.callStack=new St(this._currentFlow.callStack),e._currentFlow.outputStream.push(...this._currentFlow.outputStream),e.OutputStreamDirty(),t)for(let i of this._currentFlow.currentChoices)e._currentFlow.currentChoices.push(i.Clone());else e._currentFlow.currentChoices.push(...this._currentFlow.currentChoices);if(null!==this._namedFlows){e._namedFlows=new Map;for(let[t,i]of this._namedFlows)e._namedFlows.set(t,i),e._aliveFlowNamesDirty=!0;e._namedFlows.set(this._currentFlow.name,e._currentFlow)}return this.hasError&&(e._currentErrors=[],e._currentErrors.push(...this.currentErrors||[])),this.hasWarning&&(e._currentWarnings=[],e._currentWarnings.push(...this.currentWarnings||[])),e.variablesState=this.variablesState,e.variablesState.callStack=e.callStack,e.variablesState.patch=e._patch,e.evaluationStack.push(...this.evaluationStack),this.divertedPointer.isNull||(e.divertedPointer=this.divertedPointer.copy()),e.previousPointer=this.previousPointer.copy(),e._visitCounts=this._visitCounts,e._turnIndices=this._turnIndices,e.currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(null!==this._patch){this.variablesState.ApplyPatch();for(let[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,i){(i?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}WriteJson(t){if(t.WriteObjectStart(),t.WritePropertyStart("flows"),t.WriteObjectStart(),null!==this._namedFlows)for(let[e,i]of this._namedFlows)t.WriteProperty(e,(t=>i.WriteJson(t)));else t.WriteProperty(this._currentFlow.name,(t=>this._currentFlow.WriteJson(t)));if(t.WriteObjectEnd(),t.WritePropertyEnd(),t.WriteProperty("currentFlowName",this._currentFlow.name),t.WriteProperty("variablesState",(t=>this.variablesState.WriteJson(t))),t.WriteProperty("evalStack",(t=>yt.WriteListRuntimeObjs(t,this.evaluationStack))),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return G("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",(t=>yt.WriteIntDictionary(t,this._visitCounts))),t.WriteProperty("turnIndices",(t=>yt.WriteIntDictionary(t,this._turnIndices))),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",xt.inkVersionCurrent),t.WriteObjectEnd()}LoadJsonObj(t){let e=t,i=e.inkSaveVersion;if(null==i)throw new Error("ink save format incorrect, can't load.");if(parseInt(i)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+i+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");let n=e.flows;if(null!=n){let t=n;1===Object.keys(t).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear();let i=Object.entries(t);for(let[e,n]of i){let i=e,r=n,s=new _t(i,this.story,r);if(1===Object.keys(t).length)this._currentFlow=new _t(i,this.story,r);else{if(null===this._namedFlows)return G("this._namedFlows");this._namedFlows.set(i,s)}}if(null!=this._namedFlows&&this._namedFlows.size>1){let t=e.currentFlowName;this._currentFlow=this._namedFlows.get(t)}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=yt.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=yt.JArrayToRuntimeObjList(e.currentChoices);let t=e.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(t,this.story)}this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=yt.JArrayToRuntimeObjList(e.evalStack);let r=e.currentDivertTarget;if(null!=r){let t=new I(r.toString());this.divertedPointer=this.story.PointerAtPath(t)}this._visitCounts=yt.JObjectToIntDictionary(e.visitCounts),this._turnIndices=yt.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==t&&this.outputStream.push(...t),this.OutputStreamDirty()}PushToOutputStream(t){let e=F(t,Q);if(null!==e){let t=this.TrySplittingHeadTailWhitespace(e);if(null!==t){for(let e of t)this.PushToOutputStreamIndividual(e);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(null===e)return G("single.value");let i=-1,n=-1;for(let h=0;h<e.length;h++){let t=e[h];if("\n"!=t){if(" "==t||"\t"==t)continue;break}-1==i&&(i=h),n=h}let r=-1,s=-1;for(let h=e.length-1;h>=0;h--){let t=e[h];if("\n"!=t){if(" "==t||"\t"==t)continue;break}-1==r&&(r=h),s=h}if(-1==i&&-1==r)return null;let a=[],o=0,l=e.length;if(-1!=i){if(i>0){let t=new Q(e.substring(0,i));a.push(t)}a.push(new Q("\n")),o=n+1}if(-1!=r&&(l=s),l>o){let t=e.substring(o,l);a.push(new Q(t))}if(-1!=r&&s>n&&(a.push(new Q("\n")),r<e.length-1)){let t=e.length-r-1,i=new Q(e.substring(r+1,r+1+t));a.push(i)}return a}PushToOutputStreamIndividual(t){let e=F(t,rt),i=F(t,Q),n=!0;if(e)this.TrimNewlinesFromOutputStream(),n=!0;else if(i){let t=-1,e=this.callStack.currentElement;e.type==_.Function&&(t=e.functionStartInOutputStream);let r=-1;for(let i=this.outputStream.length-1;i>=0;i--){let e=this.outputStream[i],n=e instanceof st?e:null;if(null!=(e instanceof rt?e:null)){r=i;break}if(null!=n&&n.commandType==st.CommandType.BeginString){i>=t&&(t=-1);break}}let s=-1;if(s=-1!=r&&-1!=t?Math.min(t,r):-1!=r?r:t,-1!=s){if(i.isNewline)n=!1;else if(i.isNonWhitespace&&(r>-1&&this.RemoveExistingGlue(),t>-1)){let t=this.callStack.elements;for(let e=t.length-1;e>=0;e--){let i=t[e];if(i.type!=_.Function)break;i.functionStartInOutputStream=-1}}}else i.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(n=!1))}if(n){if(null===t)return G("obj");this.outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this.outputStream.length-1;for(;e>=0;){let i=this.outputStream[e],n=F(i,st),r=F(i,Q);if(null!=n||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this.outputStream.length;)F(this.outputStream[e],Q)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this.outputStream.length-1;t>=0;t--){let e=this.outputStream[t];if(e instanceof rt)this.outputStream.splice(t,1);else if(e instanceof st)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this.outputStream.length>0)for(let t=this.outputStream.length-1;t>=0&&!(this.outputStream[t]instanceof st);t--){let e=this.outputStream[t];if(e instanceof Q){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t of this.outputStream)if(t instanceof Q)return!0;return!1}get inStringEvaluation(){for(let t=this.outputStream.length-1;t>=0;t--){let e=F(this.outputStream[t],st);if(e instanceof st&&e.commandType==st.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=F(t,et);if(e){let t=e.value;if(null===t)return G("rawList");if(null!=t.originNames){t.origins||(t.origins=[]),t.origins.length=0;for(let e of t.originNames){if(null===this.story.listDefinitions)return G("StoryState.story.listDefinitions");let i=this.story.listDefinitions.TryListGetDefinition(e,null);if(null===i.result)return G("StoryState def.result");t.origins.indexOf(i.result)<0&&t.origins.push(i.result)}}}if(null===t)return G("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(void 0===t)return L(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return L(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=at.Null,this.previousPointer=at.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){b.Assert(this.callStack.currentElement.type==_.Function);let t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(let e=this.outputStream.length-1;e>=t;e--){let t=this.outputStream[e],i=F(t,Q),n=F(t,st);if(null!=i){if(n)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this.outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==_.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentFlow.currentChoices.length=0;let i=this.story.PointerAtPath(t);i.isNull||-1!=i.index||(i.index=0),this.currentPointer=i,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(_.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=at.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(null!==t)for(let e=0;e<t.length;e++){if(!("number"==typeof t[e]||"string"==typeof t[e]||"boolean"==typeof t[e]||t[e]instanceof K))throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters must benumber, string, bool or InkList. Argument was "+(null===L(t[e])?"null":t[e].constructor.name));this.PushEvaluationStack(H.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==_.FunctionEvaluationFromGame&&(this.currentPointer=at.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=_.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let t=this.PopEvaluationStack();null===e&&(e=t)}if(this.PopCallStack(_.FunctionEvaluationFromGame),e){if(e instanceof ct)return null;let t=W(e,H);return t.valueType==w.DivertTarget?t.valueObject.toString():t.valueObject}return null}AddError(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class Et{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=void 0}}!function(t){t[t.Author=0]="Author",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(T||(T={})),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});class xt extends B{get currentChoices(){let t=[];if(null===this._state)return G("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get currentFlowName(){return this.state.currentFlowName}get currentFlowIsDefaultFlow(){return this.state.currentFlowIsDefaultFlow}get aliveFlowNames(){return this.state.aliveFlowNames}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}constructor(){let t;super(),this.inkVersionMinimumCompatible=18,this.onError=null,this.onDidContinue=null,this.onMakeChoice=null,this.onEvaluateFunction=null,this.onCompleteEvaluateFunction=null,this.onChoosePathString=null,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let e=null,i=null;if(arguments[0]instanceof nt)t=arguments[0],void 0!==arguments[1]&&(e=arguments[1]),this._mainContentContainer=t;else if("string"==typeof arguments[0]){let t=arguments[0];i=wt.TextToDictionary(t)}else i=arguments[0];if(null!=e&&(this._listDefinitions=new ft(e)),this._externals=new Map,null!==i){let t=i,e=t.inkVersion;if(null==e)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let n=parseInt(e);if(n>xt.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(n<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");n!=xt.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let r,s=t.root;if(null==s)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(r=t.listDefs)&&(this._listDefinitions=yt.JTokenToListDefinitions(r)),this._mainContentContainer=W(yt.JTokenToRuntimeObject(s),nt),this.ResetState()}}ToJson(t){let e=!1;if(t||(e=!0,t=new wt.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",xt.inkVersionCurrent),t.WriteProperty("root",(t=>yt.WriteRuntimeContainer(t,this._mainContentContainer))),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();for(let e of this._listDefinitions.lists){t.WritePropertyStart(e.name),t.WriteObjectStart();for(let[i,n]of e.items){let e=z.fromSerializedKey(i),r=n;t.WriteIntProperty(e.itemName,r)}t.WriteObjectEnd(),t.WritePropertyEnd()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),e)return t.toString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new Tt(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return G("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return G("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let t=this.state.currentPointer.copy();this.ChoosePath(new I("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}SwitchFlow(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}RemoveFlow(t){this.state.RemoveFlow_Internal(t)}SwitchToDefaultFlow(){this.state.SwitchToDefaultFlow_Internal()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,this._asyncContinueActive)this._asyncContinueActive&&!e&&(this._asyncContinueActive=!1);else{if(this._asyncContinueActive=e,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&this._state.variablesState.StartVariableObservation()}let i=new Et;i.Start();let n=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{n=this.ContinueSingleStep()}catch(s){if(!(s instanceof U))throw s;this.AddError(s.message,void 0,s.useEndLineNumber);break}if(n)break;if(this._asyncContinueActive&&i.ElapsedMilliseconds>t)break}while(this.canContinue);i.Stop();let r=null;if(!n&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(_.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(_.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(r=this._state.variablesState.CompleteVariableObservation()),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){let t=new M;throw t.Append("Ink had "),this.state.hasError&&(t.Append(`${this.state.currentErrors.length}`),t.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning&&t.Append(" and ")),this.state.hasWarning&&(t.Append(`${this.state.currentWarnings.length}`),t.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning&&t.Append(" and ")),t.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),t.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new U(t.toString())}if(this.state.hasError)for(let t of this.state.currentErrors)this.onError(t,T.Error);if(this.state.hasWarning)for(let t of this.state.currentWarnings)this.onError(t,T.Warning);this.ResetErrors()}null!=r&&Object.keys(r).length>0&&this._state.variablesState.NotifyObservers(r)}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return G("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return G("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==xt.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==xt.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,i,n){if(null===t)return G("prevText");if(null===e)return G("currText");let r=e.length>=t.length&&t.length>0&&"\n"==e.charAt(t.length-1);if(i==n&&t.length==e.length&&r)return xt.OutputStateChange.NoChange;if(!r)return xt.OutputStateChange.NewlineRemoved;if(n>i)return xt.OutputStateChange.ExtendedBeyondNewline;for(let s=t.length;s<e.length;s++){let t=e.charAt(s);if(" "!=t&&"\t"!=t)return xt.OutputStateChange.ExtendedBeyondNewline}return xt.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new M;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof nt?e:null}PointerAtPath(t){if(0==t.length)return at.Null;let e=new at,i=t.length,n=null;return null===t.lastComponent?G("path.lastComponent"):(t.lastComponent.isIndex?(i=t.length-1,n=this.mainContentContainer.ContentAtPath(t,void 0,i),e.container=n.container,e.index=t.lastComponent.index):(n=this.mainContentContainer.ContentAtPath(t),e.container=n.container,e.index=-1),null==n.obj||n.obj==this.mainContentContainer&&i>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):n.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+n.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching(!1)}RestoreStateSnapshot(){null===this._stateSnapshotAtLastNewline&&G("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let t=this._state;return this._state=this._state.CopyAndStartPatching(!0),this._asyncSaving=!0,t}BackgroundSaveComplete(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let i=F(e.Resolve(),nt);for(;i&&(this.VisitContainer(i,!0),0!=i.content.length);)e=at.StartOf(i),i=F(e.Resolve(),nt);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let n=e.Resolve(),r=this.PerformLogicAndFlowControl(n);if(this.state.currentPointer.isNull)return;r&&(t=!1);let s=F(n,lt);if(s){let e=this.ProcessChoice(s);e&&this.state.generatedChoices.push(e),n=null,t=!1}if(n instanceof nt&&(t=!1),t){let t=F(n,tt);if(t&&-1==t.contextIndex){let e=this.state.callStack.ContextForVariableNamed(t.variableName);n=new tt(t.variableName,e)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(n):this.state.PushToOutputStream(n)}this.NextContent();let a=F(n,st);a&&a.commandType==st.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||-1==e.index)return;if(this._prevContainers.length=0,!t.isNull){let e=F(t.Resolve(),nt)||F(t.container,nt);for(;e;)this._prevContainers.push(e),e=F(e.parent,nt)}let i=e.Resolve();if(null==i)return;let n=F(i.parent,nt),r=!0;for(;n&&(this._prevContainers.indexOf(n)<0||n.countingAtStartOnly);){let t=n.content.length>0&&i==n.content[0]&&r;t||(r=!1),this.VisitContainer(n,t),i=n,n=F(n.parent,nt)}}PopChoiceStringAndTags(t){let e=W(this.state.PopEvaluationStack(),Q);for(;this.state.evaluationStack.length>0&&null!=F(this.state.PeekEvaluationStack(),pt);){let e=F(this.state.PopEvaluationStack(),pt);e&&t.push(e.text)}return e.value}ProcessChoice(t){let e=!0;if(t.hasCondition){let t=this.state.PopEvaluationStack();this.IsTruthy(t)||(e=!1)}let i="",n="",r=[];if(t.hasChoiceOnlyContent&&(n=this.PopChoiceStringAndTags(r)||""),t.hasStartContent&&(i=this.PopChoiceStringAndTags(r)||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;let s=new mt;return s.targetPath=t.pathOnChoice,s.sourcePath=t.path.toString(),s.isInvisibleDefault=t.isInvisibleDefault,s.threadAtGeneration=this.state.callStack.ForkThread(),s.tags=r.reverse(),s.text=(i+n).replace(/^[ \t]+|[ \t]+$/g,""),s}IsTruthy(t){if(t instanceof H){let e=t;if(e instanceof Z){let t=e;return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(null==t)return!1;if(t instanceof ot){let e=t;if(e.isConditional){let t=this.state.PopEvaluationStack();if(!this.IsTruthy(t))return!0}if(e.hasVariableTarget){let t=e.variableDivertName,i=this.state.variablesState.GetVariableWithName(t);if(null==i)this.Error("Tried to divert using a target from a variable that could not be found ("+t+")");else if(!(i instanceof Z)){let e=F(i,X),n="Tried to divert to a target from a variable, but the variable ("+t+") didn't contain a divert target, it ";e instanceof X&&0==e.value?n+="was empty/null (the value 0).":n+="contained '"+i+"'.",this.Error(n)}let n=W(i,Z);this.state.divertedPointer=this.PointerAtPath(n.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof st){let e=t;switch(e.commandType){case st.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case st.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case st.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let t=this.state.PopEvaluationStack();if(!(t instanceof ct)){let e=new Q(t.toString());this.state.PushToOutputStream(e)}}break;case st.CommandType.NoOp:break;case st.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case st.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case st.CommandType.PopFunction:case st.CommandType.PopTunnel:let t=e.commandType==st.CommandType.PopFunction?_.Function:_.Tunnel,i=null;if(t==_.Tunnel){let t=this.state.PopEvaluationStack();i=F(t,Z),null===i&&this.Assert(t instanceof ct,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==t&&this.state.callStack.canPop)this.state.PopCallStack(),i&&(this.state.divertedPointer=this.PointerAtPath(i.targetPath));else{let e=new Map;e.set(_.Function,"function return statement (~ return)"),e.set(_.Tunnel,"tunnel onwards statement (->->)");let i=e.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(i="end of flow (-> END or choice)");let n="Found "+e.get(t)+", when expected "+i;this.Error(n)}break;case st.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case st.CommandType.BeginTag:this.state.PushToOutputStream(e);break;case st.CommandType.EndTag:if(this.state.inStringEvaluation){let t=[],e=0;for(let r=this.state.outputStream.length-1;r>=0;--r){let i=this.state.outputStream[r];e++;let n=F(i,st);if(null!=n){if(n.commandType==st.CommandType.BeginTag)break;this.Error("Unexpected ControlCommand while extracting tag from choice");break}i instanceof Q&&t.push(i)}this.state.PopFromOutputStream(e);let i=new M;for(let r of t.reverse())i.Append(r.toString());let n=new pt(this.state.CleanOutputWhitespace(i.toString()));this.state.PushEvaluationStack(n)}else this.state.PushToOutputStream(e);break;case st.CommandType.EndString:{let t=[],e=[],i=0;for(let r=this.state.outputStream.length-1;r>=0;--r){let n=this.state.outputStream[r];i++;let s=F(n,st);if(s&&s.commandType==st.CommandType.BeginString)break;n instanceof pt&&e.push(n),n instanceof Q&&t.push(n)}this.state.PopFromOutputStream(i);for(let r of e)this.state.PushToOutputStream(r);t=t.reverse();let n=new M;for(let r of t)n.Append(r.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new Q(n.toString()));break}case st.CommandType.ChoiceCount:let n=this.state.generatedChoices.length;this.state.PushEvaluationStack(new X(n));break;case st.CommandType.Turns:this.state.PushEvaluationStack(new X(this.state.currentTurnIndex+1));break;case st.CommandType.TurnsSince:case st.CommandType.ReadCount:let r=this.state.PopEvaluationStack();if(!(r instanceof Z)){let t="";r instanceof X&&(t=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+r+t);break}let s,a=W(r,Z),o=F(this.ContentAtPath(a.targetPath).correctObj,nt);null!=o?s=e.commandType==st.CommandType.TurnsSince?this.state.TurnsSinceForContainer(o):this.state.VisitCountForContainer(o):(s=e.commandType==st.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+a.targetPath.toString())),this.state.PushEvaluationStack(new X(s));break;case st.CommandType.Random:{let t=F(this.state.PopEvaluationStack(),X),e=F(this.state.PopEvaluationStack(),X);if(null==e||e instanceof X==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==t||t instanceof X==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return G("maxInt.value");if(null===e.value)return G("minInt.value");let i=t.value-e.value+1;(!isFinite(i)||i>Number.MAX_SAFE_INTEGER)&&(i=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),i<=0&&this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger");let n=this.state.storySeed+this.state.previousRandom,r=new Ct(n).next(),s=r%i+e.value;this.state.PushEvaluationStack(new X(s)),this.state.previousRandom=r;break}case st.CommandType.SeedRandom:let l=F(this.state.PopEvaluationStack(),X);if(null==l||l instanceof X==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===l.value)return G("minInt.value");this.state.storySeed=l.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new ct);break;case st.CommandType.VisitIndex:let h=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new X(h));break;case st.CommandType.SequenceShuffleIndex:let u=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new X(u));break;case st.CommandType.StartThread:break;case st.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=at.Null);break;case st.CommandType.End:this.state.ForceEnd();break;case st.CommandType.ListFromInt:let c=F(this.state.PopEvaluationStack(),X),d=W(this.state.PopEvaluationStack(),Q);if(null===c)throw new U("Passed non-integer when creating a list element from a numerical value.");let p=null;if(null===this.listDefinitions)return G("this.listDefinitions");let m=this.listDefinitions.TryListGetDefinition(d.value,null);if(!m.exists)throw new U("Failed to find LIST called "+d.value);{if(null===c.value)return G("minInt.value");let t=m.result.TryGetItemWithValue(c.value,z.Null);t.exists&&(p=new et(t.result,c.value))}null==p&&(p=new et),this.state.PushEvaluationStack(p);break;case st.CommandType.ListRange:let g=F(this.state.PopEvaluationStack(),H),f=F(this.state.PopEvaluationStack(),H),y=F(this.state.PopEvaluationStack(),et);if(null===y||null===f||null===g)throw new U("Expected list, minimum and maximum for LIST_RANGE");if(null===y.value)return G("targetList.value");let S=y.value.ListWithSubRange(f.valueObject,g.valueObject);this.state.PushEvaluationStack(new et(S));break;case st.CommandType.ListRandom:{let t=this.state.PopEvaluationStack();if(null===t)throw new U("Expected list for LIST_RANDOM");let e=t.value,i=null;if(null===e)throw G("list");if(0==e.Count)i=new K;else{let t=this.state.storySeed+this.state.previousRandom,n=new Ct(t).next(),r=n%e.Count,s=e.entries();for(let e=0;e<=r-1;e++)s.next();let a=s.next().value,o={Key:z.fromSerializedKey(a[0]),Value:a[1]};if(null===o.Key.originName)return G("randomItem.Key.originName");i=new K(o.Key.originName,this),i.Add(o.Key,o.Value),this.state.previousRandom=n}this.state.PushEvaluationStack(new et(i));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof ut){let e=t,i=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,i),!0}if(t instanceof ht){let e=t,i=null;if(null!=e.pathForCount){let t=e.containerForCount,n=this.state.VisitCountForContainer(t);i=new X(n)}else i=this.state.variablesState.GetVariableWithName(e.name),null==i&&(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),i=new X(0));return this.state.PushEvaluationStack(i),!0}if(t instanceof dt){let e=t,i=this.state.PopEvaluationStack(e.numberOfParameters),n=e.Call(i);return this.state.PushEvaluationStack(n),!0}return!1}ChoosePathString(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(t,i),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==_.Function){let e="",i=this.state.callStack.currentElement.currentPointer.container;throw null!=i&&(e="("+i.path.toString()+") "),new Error("Story was running a function "+e+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(i),this.ChoosePath(new I(t))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let i=e[t];return null!==this.onMakeChoice&&this.onMakeChoice(i),null===i.threadAtGeneration?G("choiceToChoose.threadAtGeneration"):null===i.targetPath?G("choiceToChoose.targetPath"):(this.state.callStack.currentThread=i.threadAtGeneration,void this.ChoosePath(i.targetPath))}HasFunction(t){try{return null!=this.KnotContainerWithName(t)}catch(e){return!1}}EvaluateFunction(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");let n=this.KnotContainerWithName(t);if(null==n)throw new Error("Function doesn't exist: '"+t+"'");let r=[];r.push(...this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(n,e);let s=new M;for(;this.canContinue;)s.Append(this.Continue());let a=s.toString();this._state.ResetOutput(r);let o=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(t,e,a,o),i?{returned:o,output:a}:o}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(_.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let i=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>i?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(null===t)return G("funcName");let i=this._externals.get(t),n=null,r=void 0!==i;if(r&&!i.lookAheadSafe&&this._state.inStringEvaluation&&this.Error("External function "+t+' could not be called because 1) it wasn\'t marked as lookaheadSafe when BindExternalFunction was called and 2) the story is in the middle of string generation, either because choice text is being generated, or because you have ink like "hello {func()}". You can work around this by generating the result of your function into a temporary variable before the string or choice gets generated: ~ temp x = '+t+"()"),r&&!i.lookAheadSafe&&null!==this._stateSnapshotAtLastNewline)return void(this._sawLookaheadUnsafeFunctionAfterNewline=!0);if(!r){if(this.allowExternalFunctionFallbacks)return n=this.KnotContainerWithName(t),this.Assert(null!==n,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(_.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=at.StartOf(n));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let s=[];for(let l=0;l<e;++l){let t=W(this.state.PopEvaluationStack(),H).valueObject;s.push(t)}s.reverse();let a=i.function(s),o=null;null!=a?(o=H.Create(a),this.Assert(null!==o,"Could not create ink value from returned object of type "+typeof a)):o=new ct,this.state.PushEvaluationStack(o)}BindExternalFunctionGeneral(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:i})}TryCoerce(t){return t}BindExternalFunction(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,(t=>{this.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");let i=[];for(let e=0,n=t.length;e<n;e++)i[e]=this.TryCoerce(t[e]);return e.apply(null,i)}),i)}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,i=arguments[1]||new Set;if(arguments[0]instanceof nt&&(t=arguments[0]),arguments[0]instanceof B&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,i),this._hasValidatedExternals=!0,0==i.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t+=i.size>1?"s":"",t+=": '",t+=Array.from(i).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t)}else if(null!=t){for(let e of t.content)null!=e&&e.hasValidName||this.ValidateExternalBindings(e,i);for(let[,e]of t.namedContent)this.ValidateExternalBindings(F(e,B),i)}else if(null!=e){let t=F(e,ot);if(t&&t.isExternal){let e=t.targetPathString;if(null===e)return G("name");this._externals.has(e)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(e)||i.add(e)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let i=0,n=t.length;i<n;i++)this.ObserveVariable(t[i],e[i])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(null!=e){if(this._variableObservers.has(e))if(null!=t){let i=this._variableObservers.get(e);null!=i&&(i.splice(i.indexOf(t),1),0===i.length&&this._variableObservers.delete(e))}else this._variableObservers.delete(e)}else if(null!=t){let e=this._variableObservers.keys();for(let i of e){let e=this._variableObservers.get(i);null!=e&&(e.splice(e.indexOf(t),1),0===e.length&&this._variableObservers.delete(i))}}}VariableStateDidChangeEvent(t,e){if(null===this._variableObservers)return;let i=this._variableObservers.get(t);if(void 0!==i){if(!(e instanceof H))throw new Error("Tried to get the value of a variable that isn't a standard type");let n=W(e,H);for(let e of i)e(t,n.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let e=new I(t),i=this.ContentAtPath(e).container;if(null===i)return G("flowContainer");for(;;){let t=i.content[0];if(!(t instanceof nt))break;i=t}let n=!1,r=null;for(let s of i.content){let t=F(s,st);if(null!=t)t.commandType==st.CommandType.BeginTag?n=!0:t.commandType==st.CommandType.EndTag&&(n=!1);else{if(!n)break;{let t=F(s,Q);null!==t?(null===r&&(r=[]),null!==t.value&&r.push(t.value)):this.Error("Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().")}}}return r}BuildStringOfHierarchy(){let t=new M;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new M;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=at.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(_.Function)?(this.state.PopCallStack(_.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new ct),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return G("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let i=F(e.container.parent,nt);if(i instanceof nt==0)break;let n=i.content.indexOf(e.container);if(-1==n)break;if(e=new at(i,n),e.index++,t=!0,null===e.container)return G("pointer.container")}return t||(e=at.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter((t=>t.isInvisibleDefault));if(0==e.length||t.length>e.length)return!1;let i=e[0];return null===i.targetPath?G("choice.targetPath"):null===i.threadAtGeneration?G("choice.threadAtGeneration"):(this.state.callStack.currentThread=i.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(i.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=F(this.state.PopEvaluationStack(),X);if(!(t instanceof X))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(null===e)return G("seqContainer");if(null===t.value)return G("numElementsIntVal.value");let i=t.value,n=W(this.state.PopEvaluationStack(),X).value;if(null===n)return G("seqCount");let r=n/i,s=n%i,a=e.path.toString(),o=0;for(let c=0,d=a.length;c<d;c++)o+=a.charCodeAt(c)||0;let l=o+r+this.state.storySeed,h=new Ct(Math.floor(l)),u=[];for(let c=0;c<i;++c)u.push(c);for(let c=0;c<=s;++c){let t=h.next()%u.length,e=u[t];if(u.splice(t,1),c==s)return e}throw new Error("Should never reach here")}Error(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=new U(t);throw i.useEndLineNumber=e,i}Warning(t){this.AddError(t,!0)}AddError(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(null!=n){let e=i?n.endLineNumber:n.startLineNumber;t="RUNTIME "+r+": '"+n.fileName+"' line "+e+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let i=this.state.callStack.elements.length-1;i>=0;--i)if(e=this.state.callStack.elements[i].currentPointer,!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let i=this.state.outputStream.length-1;i>=0;--i)if(t=this.state.outputStream[i].debugMetadata,null!==t)return t;return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}xt.inkVersionCurrent=21,function(t){var e;(e=t.OutputStateChange||(t.OutputStateChange={}))[e.NoChange=0]="NoChange",e[e.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",e[e.NewlineRemoved=2]="NewlineRemoved"}(xt||(xt={}));class Ot{constructor(t,i,n){if(e(this,"type"),e(this,"data"),e(this,"callback"),this.type=t,"changeCharacterState"===t&&!i.newState)throw new Error("newState is required for changeCharacterState actions");this.data=i,this.callback=n}}class Pt{constructor(t){e(this,"scene"),e(this,"actionQueue",[]),e(this,"isExecuting",!1),e(this,"camera"),e(this,"speed"),this.scene=t,this.camera=t.cameras.main,this.speed=C}queueAction(t){this.actionQueue.push(t),this.tryExecuteNextAction(0)}update(t,e){!this.isExecuting&&this.actionQueue.length>0&&this.tryExecuteNextAction(e)}tryExecuteNextAction(t){if(this.isExecuting||0===this.actionQueue.length)return;const e=this.actionQueue.shift();e&&(this.isExecuting=!0,this.executeAction(e,t||0))}executeAction(t,e){switch(t.type){case"moveCameraTo":this.moveCameraTo(t.data.x,t.data.y,t.data.zoom,e,t.callback);break;case"zoomCamera":this.zoomCamera(t.data.zoom,e,t.callback);break;case"moveCharacterTo":this.moveCharacterTo(t.data.character,t.data.targetGrids,e,t.callback);break;case"changeCharacterAppearance":this.changeCharacterAppearance(t.data.character,t.data.appearanceKey,e,t.callback);break;case"playCharacterAnimation":this.playCharacterAnimation(t.data.character,t.data.animationKey,t.callback);break;case"displayPopup":this.displayPopup(t.data.text,t.data.x,t.data.y,t.callback);break;case"updateStoryWindow":this.updateStoryWindow(t.data.storyText,t.callback);break;case"triggerInkEvent":this.triggerInkEvent(t.data.inkEventKey,t.callback);break;case"triggerBattle":this.triggerBattle(t.callback);break;case"triggerCutscene":this.triggerCutscene(t.callback);break;case"playSoundEffect":this.playSoundEffect(t.data.soundKey,t.callback);break;case"displayDialogue":this.displayDialogue(t.data.text,t.data.character,t.callback);break;default:console.warn(`Unknown action type: ${t.type}`),this.completeAction()}}moveCameraTo(t,e,i,n,r){this.camera.pan(t,e,1e3,"Power2"),this.camera.zoomTo(i,1e3,"Power2",!0,((t,e)=>{1===e&&(null==r||r(),this.completeAction(n))}))}followObject(t,e,i){this.camera.startFollow(t,!0,.05,.05),null==i||i(),this.completeAction(e)}releaseCamera(t,e){this.camera.stopFollow(),this.camera.zoomTo(1,1e3,"Power2",!0,((i,n)=>{1===n&&(null==e||e(),this.completeAction(t))}))}zoomCamera(t,e,i){this.camera.zoomTo(t,1e3,"Power2",!0,((t,n)=>{1===n&&(null==i||i(),this.completeAction(e))}))}changeCharacterState(t,e,i,n){t.setCharacterState(e),null==n||n(),this.completeAction(i)}moveCharacterTo(t,e,i,n){t.setTargetGrids(e),t.moveToGrid(e,i),this.scene.time.addEvent({delay:100,callback:()=>{t.hasReachedTarget()&&(console.log("Character has reached the target!"),t.updateOccupiedGrids(),n&&n(),this.completeAction(i),this.scene.time.removeAllEvents())},loop:!0})}changeCharacterAppearance(t,e,i,n){t.setTexture(e),null==n||n(),this.completeAction(i)}playCharacterAnimation(t,e,i){t.play(e),t.once("animationcomplete",(()=>{null==i||i(),this.completeAction()}))}displayPopup(t,e,i,n){const r=this.scene.add.text(e,i,t,{fontSize:"24px",backgroundColor:"#000000",color:"#ffffff",padding:{x:10,y:10},align:"center"}).setOrigin(.5,.5).setDepth(999);this.scene.time.delayedCall(3e3,(()=>{r.destroy(),null==n||n(),this.completeAction()}))}updateStoryWindow(t,e){console.log("Updating story window:",t),null==e||e(),this.completeAction()}triggerInkEvent(t,e){console.log("Triggering Ink event:",t),null==e||e(),this.completeAction()}triggerBattle(t){console.log("Starting battle..."),null==t||t(),this.completeAction()}triggerCutscene(t){console.log("Starting cutscene..."),null==t||t(),this.completeAction()}playSoundEffect(t,e){this.scene.sound.play(t),null==e||e(),this.completeAction()}displayDialogue(t,e,i){console.log(`Displaying dialogue for ${e}: ${t}`),null==i||i(),this.completeAction()}completeAction(t){this.isExecuting=!1,this.tryExecuteNextAction(t||0)}isActionPlaying(){return this.isExecuting}}class kt extends i.Scene{constructor(){super("MainGameScene"),e(this,"tile_Layer"),e(this,"rectangle_1"),e(this,"test_castle"),e(this,"character"),e(this,"cursors"),e(this,"grid"),e(this,"cellSize"),e(this,"storyBox",null),e(this,"directionInput",new A),e(this,"collisionChecker"),e(this,"debugGraphics"),e(this,"jsonData"),e(this,"backgroundMusic"),e(this,"controls"),e(this,"characters",[]),e(this,"selectedCharacter",null),e(this,"actionManager"),e(this,"speed"),e(this,"isDragging",!1),e(this,"dragStartX",0),e(this,"dragStartY",0),this.grid=null,this.cellSize=16,this.characters}preload(){this.load.pack("preload-asset-pack","assets/preload-asset-pack.json")}editorCreate(){const t=this.add.tilemap("test_castle");t.addTilesetImage("ShadowtideKeepEntranceMap_test_1","ShadowtideKeepEntranceMap_test_1"),this.add.image(1920,1080,"ShadowtideKeepEntranceMap_test_1");const e=t.createLayer("Tile Layer 1",["ShadowtideKeepEntranceMap_test_1"],0,0),i=this.add.image(1920,1080,"mapgrass1");i.scaleX=2,i.scaleY=2,this.add.image(1920,1080,"fantasy_ship");const n=this.add.text(64,64,"",{});n.text="SHADOWTIDE\nISLAND",n.setStyle({color:"#ceba96ff",fontSize:"185px",fontStyle:"bold",stroke:"#000000ff",strokeThickness:10,"shadow.offsetX":13,"shadow.offsetY":8,"shadow.blur":5,"shadow.fill":!0});const r=this.add.rectangle(528,1296,128,128);r.scaleX=6.9,r.scaleY=12.1,r.isFilled=!0,r.fillAlpha=.38,r.isStroked=!0,r.strokeColor=0,r.strokeAlpha=.42,r.lineWidth=6.65,r.postFX.addShadow(0,0,.1,1,0,6,1);const s=this.add.text(144,640,"",{});s.text='Use the arrow keys to move the camera. \n\nSelect a token then:\n- move with W,A,S,D\n- melee attack with "m"\n\n- remove grid with "g"\n\nClick the story window or hit Enter to "turn the page" and make choices...\n\nKavan will not enjoy this journey at all, so I hope you can enjoy living in his shoes.',s.setStyle({color:"#000000ff",fontSize:"62px",fontStyle:"bold",maxLines:61}),s.setWordWrapWidth(749),this.tile_Layer=e,this.rectangle_1=r,this.test_castle=t,this.events.emit("scene-awake")}create(){var t,e;this.editorCreate();let n=this.game.loop.delta;this.debugGraphics=this.add.graphics({lineStyle:{width:1,color:16711680,alpha:.8},fillStyle:{color:16711680,alpha:.3}}),this.physics.world.setBounds(0,0,3840,2160),this.grid=new P(this,this.cellSize),this.speed=C,this.character=new O(this,5,5,"Warrior_Blue",this.grid),this.characters.push(this.character);const r=new O(this,20,5,"Warrior_Blue",this.grid);this.characters.push(r),this.selectedCharacter=null,this.directionInput.init(),this.test_castle.setCollisionByProperty({collides:!0}),this.cameras.main.setBounds(0,0,3840,2160),this.cursors=this.input.keyboard.createCursorKeys();const s={camera:this.cameras.main,left:this.cursors.left,right:this.cursors.right,up:this.cursors.up,down:this.cursors.down,acceleration:.06,drag:5e-4,maxSpeed:.5};this.controls=new i.Cameras.Controls.SmoothedKeyControl(s),null==(t=this.input.keyboard)||t.on("keydown-G",(()=>{var t;null==(t=this.grid)||t.toggle()})),null==(e=this.input.keyboard)||e.on("keydown-M",(()=>{this.selectedCharacter&&(console.log("Melee attack!"),this.selectedCharacter.attack())})),this.input.on("pointerdown",(t=>{this.handlePointerDown(t)})),this.input.on("wheel",((t,e,n,r,s)=>{if(!this.actionManager.isActionPlaying()){const t=.01,e=i.Math.Clamp(this.cameras.main.zoom-r*t,.5,2),n=new Ot("zoomCamera",{zoom:e});this.actionManager.queueAction(n)}})),this.input.on("pointerdown",(t=>{t.middleButtonDown()&&(this.isDragging=!0,this.dragStartX=t.x,this.dragStartY=t.y)})),this.input.on("pointerup",(t=>{t.middleButtonReleased()&&(this.isDragging=!1)})),this.input.on("pointermove",(t=>{if(this.isDragging){const e=t.x-this.dragStartX,n=t.y-this.dragStartY;this.cameras.main.scrollX-=e,this.cameras.main.scrollY-=n,this.cameras.main.scrollX=i.Math.Clamp(this.cameras.main.scrollX,0,3840-this.cameras.main.width),this.cameras.main.scrollY=i.Math.Clamp(this.cameras.main.scrollY,0,2160-this.cameras.main.height),this.dragStartX=t.x,this.dragStartY=t.y}}));const a=this.cache.json.entries.get("chapter_1.ink");if(a){const t=new xt(a);console.log(t.Continue())}else console.error("Failed to load ink story data");const o=new xt(a);this.displayInkContent(o),this.collisionChecker=new N(this,this.tile_Layer,this.grid),this.character.updateOccupiedGrids(),this.visualizeOccupiedGrids(this.character.getOccupiedGrids(),65280),console.log("Occupied Grids:",this.character.getOccupiedGrids()),this.backgroundMusic=this.sound.add("The_Journey_Begins_110bpm_120s"),this.backgroundMusic.play({loop:!0,volume:.5}),this.actionManager=new Pt(this),this.actionManager.queueAction(new Ot("moveCameraTo",{x:1920,y:1080,zoom:.5})),this.actionManager.queueAction(new Ot("moveCharacterTo",{character:r,targetGrids:[{x:20,y:100}],delta:n}))}displayInkContent(t){var e,i;let n=[];for(t.canContinue&&n.push((null==(e=null==t?void 0:t.Continue())?void 0:e.trim())||"");t.canContinue||t.currentChoices.length>0;)t.canContinue&&n.push((null==(i=null==t?void 0:t.Continue())?void 0:i.trim())||""),t.currentChoices.length>0&&(t.currentChoices.forEach(((t,e)=>{n.push(`${e+1}: ${t.text}`)})),t.ChooseChoiceIndex(0));const r=n.filter((t=>t.length>0));console.log("Story Content:",r.join("\n"));const s={texts:r,style:{fontSize:"40px",backgroundColor:"rgb(199, 147, 99)",textColor:"rgb(24, 18, 12)",padding:"2rem",borderRadius:"2rem",fontFamily:"Copperplate, Papyrus, Playbill, Luminari, Garamond, Georgia, serif"},revealSpeed:30,onComplete:()=>{console.log("Story completed!")}};this.storyBox=new k(this,s),this.storyBox.create()}update(t,e){var i;this.characters.forEach((t=>{t.update(e)})),e=this.game.loop.delta,this.debugGraphics.clear(),this.controls&&this.controls.update(e),this.grid&&this.grid.updateGrid(),null==(i=this.storyBox)||i.update();let n=this.actionManager.isActionPlaying();console.log("Active Scene Playing:",n),this.selectedCharacter?(this.visualizeOccupiedGrids(this.selectedCharacter.getOccupiedGrids(),65280),n||this.handleInput(e),this.selectedCharacter.getIsActing()&&console.log("Character is currently acting.")):(console.log("No character selected."),this.debugGraphics.clear())}handleInput(t){const e=this.directionInput.direction;if(this.selectedCharacter){if(e&&this.selectedCharacter.getCharacterState()===x.IDLE){switch(e){case"up":this.selectedCharacter.moveUp(t);break;case"down":this.selectedCharacter.moveDown(t);break;case"left":this.selectedCharacter.moveLeft(t);break;case"right":this.selectedCharacter.moveRight(t)}const i=this.selectedCharacter.getOccupiedGrids();let n=v(i,e);console.log("Next Occupied Grids:",n);const r=this.collisionChecker.isPositionFree(n);console.log("Can Move:",r),r?(this.selectedCharacter.setTargetGrids(n),this.selectedCharacter.setIsActing(!0)):(console.log("Movement blocked."),this.selectedCharacter.stopMoving())}}else console.log("No character selected.")}triggerSceneChange(){!function(t,e){const{targetScene:i,duration:n=1e3,fadeColor:r=0,callback:s,data:a}=e;t.cameras.main.fadeOut(n,r>>16&255,r>>8&255,255&r),t.cameras.main.once("camerafadeoutcomplete",(()=>{t.scene.start(i,a),s&&s()}))}(this,{targetScene:"NewScene",duration:1500,fadeColor:16711680,callback:()=>console.log("Scene transition completed!")})}updateCameraBounds(t,e,i,n){this.cameras.main.setBounds(t,e,i,n),this.grid&&this.grid.updateGrid()}handlePointerDown(t){const e=t.positionToCamera(this.cameras.main),i=this.characters.find((t=>t.getBounds().contains(e.x,e.y)));i?this.selectCharacter(i):this.selectCharacter(null)}selectCharacter(t){this.selectedCharacter=t,t?console.log("Character selected:",t.texture.key):console.log("No character selected.")}visualizeOccupiedGrids(t,e){this.debugGraphics.fillStyle(e,.3),t.forEach((t=>{this.debugGraphics.fillRect(t.x*this.cellSize,t.y*this.cellSize,this.cellSize,this.cellSize)}))}shutdown(){var t;null==(t=this.storyBox)||t.destroy(),this.storyBox=null}}class At extends i.Scene{constructor(){super("Boot")}preload(){this.load.pack("pack","assets/preload-asset-pack.json")}create(){this.scene.start("MainGameScene")}}window.addEventListener("load",(function(){new i.Game({width:1920,height:1080,backgroundColor:"#2f2f2f",parent:"game-container",scale:{mode:i.Scale.ScaleModes.FIT,autoCenter:i.Scale.Center.CENTER_BOTH},scene:[At,g,p,kt],dom:{createContainer:!0},physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}}}).scene.start("Boot")}));
