var t=Object.defineProperty,e=(e,n,i)=>((e,n,i)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i)(e,"symbol"!=typeof n?n+"":n,i);import{P as n}from"./phaser-CmFXOKba.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const n of t)if("childList"===n.type)for(const t of n.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class i{constructor(t){e(this,"gameObject"),e(this,"target","GAME_OBJECT"),e(this,"targetName",""),this.gameObject=t,t.__ActionTargetComp=this}static getComponent(t){return t.__ActionTargetComp}static getTargetGameObject(t,e){const n=i.getComponent(t);if(n)switch(n.target){case"GAME_OBJECT":return t.gameObject;case"ARG_1":return e[0];case"ARG_2":return e[1];case"ARG_3":return e[2];case"ARG_4":return e[3];case"ARG_5":return e[4];case"ARG_6":return e[5];case"ARG_7":return e[6];case"ARG_8":return e[7]}return t.gameObject}}class r{constructor(t){e(this,"_scene"),e(this,"_gameObject"),e(this,"_parent"),e(this,"_children"),this._parent=t,t instanceof r?(this._scene=t.scene,this._gameObject=t.gameObject,t.add(this)):t instanceof n.GameObjects.GameObject?(this._scene=t.scene,this._gameObject=t):this._scene=t;const i=this.awake!==r.prototype.awake,s=this.start!==r.prototype.start,a=this.update!==r.prototype.update,o=this.destroy!==r.prototype.destroy;if(i&&this.scene.events.once("scene-awake",this.awake,this),s&&this.scene.events.once(n.Scenes.Events.UPDATE,this.start,this),a&&this.scene.events.on(n.Scenes.Events.UPDATE,this.update,this),i||s||a||o){const t=()=>{this.scene.events.off("scene-awake",this.awake,this),this.scene.events.off(n.Scenes.Events.UPDATE,this.start,this),this.scene.events.off(n.Scenes.Events.UPDATE,this.update,this),o&&this.destroy()};this.gameObject?this.gameObject.on(n.GameObjects.Events.DESTROY,t):this.scene.events.on(n.Scenes.Events.SHUTDOWN,t)}}getActionTargetObject(t){return i.getTargetGameObject(this,t)}get scene(){return this._scene}get gameObject(){return this._gameObject}get parent(){return this._parent}get children(){return this._children||(this._children=[]),this._children}add(t){this.children.push(t)}executeChildren(...t){if(this._children)for(const e of this._children)e.execute(...t)}execute(...t){}awake(){}start(){}update(){}destroy(){}}class s extends r{constructor(t){super(t),this.scene.events.once("scene-awake",(()=>{this.executeChildren()}))}}class a extends r{constructor(t){super(t),e(this,"eventName",""),e(this,"eventEmitter","gameObject"),e(this,"once",!1)}awake(){let t;switch(this.eventEmitter){case"game.events":t=this.scene.game.events;break;case"scene.events":t=this.scene.events;break;case"scene.loader":t=this.scene.load;break;case"scene.input":t=this.scene.input;break;case"scene.input.keyboard":t=this.scene.input.keyboard;break;case"scene.anims":t=this.scene.anims;break;case"scene.physics.world":t=this.scene.physics.world;break;case"gameObject":t=this.gameObject}if(t){switch(this.once?t.once(this.eventName,this.executeChildren,this):t.on(this.eventName,this.executeChildren,this),this.eventEmitter){case"scene.anims":case"scene.events":case"scene.input":case"scene.input.keyboard":case"scene.loader":case"scene.physics.world":this.scene.events.on(n.Scenes.Events.SHUTDOWN,(()=>{null==t||t.off(this.eventName,this.executeChildren,this)}))}this.gameObject&&"gameObject"!==this.eventEmitter&&this.gameObject.once(n.GameObjects.Events.DESTROY,(()=>{null==t||t.off(this.eventName,this.executeChildren,this)}))}}}class o extends a{constructor(t){super(t),this.eventName="pointerdown"}awake(){this.gameObject&&(this.gameObject.input||this.gameObject.setInteractive(),super.awake())}}class l{constructor(t){e(this,"gameObject"),e(this,"delay",0),this.gameObject=t,t.__DelayConfigComp=this}static getComponent(t){return t.__DelayConfigComp}static getDelay(t,e){const n=l.getComponent(t);return n?n.delay:e}}class h{constructor(t){e(this,"gameObject"),e(this,"duration",250),this.gameObject=t,t.__DurationConfigComp=this}static getComponent(t){return t.__DurationConfigComp}static getDuration(t,e){const n=h.getComponent(t);return n?n.duration:e}}class u{constructor(t){e(this,"gameObject"),e(this,"ease","Linear"),this.gameObject=t,t.__EaseConfigComp=this}static getComponent(t){return t.__EaseConfigComp}static getEase(t,e){const n=u.getComponent(t);return n?n.ease:e}}class c extends r{constructor(t){super(t),e(this,"from","NONE")}execute(...t){const e=this.getActionTargetObject(t),n=h.getDuration(this,250),i=l.getDelay(this,0),r=u.getEase(this,"Expo"),{x:s,y:a}=e;let o=s,c=a;switch(this.from){case"LEFT":o=-e.displayWidth;break;case"RIGHT":o=this.scene.scale.width+e.displayWidth;break;case"TOP":c=-e.displayHeight;break;case"BOTTOM":c=this.scene.scale.height+e.displayHeight}e.setPosition(o,c),this.scene.add.tween({targets:e,x:s,y:a,duration:n,delay:i,ease:r,onComplete:()=>{this.executeChildren()}})}}class d extends r{constructor(t){super(t),e(this,"_executing",!1)}execute(t){if(this._executing)return;this._executing=!0;const e=h.getDuration(this,80),n=this.getActionTargetObject(t),{scaleX:i,scaleY:r}=n;this.scene.add.tween({targets:n,scaleX:.8*i,scaleY:.8*r,duration:e,yoyo:!0,onComplete:()=>{this._executing=!1,this.executeChildren(t)}})}}class p extends n.Scene{constructor(){super("Level")}editorCreate(){const t=this.add.image(640,257,"FufuSuperDino"),e=new o(t);new d(e);const n=new s(t),i=new c(n),r=this.add.text(640,458,"",{});r.setOrigin(.5,.5),r.text="Phaser 3 + Phaser Editor v4\nVite + TypeScript",r.setStyle({align:"center",fontFamily:"Arial",fontSize:"3em"});const a=new s(r),l=new c(a);i.from="TOP",l.from="BOTTOM",this.events.emit("scene-awake")}create(){this.editorCreate()}}class m extends r{constructor(t){super(t)}get gameObject(){return super.gameObject}awake(){const t=this.gameObject.width;this.scene.load.on(n.Loader.Events.PROGRESS,(e=>{this.gameObject.width=t*e}))}}class g extends n.Scene{constructor(){super("Preload")}editorCreate(){const t=this.add.image(505.0120544433594,360,"guapen");t.scaleX=.32715486817515643,t.scaleY=.32715486817515643;const e=this.add.rectangle(553.0120849609375,361,256,20);e.setOrigin(0,0),e.isFilled=!0,e.fillColor=14737632,new m(e);const n=this.add.rectangle(553.0120849609375,361,256,20);n.setOrigin(0,0),n.fillColor=14737632,n.isStroked=!0;const i=this.add.text(552.0120849609375,329,"",{});i.text="Loading...",i.setStyle({color:"#e0e0e0",fontFamily:"arial",fontSize:"20px"}),this.events.emit("scene-awake")}preload(){this.editorCreate(),this.load.pack("asset-pack","assets/asset-pack.json")}create(){this.scene.start("Level")}}function f(t){return 16*t}const y=function(t,e){let n=0,i=0;switch(e){case"up":i=-1;break;case"down":i=1;break;case"left":n=-1;break;case"right":n=1}return t.map((t=>({x:t.x+n,y:t.y+i})))};var S,v,C,b,w,_=(t=>(t[t.IDLE=0]="IDLE",t[t.WALKING=1]="WALKING",t[t.ATTACKING=2]="ATTACKING",t))(_||{});class T extends n.Physics.Arcade.Sprite{constructor(t,n,i,r,s,a){super(t,f(n),f(i),r),e(this,"currentState",0),e(this,"stateData",{}),e(this,"gridSize"),e(this,"occupiedGrids",[]),e(this,"grid"),this.gridSize=s,this.grid=a,t.add.existing(this),t.physics.add.existing(this),this.setOrigin(.5,.5),this.updateOccupiedGrids(),this.initializeAnimations(),this.setupEventListeners()}initializeAnimations(){this.scene.anims.create({key:"idle",frames:this.scene.anims.generateFrameNumbers("Warrior_Blue",{frames:[0,1]}),frameRate:10,repeat:-1}),this.scene.anims.create({key:"walk",frames:this.scene.anims.generateFrameNumbers("Warrior_Blue",{frames:[1,7,6,7]}),frameRate:10,repeat:-1}),this.scene.anims.create({key:"attack",frames:this.scene.anims.generateFrameNumbers("Warrior_Blue",{frames:[12,13,14,15,16,17]}),frameRate:10,repeat:0})}setupEventListeners(){this.on("animationcomplete",(t=>{this.onAnimationComplete(t)}))}setPlayerState(t,e={}){this.currentState=t,this.stateData=e,this.updateAnimation()}getCurrentState(){return this.currentState}getGridSize(){return this.gridSize}updateAnimation(){switch(this.currentState){case 0:this.play("idle",!0);break;case 1:this.play("walk",!0);break;case 2:this.play("attack",!0)}}updateOccupiedGrids(){const t=[],e=Math.floor(this.x/16),n=Math.floor(this.y/16),i=Math.floor(4),r=Math.floor(4);for(let s=0;s<8;s++)for(let a=0;a<8;a++)t.push({x:e-i+a,y:n-r+s});this.occupiedGrids=t}getOccupiedGrids(){return this.updateOccupiedGrids(),this.occupiedGrids}update(t,e){switch(this.currentState){case 0:break;case 1:const{direction:t}=this.stateData,{x:e,y:n}=this.grid.getNextPosition(this.x,this.y,t);this.setPosition(e,n),this.updateOccupiedGrids(),this.setPlayerState(0);break;case 2:this.setVelocity(0,0)}}onAnimationComplete(t){"attack"===t.key&&this.setPlayerState(0)}moveUp(){this.setPlayerState(1,{direction:"up"})}moveDown(){this.setPlayerState(1,{direction:"down"})}moveLeft(){this.setPlayerState(1,{direction:"left"}),this.setFlipX(!0)}moveRight(){this.setPlayerState(1,{direction:"right"}),this.setFlipX(!1)}stopMoving(){this.setPlayerState(0)}attack(){this.setPlayerState(2)}}class E{constructor(t,n=16){e(this,"scene"),e(this,"cellSize"),e(this,"graphics"),e(this,"visible"),this.scene=t,this.cellSize=n,this.graphics=t.add.graphics(),this.visible=!0,this.draw(),this.scene.cameras.main.on("cameramove",this.updateGrid,this)}draw(){this.graphics.clear();const t=this.scene.physics.world.bounds;this.graphics.lineStyle(1,16777215,.5);const e=t.left,n=t.top,i=t.right,r=t.bottom;for(let s=e;s<=i;s+=this.cellSize)this.graphics.moveTo(s,n),this.graphics.lineTo(s,r);for(let s=n;s<=r;s+=this.cellSize)this.graphics.moveTo(e,s),this.graphics.lineTo(i,s);this.graphics.strokePath()}getNextPosition(t,e,n){let i=Math.floor(t/this.cellSize),r=Math.floor(e/this.cellSize);switch(n){case"up":r-=1;break;case"down":r+=1;break;case"left":i-=1;break;case"right":i+=1}return{x:i,y:r}}toggle(){this.visible=!this.visible,this.graphics.setVisible(this.visible)}show(){this.visible=!0,this.graphics.setVisible(!0)}hide(){this.visible=!1,this.graphics.setVisible(!1)}updateGrid(){this.visible&&this.draw()}destroy(){this.scene.cameras.main.off("cameramove",this.updateGrid,this),this.graphics.destroy()}getCellSize(){return this.cellSize}}class O{constructor(t,n){e(this,"scene"),e(this,"config"),e(this,"element"),e(this,"currentTextIndex"),e(this,"isRevealing"),e(this,"accumulatedText"),e(this,"characterLimit"),e(this,"onComplete"),this.scene=t,this.currentTextIndex=0,this.isRevealing=!1,this.element=null,this.accumulatedText="WELCOME TO SHADOWTIDE ISLAND.... almost!",this.characterLimit=300,this.config={...n,style:{fontSize:"48px",backgroundColor:"rgb(209, 172, 104)",textColor:"rgb(24, 20, 12)",padding:"2rem",borderRadius:"1rem",fontFamily:"Garamond, serif",transition:"all 1s ease-in-out",border:"1rem solid rgba(24, 20, 12, 0.5)",fontWeight:"bold",marginBottom:"2rem",height:"200px",overflow:"hidden",...n.style||{}},revealSpeed:n.revealSpeed||30}}create(){var t,e,n,i,r,s,a,o,l,h,u;const{width:c,height:d}=this.scene.cameras.main,p=`\n      background-color: ${null==(t=this.config.style)?void 0:t.backgroundColor}; \n      color: ${null==(e=this.config.style)?void 0:e.textColor}; \n      padding: ${null==(n=this.config.style)?void 0:n.padding}; \n      border-radius: ${null==(i=this.config.style)?void 0:i.borderRadius}; \n      font: ${null==(r=this.config.style)?void 0:r.fontWeight} ${null==(s=this.config.style)?void 0:s.fontSize} ${null==(a=this.config.style)?void 0:a.fontFamily}; \n      border: ${null==(o=this.config.style)?void 0:o.border}; \n      transition: ${null==(l=this.config.style)?void 0:l.transition};\n      width: 80%; \n      height: ${null==(h=this.config.style)?void 0:h.height}; \n      overflow: ${null==(u=this.config.style)?void 0:u.overflow};\n    `;this.element=this.scene.add.dom(c/2,d-150,"div",p,this.accumulatedText),this.element.setScrollFactor(0),this.element.addListener("click"),this.element.on("click",(()=>this.nextText())),this.scene.input.keyboard&&this.scene.input.keyboard.on("keydown-ENTER",(()=>this.nextText())),this.scene.events.emit("storyBoxTextStart",this.currentTextIndex)}nextText(){if(this.isRevealing)this.revealFullText();else if(this.currentTextIndex<this.config.texts.length){const t=this.getNextTextChunk(this.config.texts[this.currentTextIndex]);this.clearContent(),this.accumulatedText=t,this.revealText(this.accumulatedText),t.length<this.characterLimit&&this.currentTextIndex++}else this.destroy(),this.config.onComplete&&this.config.onComplete(),this.scene.events.emit("storyBoxComplete")}getNextTextChunk(t){if(t.length<=this.characterLimit)return t;{const e=this.findSuitableBreakPoint(t,this.characterLimit),n=t.slice(0,e),i=t.slice(e).trim();return this.config.texts[this.currentTextIndex]=`...${i}`,`${n}...`}}findSuitableBreakPoint(t,e){const n=[".","!","?",","," "];let i=t.lastIndexOf(" ",e);-1===i&&(i=e);for(const r of n){const n=t.lastIndexOf(r,e);n>i&&(i=n)}return i+1}revealText(t){if(this.element){this.isRevealing=!0;let e="";const n=setInterval((()=>{var i;e.length<t.length?(e+=t[e.length],null==(i=this.element)||i.setHTML(e)):(clearInterval(n),this.isRevealing=!1,this.scene.events.emit("storyBoxTextComplete",this.currentTextIndex))}),this.config.revealSpeed)}}revealFullText(){this.element&&(this.element.setHTML(this.accumulatedText),this.isRevealing=!1,this.scene.events.emit("storyBoxTextComplete",this.currentTextIndex))}clearContent(){this.element&&this.element.setHTML("")}destroy(){this.element&&(this.element.removeListener("click"),this.element.destroy()),this.scene.input.keyboard&&this.scene.input.keyboard.off("keydown-ENTER")}update(){if(this.element){const{width:t,height:e}=this.scene.cameras.main;this.element.x=t/2,this.element.y=e-150}}}class x{constructor(){e(this,"heldDirections",[]),e(this,"map",{KeyW:"up",KeyS:"down",KeyA:"left",KeyD:"right"})}get direction(){return this.heldDirections[0]}init(){document.addEventListener("keydown",(t=>{const e=this.map[t.code];e&&-1===this.heldDirections.indexOf(e)&&(this.heldDirections.unshift(e),console.log(this.heldDirections))})),document.addEventListener("keyup",(t=>{const e=this.map[t.code],n=this.heldDirections.indexOf(e);n>-1&&(this.heldDirections.splice(n,1),console.log(this.heldDirections))}))}}class P{constructor(t,n,i){e(this,"scene"),e(this,"collisionLayer"),e(this,"gridSize"),this.scene=t,this.collisionLayer=n,this.gridSize=i.getCellSize()}isPositionFree(t){return!t.some((t=>{const e=t.x*this.gridSize,n=t.y*this.gridSize,i=this.collisionLayer.getTileAtWorldXY(e,n);return i&&i.properties.collides}))}}class N{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof N.Component&&arguments[1]instanceof N){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let t=this._components.slice(1,this._components.length);return new N(t)}return N.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let t=new N;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(t){let e=new N,n=0;for(let i=0;i<t._components.length&&t._components[i].isParent;++i)n++;for(let i=0;i<this._components.length-n;++i)e._components.push(this._components[i]);for(let i=n;i<t._components.length;++i)e._components.push(t._components[i]);return e}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,null==this._componentsString||""==this._componentsString)return;"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let e=this._componentsString.split(".");for(let n of e)/^(\-|\+)?([0-9]+|Infinity)$/.test(n)?this._components.push(new N.Component(parseInt(n))):this._components.push(new N.Component(n))}toString(){return this.componentsString}Equals(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(let e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(t){let e=new N;return e._components.push(...this._components),e._components.push(t),e}}function k(t,e){return t instanceof e?V(t):null}function A(t,e){if(t instanceof e)return V(t);throw new Error(`${t} is not of type ${e}`)}function I(t){return t.hasValidName&&t.name?t:null}function F(t){return void 0===t?null:t}function W(t){return"object"==typeof t&&"function"==typeof t.Equals}function V(t,e){return t}N.parentId="^",function(t){class e{constructor(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}get isIndex(){return this.index>=0}get isParent(){return this.name==t.parentId}static ToParent(){return new e(t.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}t.Component=e}(N||(N={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}t.AssertType=function(t,n,i){e(t instanceof n,i)},t.Assert=e}(S||(S={}));class L extends Error{}function D(t){throw new L(`${t} is null or undefined`)}class j{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(null===t)return null;let e=this.rootContentContainer;if(e){let n=e.ContentAtPath(t).obj;if(n){let t=n.debugMetadata;if(null!==t)return t.startLineNumber}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new N;else{let t=[],e=this,n=k(e.parent,tt);for(;null!==n;){let i=I(e);if(null!=i&&i.hasValidName){if(null===i.name)return D("namedChild.name");t.unshift(new N.Component(i.name))}else t.unshift(new N.Component(n.content.indexOf(e)));e=n,n=k(n.parent,tt)}this._path=new N(t)}return this._path}ResolvePath(t){if(null===t)return D("path");if(t.isRelative){let e=k(this,tt);return null===e&&(S.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=k(this.parent,tt),S.Assert(null!==e,"Expected parent to be a container"),S.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?D("nearestContainer"):e.ContentAtPath(t)}{let e=this.rootContentContainer;return null===e?D("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(t){let e=this.path,n=Math.min(t.length,e.length),i=-1;for(let a=0;a<n;++a){let n=e.GetComponent(a),r=t.GetComponent(a);if(!n.Equals(r))break;i=a}if(-1==i)return t;let r=e.componentCount-1-i,s=[];for(let a=0;a<r;++a)s.push(N.Component.ToParent());for(let a=i+1;a<t.componentCount;++a)s.push(t.GetComponent(a));return new N(s,!0)}CompactPathString(t){let e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return k(t,tt)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}Equals(t){return t===this}}class R{constructor(t){t=void 0!==t?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){null!==t&&(this.string+=t)}AppendLine(t){void 0!==t&&this.Append(t),this.string+="\n"}AppendFormat(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,((t,e)=>void 0!==n[e]?n[e]:t))}toString(){return this.string}Clear(){this.string=""}}class G{constructor(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new G(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof G){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new G(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!G.isLikeInkListItem(e))return G.Null;let n=e;return new G(n.originName,n.itemName)}static isLikeInkListItem(t){return!("object"!=typeof t||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}}class B extends Map{constructor(){if(super(arguments[0]instanceof B?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof B){let t=arguments[0],e=t.originNames;null!==e&&(this._originNames=e.slice()),null!==t.origins&&(this.origins=t.origins.slice())}else if("string"==typeof arguments[0]){let t=arguments[0],e=arguments[1];if(this.SetInitialOriginName(t),null===e.listDefinitions)return D("originStory.listDefinitions");let n=e.listDefinitions.TryListGetDefinition(t,null);if(!n.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);if(null===n.result)return D("def.result");this.origins=[n.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}static FromString(t,e){var n;if(null==t||""==t)return new B;let i=null===(n=e.listDefinitions)||void 0===n?void 0:n.FindSingleItemListWithName(t);if(i)return null===i.value?D("listValue.value"):new B(i.value);throw new Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}AddItem(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(t instanceof G){let e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return D("this.origins");for(let t of this.origins)if(t.name==e.originName){let n=t.TryGetValueForItem(e,0);if(n.exists)return void this.Add(e,n.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}if(null!==t){let n=t,i=null;if(null===this.origins)return D("this.origins");for(let t of this.origins){if(null===n)return D("itemName");if(t.ContainsItemWithName(n)){if(null!=i)throw new Error("Could not add the item "+n+" to this list because it could come from either "+t.name+" or "+i.name);i=t}}if(null==i){if(null==e)throw new Error("Could not add the item "+n+" to this list because it isn't known to any list definitions previously associated with this list.");{let t=B.FromString(n,e).orderedItems[0];this.Add(t.Key,t.Value)}}else{let t=new G(i.name,n),e=i.ValueForItem(t);this.Add(t,e)}}}ContainsItemNamed(t){for(let[e]of this)if(G.fromSerializedKey(e).itemName==t)return!0;return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let n=t.serialized();if(this.has(n))throw new Error(`The Map already contains an entry for ${t}`);this.set(n,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every((n=>n.name!=t||(e=n,!1))),e}get originNames(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=G.fromSerializedKey(t);if(null===e.originName)return D("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=null==t?null:t.slice()}get maxItem(){let t={Key:G.Null,Value:0};for(let[e,n]of this){let i=G.fromSerializedKey(e);(t.Key.isNull||n>t.Value)&&(t={Key:i,Value:n})}return t}get minItem(){let t={Key:G.Null,Value:0};for(let[e,n]of this){let i=G.fromSerializedKey(e);(t.Key.isNull||n<t.Value)&&(t={Key:i,Value:n})}return t}get inverse(){let t=new B;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=G.fromSerializedKey(n);this.ContainsKey(e)||t.Add(e,i)}return t}get all(){let t=new B;if(null!=this.origins)for(let e of this.origins)for(let[n,i]of e.items){let e=G.fromSerializedKey(n);t.set(e.serialized(),i)}return t}Union(t){let e=new B(this);for(let[n,i]of t)e.set(n,i);return e}Intersect(t){let e=new B;for(let[n,i]of this)t.has(n)&&e.set(n,i);return e}HasIntersection(t){for(let[e]of this)if(t.has(e))return!0;return!1}Without(t){let e=new B(this);for(let[n]of t)e.delete(n);return e}Contains(t){if("string"==typeof t)return this.ContainsItemNamed(t);const e=t;if(0==e.size||0==this.size)return!1;for(let[n]of e)if(!this.has(n))return!1;return!0}GreaterThan(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new B(this.maxItem):new B}MinAsList(){return this.Count>0?new B(this.minItem):new B}ListWithSubRange(t,e){if(0==this.Count)return new B;let n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof B&&t.Count>0&&(i=t.minItem.Value),Number.isInteger(e)?r=e:e instanceof B&&e.Count>0&&(r=e.maxItem.Value);let s=new B;s.SetInitialOriginNames(this.originNames);for(let a of n)a.Value>=i&&a.Value<=r&&s.Add(a.Key,a.Value);return s}Equals(t){if(t instanceof B==0)return!1;if(t.Count!=this.Count)return!1;for(let[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,n]of this){let i=G.fromSerializedKey(e);t.push({Key:i,Value:n})}return t.sort(((t,e)=>null===t.Key.originName?D("x.Key.originName"):null===e.Key.originName?D("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0)),t}get singleItem(){for(let t of this.orderedItems)return t.Key;return null}toString(){let t=this.orderedItems,e=new R;for(let n=0;n<t.length;n++){n>0&&e.Append(", ");let i=t[n].Key;if(null===i.itemName)return D("item.itemName");e.Append(i.itemName)}return e.toString()}valueOf(){return NaN}}class M extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}}function z(t,e,n){if(null===t)return{result:n,exists:!1};let i=t.get(e);return void 0===i?{result:n,exists:!1}:{result:i,exists:!0}}class J extends j{static Create(t,e){if(e){if(e===v.Int&&Number.isInteger(Number(t)))return new q(Number(t));if(e===v.Float&&!isNaN(t))return new H(Number(t))}return"boolean"==typeof t?new U(Boolean(t)):"string"==typeof t?new $(String(t)):Number.isInteger(Number(t))?new q(Number(t)):isNaN(t)?t instanceof N?new X(A(t,N)):t instanceof B?new Q(A(t,B)):null:new H(Number(t))}Copy(){return A(J.Create(this.valueObject),j)}BadCastException(t){return new M("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}class K extends J{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return null===this.value?D("Value.value"):this.value.toString()}}class U extends K{constructor(t){super(t||!1)}get isTruthy(){return Boolean(this.value)}get valueType(){return v.Bool}Cast(t){if(null===this.value)return D("Value.value");if(t==this.valueType)return this;if(t==v.Int)return new q(this.value?1:0);if(t==v.Float)return new H(this.value?1:0);if(t==v.String)return new $(this.value?"true":"false");throw this.BadCastException(t)}toString(){return this.value?"true":"false"}}class q extends K{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return v.Int}Cast(t){if(null===this.value)return D("Value.value");if(t==this.valueType)return this;if(t==v.Bool)return new U(0!==this.value);if(t==v.Float)return new H(this.value);if(t==v.String)return new $(""+this.value);throw this.BadCastException(t)}}class H extends K{constructor(t){super(t||0)}get isTruthy(){return 0!=this.value}get valueType(){return v.Float}Cast(t){if(null===this.value)return D("Value.value");if(t==this.valueType)return this;if(t==v.Bool)return new U(0!==this.value);if(t==v.Int)return new q(this.value);if(t==v.String)return new $(""+this.value);throw this.BadCastException(t)}}class $ extends K{constructor(t){if(super(t||""),this._isNewline="\n"==this.value,this._isInlineWhitespace=!0,null===this.value)return D("Value.value");this.value.length>0&&this.value.split("").every((t=>" "==t||"\t"==t||(this._isInlineWhitespace=!1,!1)))}get valueType(){return v.String}get isTruthy(){return null===this.value?D("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==v.Int){let e=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseInt(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new q(e.result);throw this.BadCastException(t)}if(t==v.Float){let e=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseFloat(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new H(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}class X extends K{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:null)}get valueType(){return v.DivertTarget}get targetPath(){return null===this.value?D("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class Y extends K{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return null===this.value?D("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return v.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new Y(this.variableName,this.contextIndex)}}class Q extends K{get isTruthy(){return null===this.value?D("this.value"):this.value.Count>0}get valueType(){return v.List}Cast(t){if(null===this.value)return D("Value.value");if(t==v.Int){let t=this.value.maxItem;return t.Key.isNull?new q(0):new q(t.Value)}if(t==v.Float){let t=this.value.maxItem;return t.Key.isNull?new H(0):new H(t.Value)}if(t==v.String){let t=this.value.maxItem;return t.Key.isNull?new $(""):new $(t.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof B?this.value=new B(t):t instanceof G&&"number"==typeof e&&(this.value=new B({Key:t,Value:e})):this.value=new B}static RetainListOriginsForAssignment(t,e){let n=k(t,Q),i=k(e,Q);return i&&null===i.value?D("newList.value"):n&&null===n.value?D("oldList.value"):void(n&&i&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames))}}(w=v||(v={}))[w.Bool=-1]="Bool",w[w.Int=0]="Int",w[w.Float=1]="Float",w[w.List=2]="List",w[w.String=3]="String",w[w.DivertTarget=4]="DivertTarget",w[w.VariablePointer=5]="VariablePointer";class Z{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof tt?this.obj:null}copy(){let t=new Z;return t.obj=this.obj,t.approximate=this.approximate,t}}class tt extends j{constructor(){super(...arguments),this.name=null,this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,n]of this.namedContent){let i=A(n,j);t.set(e,i)}for(let e of this.content){let n=I(e);null!=n&&n.hasValidName&&t.delete(n.name)}return 0==t.size&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(null!=e)for(let[n]of e)this.namedContent.delete(n);if(null!=t)for(let[,n]of t){let t=I(n);null!=t&&this.AddToNamedContentOnly(t)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=tt.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=tt.CountFlags.Turns),this.countingAtStartOnly&&(t|=tt.CountFlags.CountStartOnly),t==tt.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&tt.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&tt.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&tt.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],e=this;for(;e instanceof tt;)e.content.length>0&&(t.push(new N.Component(0)),e=e.content[0]);return new N(t)}AddContent(t){if(t instanceof Array){let e=t;for(let t of e)this.AddContent(t)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=I(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){if(S.AssertType(t,j,"Can only add Runtime.Objects to a Runtime.Container"),A(t,j).parent=this,null===t.name)return D("namedContentObj.name");this.namedContent.set(t.name,t)}ContentAtPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;-1==n&&(n=t.length);let i=new Z;i.approximate=!1;let r=this,s=this;for(let a=e;a<n;++a){let e=t.GetComponent(a);if(null==r){i.approximate=!0;break}let o=r.ContentWithPathComponent(e);if(null==o){i.approximate=!0;break}const l=k(o,tt);if(a<n-1&&null==l){i.approximate=!0;break}s=o,r=l}return i.obj=s,i}InsertContent(t,e){if(this.content.splice(e,0,t),t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content.push(...t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(null===t.name)return D("component.name");let e=z(this.namedContent,t.name,null);return e.exists?A(e.result,j):null}}BuildStringOfHierarchy(){let t;if(0==arguments.length)return t=new R,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let e=arguments[1],n=arguments[2];function i(){for(let n=0;n<4*e;++n)t.Append(" ")}i(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==n&&t.Append("  <---"),t.AppendLine(),e++;for(let s=0;s<this.content.length;++s){let r=this.content[s];r instanceof tt?r.BuildStringOfHierarchy(t,e,n):(i(),r instanceof $?(t.Append('"'),t.Append(r.toString().replace("\n","\\n")),t.Append('"')):t.Append(r.toString())),s!=this.content.length-1&&t.Append(","),r instanceof tt||r!=n||t.Append("  <---"),t.AppendLine()}let r=new Map;for(let[s,a]of this.namedContent)this.content.indexOf(A(a,j))>=0||r.set(s,a);if(r.size>0){i(),t.AppendLine("-- named: --");for(let[,i]of r)S.AssertType(i,tt,"Can only print out named Containers"),i.BuildStringOfHierarchy(t,e,n),t.AppendLine()}e--,i(),t.Append("]")}}!function(t){var e;(e=t.CountFlags||(t.CountFlags={}))[e.Start=0]="Start",e[e.Visits=1]="Visits",e[e.Turns=2]="Turns",e[e.CountStartOnly=4]="CountStartOnly"}(tt||(tt={}));class et extends j{toString(){return"Glue"}}class nt extends j{get commandType(){return this._commandType}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nt.CommandType.NotSet;super(),this._commandType=t}Copy(){return new nt(this.commandType)}static EvalStart(){return new nt(nt.CommandType.EvalStart)}static EvalOutput(){return new nt(nt.CommandType.EvalOutput)}static EvalEnd(){return new nt(nt.CommandType.EvalEnd)}static Duplicate(){return new nt(nt.CommandType.Duplicate)}static PopEvaluatedValue(){return new nt(nt.CommandType.PopEvaluatedValue)}static PopFunction(){return new nt(nt.CommandType.PopFunction)}static PopTunnel(){return new nt(nt.CommandType.PopTunnel)}static BeginString(){return new nt(nt.CommandType.BeginString)}static EndString(){return new nt(nt.CommandType.EndString)}static NoOp(){return new nt(nt.CommandType.NoOp)}static ChoiceCount(){return new nt(nt.CommandType.ChoiceCount)}static Turns(){return new nt(nt.CommandType.Turns)}static TurnsSince(){return new nt(nt.CommandType.TurnsSince)}static ReadCount(){return new nt(nt.CommandType.ReadCount)}static Random(){return new nt(nt.CommandType.Random)}static SeedRandom(){return new nt(nt.CommandType.SeedRandom)}static VisitIndex(){return new nt(nt.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new nt(nt.CommandType.SequenceShuffleIndex)}static StartThread(){return new nt(nt.CommandType.StartThread)}static Done(){return new nt(nt.CommandType.Done)}static End(){return new nt(nt.CommandType.End)}static ListFromInt(){return new nt(nt.CommandType.ListFromInt)}static ListRange(){return new nt(nt.CommandType.ListRange)}static ListRandom(){return new nt(nt.CommandType.ListRandom)}static BeginTag(){return new nt(nt.CommandType.BeginTag)}static EndTag(){return new nt(nt.CommandType.EndTag)}toString(){return"ControlCommand "+this.commandType.toString()}}!function(t){var e;(e=t.CommandType||(t.CommandType={}))[e.NotSet=-1]="NotSet",e[e.EvalStart=0]="EvalStart",e[e.EvalOutput=1]="EvalOutput",e[e.EvalEnd=2]="EvalEnd",e[e.Duplicate=3]="Duplicate",e[e.PopEvaluatedValue=4]="PopEvaluatedValue",e[e.PopFunction=5]="PopFunction",e[e.PopTunnel=6]="PopTunnel",e[e.BeginString=7]="BeginString",e[e.EndString=8]="EndString",e[e.NoOp=9]="NoOp",e[e.ChoiceCount=10]="ChoiceCount",e[e.Turns=11]="Turns",e[e.TurnsSince=12]="TurnsSince",e[e.ReadCount=13]="ReadCount",e[e.Random=14]="Random",e[e.SeedRandom=15]="SeedRandom",e[e.VisitIndex=16]="VisitIndex",e[e.SequenceShuffleIndex=17]="SequenceShuffleIndex",e[e.StartThread=18]="StartThread",e[e.Done=19]="Done",e[e.End=20]="End",e[e.ListFromInt=21]="ListFromInt",e[e.ListRange=22]="ListRange",e[e.ListRandom=23]="ListRandom",e[e.BeginTag=24]="BeginTag",e[e.EndTag=25]="EndTag",e[e.TOTAL_VALUES=26]="TOTAL_VALUES"}(nt||(nt={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(C||(C={}));class it{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new N.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new it(this.container,this.index)}static StartOf(t){return new it(t,0)}static get Null(){return new it(null,-1)}}class rt extends j{get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=it.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return D("this._targetPath");if(null===this._targetPath.lastComponent)return D("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return D("targetObj");this._targetPointer.container=t.parent instanceof tt?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=it.StartOf(t instanceof tt?t:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=null==t?null:new N(t)}get hasVariableTarget(){return null!=this.variableDivertName}constructor(t){super(),this._targetPath=null,this._targetPointer=it.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,void 0!==t&&(this.pushesToStack=!0,this.stackPushType=t)}Equals(t){let e=t;return e instanceof rt&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:null===this.targetPath?D("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";{let t=new R,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==C.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}}class st extends j{constructor(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return null===this._pathOnChoice?D("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?D("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new N(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){return null===this.pathOnChoice?D("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}class at extends j{get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=null===t?null:new N(t)}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;super(),this.pathForCount=null,this.name=t}toString(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}class ot extends j{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}class lt extends j{toString(){return"Void"}}class ht extends j{static CallWithName(t){return new ht(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return null===this._name?D("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(null===ht._nativeFunctions?D("NativeFunctionCall._nativeFunctions"):this._prototype=ht._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let r of t){if(r instanceof lt)throw new M("Attempting to perform "+this.name+' on a void value. Did you forget to "return" a value from a function you called here?');r instanceof Q&&(e=!0)}if(2==t.length&&e)return this.CallBinaryListOperation(t);let n=this.CoerceValuesToSingleType(t),i=n[0].valueType;return i==v.Int||i==v.Float||i==v.String||i==v.DivertTarget||i==v.List?this.CallType(n):null}CallType(t){let e=A(t[0],K),n=e.valueType,i=e,r=t.length;if(2==r||1==r){if(null===this._operationFuncs)return D("NativeFunctionCall._operationFuncs");let s=this._operationFuncs.get(n);if(!s){const t=v[n];throw new M("Cannot perform operation "+this.name+" on "+t)}if(2==r){let e=A(t[1],K),n=s;if(null===i.value||null===e.value)return D("NativeFunctionCall.Call BinaryOp values");let r=n(i.value,e.value);return K.Create(r)}{let t=s;if(null===i.value)return D("NativeFunctionCall.Call UnaryOp value");let n=t(i.value);return this.name===ht.Int?K.Create(n,v.Int):this.name===ht.Float?K.Create(n,v.Float):K.Create(n,e.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof Q&&t[1]instanceof q)return this.CallListIncrementOperation(t);let e=A(t[0],K),n=A(t[1],K);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==v.List&&n.valueType==v.List)){if(null===this._operationFuncs)return D("NativeFunctionCall._operationFuncs");let t=this._operationFuncs.get(v.Int);if(null===t)return D("NativeFunctionCall.CallBinaryListOperation op");let i=function(t){if("boolean"==typeof t)return t;throw new Error(`${t} is not a boolean`)}(t(e.isTruthy?1:0,n.isTruthy?1:0));return new U(i)}if(e.valueType==v.List&&n.valueType==v.List)return this.CallType([e,n]);throw new M("Can not call use "+this.name+" operation on "+v[e.valueType]+" and "+v[n.valueType])}CallListIncrementOperation(t){let e=A(t[0],Q),n=A(t[1],q),i=new B;if(null===e.value)return D("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[r,s]of e.value){let t=G.fromSerializedKey(r);if(null===this._operationFuncs)return D("NativeFunctionCall._operationFuncs");let a=this._operationFuncs.get(v.Int);if(null===n.value)return D("NativeFunctionCall.CallListIncrementOperation intVal.value");let o=a(s,n.value),l=null;if(null===e.value.origins)return D("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let n of e.value.origins)if(n.name==t.originName){l=n;break}if(null!=l){let t=l.TryGetItemWithValue(o,G.Null);t.exists&&i.Add(t.result,o)}}return new Q(i)}CoerceValuesToSingleType(t){let e=v.Int,n=null;for(let r of t){let t=A(r,K);t.valueType>e&&(e=t.valueType),t.valueType==v.List&&(n=k(t,Q))}let i=[];if(v[e]==v[v.List])for(let r of t){let t=A(r,K);if(t.valueType==v.List)i.push(t);else{if(t.valueType!=v.Int){const e=v[t.valueType];throw new M("Cannot mix Lists and "+e+" values in this operation")}{let e=parseInt(t.valueObject);if(n=A(n,Q),null===n.value)return D("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let r=n.value.originOfMaxItem;if(null===r)return D("NativeFunctionCall.CoerceValuesToSingleType list");let s=r.TryGetItemWithValue(e,G.Null);if(!s.exists)throw new M("Could not find List item with the value "+e+" in "+r.name);{let t=new Q(s.result,e);i.push(t)}}}}else for(let r of t){let t=A(r,K).Cast(e);i.push(t)}return i}constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)ht.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){let t=arguments[0];ht.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(2===arguments.length){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,((t,e)=>t+e)),this.AddIntBinaryOp(this.Subtract,((t,e)=>t-e)),this.AddIntBinaryOp(this.Multiply,((t,e)=>t*e)),this.AddIntBinaryOp(this.Divide,((t,e)=>Math.floor(t/e))),this.AddIntBinaryOp(this.Mod,((t,e)=>t%e)),this.AddIntUnaryOp(this.Negate,(t=>-t)),this.AddIntBinaryOp(this.Equal,((t,e)=>t==e)),this.AddIntBinaryOp(this.Greater,((t,e)=>t>e)),this.AddIntBinaryOp(this.Less,((t,e)=>t<e)),this.AddIntBinaryOp(this.GreaterThanOrEquals,((t,e)=>t>=e)),this.AddIntBinaryOp(this.LessThanOrEquals,((t,e)=>t<=e)),this.AddIntBinaryOp(this.NotEquals,((t,e)=>t!=e)),this.AddIntUnaryOp(this.Not,(t=>0==t)),this.AddIntBinaryOp(this.And,((t,e)=>0!=t&&0!=e)),this.AddIntBinaryOp(this.Or,((t,e)=>0!=t||0!=e)),this.AddIntBinaryOp(this.Max,((t,e)=>Math.max(t,e))),this.AddIntBinaryOp(this.Min,((t,e)=>Math.min(t,e))),this.AddIntBinaryOp(this.Pow,((t,e)=>Math.pow(t,e))),this.AddIntUnaryOp(this.Floor,ht.Identity),this.AddIntUnaryOp(this.Ceiling,ht.Identity),this.AddIntUnaryOp(this.Int,ht.Identity),this.AddIntUnaryOp(this.Float,(t=>t)),this.AddFloatBinaryOp(this.Add,((t,e)=>t+e)),this.AddFloatBinaryOp(this.Subtract,((t,e)=>t-e)),this.AddFloatBinaryOp(this.Multiply,((t,e)=>t*e)),this.AddFloatBinaryOp(this.Divide,((t,e)=>t/e)),this.AddFloatBinaryOp(this.Mod,((t,e)=>t%e)),this.AddFloatUnaryOp(this.Negate,(t=>-t)),this.AddFloatBinaryOp(this.Equal,((t,e)=>t==e)),this.AddFloatBinaryOp(this.Greater,((t,e)=>t>e)),this.AddFloatBinaryOp(this.Less,((t,e)=>t<e)),this.AddFloatBinaryOp(this.GreaterThanOrEquals,((t,e)=>t>=e)),this.AddFloatBinaryOp(this.LessThanOrEquals,((t,e)=>t<=e)),this.AddFloatBinaryOp(this.NotEquals,((t,e)=>t!=e)),this.AddFloatUnaryOp(this.Not,(t=>0==t)),this.AddFloatBinaryOp(this.And,((t,e)=>0!=t&&0!=e)),this.AddFloatBinaryOp(this.Or,((t,e)=>0!=t||0!=e)),this.AddFloatBinaryOp(this.Max,((t,e)=>Math.max(t,e))),this.AddFloatBinaryOp(this.Min,((t,e)=>Math.min(t,e))),this.AddFloatBinaryOp(this.Pow,((t,e)=>Math.pow(t,e))),this.AddFloatUnaryOp(this.Floor,(t=>Math.floor(t))),this.AddFloatUnaryOp(this.Ceiling,(t=>Math.ceil(t))),this.AddFloatUnaryOp(this.Int,(t=>Math.floor(t))),this.AddFloatUnaryOp(this.Float,ht.Identity),this.AddStringBinaryOp(this.Add,((t,e)=>t+e)),this.AddStringBinaryOp(this.Equal,((t,e)=>t===e)),this.AddStringBinaryOp(this.NotEquals,((t,e)=>!(t===e))),this.AddStringBinaryOp(this.Has,((t,e)=>t.includes(e))),this.AddStringBinaryOp(this.Hasnt,((t,e)=>!t.includes(e))),this.AddListBinaryOp(this.Add,((t,e)=>t.Union(e))),this.AddListBinaryOp(this.Subtract,((t,e)=>t.Without(e))),this.AddListBinaryOp(this.Has,((t,e)=>t.Contains(e))),this.AddListBinaryOp(this.Hasnt,((t,e)=>!t.Contains(e))),this.AddListBinaryOp(this.Intersect,((t,e)=>t.Intersect(e))),this.AddListBinaryOp(this.Equal,((t,e)=>t.Equals(e))),this.AddListBinaryOp(this.Greater,((t,e)=>t.GreaterThan(e))),this.AddListBinaryOp(this.Less,((t,e)=>t.LessThan(e))),this.AddListBinaryOp(this.GreaterThanOrEquals,((t,e)=>t.GreaterThanOrEquals(e))),this.AddListBinaryOp(this.LessThanOrEquals,((t,e)=>t.LessThanOrEquals(e))),this.AddListBinaryOp(this.NotEquals,((t,e)=>!t.Equals(e))),this.AddListBinaryOp(this.And,((t,e)=>t.Count>0&&e.Count>0)),this.AddListBinaryOp(this.Or,((t,e)=>t.Count>0||e.Count>0)),this.AddListUnaryOp(this.Not,(t=>0==t.Count?1:0)),this.AddListUnaryOp(this.Invert,(t=>t.inverse)),this.AddListUnaryOp(this.All,(t=>t.all)),this.AddListUnaryOp(this.ListMin,(t=>t.MinAsList())),this.AddListUnaryOp(this.ListMax,(t=>t.MaxAsList())),this.AddListUnaryOp(this.Count,(t=>t.Count)),this.AddListUnaryOp(this.ValueOfList,(t=>t.maxItem.Value));let t=(t,e)=>t.Equals(e),e=(t,e)=>!t.Equals(e);this.AddOpToNativeFunc(this.Equal,2,v.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,v.DivertTarget,e)}}AddOpFuncForType(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,n,i){if(null===this._nativeFunctions)return D("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new ht(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,v.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,v.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,v.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,v.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,v.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,v.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,v.List,e)}toString(){return'Native "'+this.name+'"'}}ht.Add="+",ht.Subtract="-",ht.Divide="/",ht.Multiply="*",ht.Mod="%",ht.Negate="_",ht.Equal="==",ht.Greater=">",ht.Less="<",ht.GreaterThanOrEquals=">=",ht.LessThanOrEquals="<=",ht.NotEquals="!=",ht.Not="!",ht.And="&&",ht.Or="||",ht.Min="MIN",ht.Max="MAX",ht.Pow="POW",ht.Floor="FLOOR",ht.Ceiling="CEILING",ht.Int="INT",ht.Float="FLOAT",ht.Has="?",ht.Hasnt="!?",ht.Intersect="^",ht.ListMin="LIST_MIN",ht.ListMax="LIST_MAX",ht.All="LIST_ALL",ht.Count="LIST_COUNT",ht.ValueOfList="LIST_VALUE",ht.Invert="LIST_INVERT",ht._nativeFunctions=null;class ut extends j{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}}class ct extends j{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.tags=null,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?D("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(t){this.targetPath=new N(t)}Clone(){let t=new ct;return t.text=this.text,t.sourcePath=this.sourcePath,t.index=this.index,t.targetPath=this.targetPath,t.originalThreadIndex=this.originalThreadIndex,t.isInvisibleDefault=this.isInvisibleDefault,null!==this.threadAtGeneration&&(t.threadAtGeneration=this.threadAtGeneration.Copy()),t}}class dt{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(let[t,e]of this._itemNameToValues){let n=new G(this.name,t);this._items.set(n.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}ContainsItem(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[n,i]of this._itemNameToValues)if(i==t)return{result:new G(this.name,n),exists:!0};return{result:G.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}class pt{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[t,n]of e.items){let e=G.fromSerializedKey(t),i=new Q(e,n);if(!e.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(e.itemName,i),this._allUnambiguousListValueCache.set(e.fullName,i)}}}get lists(){let t=[];for(let[,e]of this._lists)t.push(e);return t}TryListGetDefinition(t,e){if(null===t)return{result:e,exists:!1};let n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(null===t)return D("name");let e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}class mt{static JArrayToRuntimeObjList(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=t.length;e&&n--;let i=[];for(let r=0;r<n;r++){let e=t[r],n=this.JTokenToRuntimeObject(e);if(null===n)return D("runtimeObj");i.push(n)}return i}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WritePropertyStart(n),this.WriteRuntimeObject(t,i),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(let n of e)this.WriteRuntimeObject(t,n);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WriteIntProperty(n,i);t.WriteObjectEnd()}static WriteRuntimeObject(t,e){let n=k(e,tt);if(n)return void this.WriteRuntimeContainer(t,n);let i=k(e,rt);if(i){let e,n="->";return i.isExternal?n="x()":i.pushesToStack&&(i.stackPushType==C.Function?n="f()":i.stackPushType==C.Tunnel&&(n="->t->")),e=i.hasVariableTarget?i.variableDivertName:i.targetPathString,t.WriteObjectStart(),t.WriteProperty(n,e),i.hasVariableTarget&&t.WriteProperty("var",!0),i.isConditional&&t.WriteProperty("c",!0),i.externalArgs>0&&t.WriteIntProperty("exArgs",i.externalArgs),void t.WriteObjectEnd()}let r=k(e,st);if(r)return t.WriteObjectStart(),t.WriteProperty("*",r.pathStringOnChoice),t.WriteIntProperty("flg",r.flags),void t.WriteObjectEnd();let s=k(e,U);if(s)return void t.WriteBool(s.value);let a=k(e,q);if(a)return void t.WriteInt(a.value);let o=k(e,H);if(o)return void t.WriteFloat(o.value);let l=k(e,$);if(l)return void(l.isNewline?t.Write("\n",!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(l.value),t.WriteStringEnd()));let h=k(e,Q);if(h)return void this.WriteInkList(t,h);let u=k(e,X);if(u)return t.WriteObjectStart(),null===u.value?D("divTargetVal.value"):(t.WriteProperty("^->",u.value.componentsString),void t.WriteObjectEnd());let c=k(e,Y);if(c)return t.WriteObjectStart(),t.WriteProperty("^var",c.value),t.WriteIntProperty("ci",c.contextIndex),void t.WriteObjectEnd();if(k(e,et))return void t.Write("<>");let d=k(e,nt);if(d)return void t.Write(mt._controlCommandNames[d.commandType]);let p=k(e,ht);if(p){let e=p.name;return"^"==e&&(e="L^"),void t.Write(e)}let m=k(e,at);if(m){t.WriteObjectStart();let e=m.pathStringForCount;return null!=e?t.WriteProperty("CNT?",e):t.WriteProperty("VAR?",m.name),void t.WriteObjectEnd()}let g=k(e,ot);if(g){t.WriteObjectStart();let e=g.isGlobal?"VAR=":"temp=";return t.WriteProperty(e,g.variableName),g.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(k(e,lt))return void t.Write("void");let f=k(e,ut);if(f)return t.WriteObjectStart(),t.WriteProperty("#",f.text),void t.WriteObjectEnd();let y=k(e,ct);if(!y)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,y)}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let n in t)if(t.hasOwnProperty(n)){let i=this.JTokenToRuntimeObject(t[n]);if(null===i)return D("inkObject");e.set(n,i)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}static JTokenToRuntimeObject(t){if("number"==typeof t&&!isNaN(t)||"boolean"==typeof t)return K.Create(t);if("string"==typeof t){let e=t.toString(),n=e[0];if("^"==n)return new $(e.substring(1));if("\n"==n&&1==e.length)return new $("\n");if("<>"==e)return new et;for(let t=0;t<mt._controlCommandNames.length;++t)if(e==mt._controlCommandNames[t])return new nt(t);if("L^"==e&&(e="^"),ht.CallExistsWithName(e))return ht.CallWithName(e);if("->->"==e)return nt.PopTunnel();if("~ret"==e)return nt.PopFunction();if("void"==e)return new lt}if("object"==typeof t&&!Array.isArray(t)){let e,n=t;if(n["^->"])return e=n["^->"],new X(new N(e.toString()));if(n["^var"]){e=n["^var"];let t=new Y(e.toString());return"ci"in n&&(e=n.ci,t.contextIndex=parseInt(e)),t}let i=!1,r=!1,s=C.Function,a=!1;if((e=n["->"])?i=!0:(e=n["f()"])?(i=!0,r=!0,s=C.Function):(e=n["->t->"])?(i=!0,r=!0,s=C.Tunnel):(e=n["x()"])&&(i=!0,a=!0,r=!1,s=C.Function),i){let t=new rt;t.pushesToStack=r,t.stackPushType=s,t.isExternal=a;let i=e.toString();return(e=n.var)?t.variableDivertName=i:t.targetPathString=i,t.isConditional=!!n.c,a&&(e=n.exArgs)&&(t.externalArgs=parseInt(e)),t}if(e=n["*"]){let t=new st;return t.pathStringOnChoice=e.toString(),(e=n.flg)&&(t.flags=parseInt(e)),t}if(e=n["VAR?"])return new at(e.toString());if(e=n["CNT?"]){let t=new at;return t.pathStringForCount=e.toString(),t}let o=!1,l=!1;if((e=n["VAR="])?(o=!0,l=!0):(e=n["temp="])&&(o=!0,l=!1),o){let t=e.toString(),i=!n.re,r=new ot(t,i);return r.isGlobal=l,r}if(void 0!==n["#"])return e=n["#"],new ut(e.toString());if(e=n.list){let t=e,i=new B;if(e=n.origins){let t=e;i.SetInitialOriginNames(t)}for(let e in t)if(t.hasOwnProperty(e)){let n=t[e],r=new G(e),s=parseInt(n);i.Add(r,s)}return new Q(i)}if(null!=n.originalChoicePath)return this.JObjectToChoice(n)}if(Array.isArray(t))return this.JArrayToContainer(t);if(null==t)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(t,["parent"]))}static toJson(t,e,n){return JSON.stringify(t,((t,n)=>(null==e?void 0:e.some((e=>e===t)))?void 0:n),n)}static WriteRuntimeContainer(t,e){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.WriteArrayStart(),null===e)return D("container");for(let o of e.content)this.WriteRuntimeObject(t,o);let i=e.namedOnlyContent,r=e.countFlags,s=null!=e.name&&!n,a=null!=i||r>0||s;if(a&&t.WriteObjectStart(),null!=i)for(let[o,l]of i){let e=o,n=k(l,tt);t.WritePropertyStart(e),this.WriteRuntimeContainer(t,n,!0),t.WritePropertyEnd()}r>0&&t.WriteIntProperty("#f",r),s&&t.WriteProperty("#n",e.name),a?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}static JArrayToContainer(t){let e=new tt;e.content=this.JArrayToRuntimeObjList(t,!0);let n=t[t.length-1];if(null!=n){let t=new Map;for(let i in n)if("#f"==i)e.countFlags=parseInt(n[i]);else if("#n"==i)e.name=n[i].toString();else{let e=this.JTokenToRuntimeObject(n[i]),r=k(e,tt);r&&(r.name=i),t.set(i,e)}e.namedOnlyContent=t}return e}static JObjectToChoice(t){let e=new ct;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e.tags=this.JArrayToTags(t),e}static JArrayToTags(t){return t.tags?t.tags:null}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),this.WriteChoiceTags(t,e),t.WriteObjectEnd()}static WriteChoiceTags(t,e){if(e.tags&&e.tags.length>0){t.WritePropertyStart("tags"),t.WriteArrayStart();for(const n of e.tags)t.Write(n);t.WriteArrayEnd(),t.WritePropertyEnd()}}static WriteInkList(t,e){let n=e.value;if(null===n)return D("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();for(let[i,r]of n){let e=G.fromSerializedKey(i),n=r;if(null===e.itemName)return D("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(e.originName?e.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(e.itemName),t.WritePropertyNameEnd(),t.Write(n),t.WritePropertyEnd()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==n.Count&&null!=n.originNames&&n.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();for(let e of n.originNames)t.Write(e);t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}static ListDefinitionsToJToken(t){let e={};for(let n of t.lists){let t={};for(let[e,i]of n.items){let n=G.fromSerializedKey(e);if(null===n.itemName)return D("item.itemName");t[n.itemName]=i}e[n.name]=t}return e}static JTokenToListDefinitions(t){let e=t,n=[];for(let i in e)if(e.hasOwnProperty(i)){let t=i.toString(),r=e[i],s=new Map;for(let n in r)if(e.hasOwnProperty(i)){let t=r[n];s.set(n,parseInt(t))}let a=new dt(t,s);n.push(a)}return new pt(n)}}mt._controlCommandNames=(()=>{let t=[];t[nt.CommandType.EvalStart]="ev",t[nt.CommandType.EvalOutput]="out",t[nt.CommandType.EvalEnd]="/ev",t[nt.CommandType.Duplicate]="du",t[nt.CommandType.PopEvaluatedValue]="pop",t[nt.CommandType.PopFunction]="~ret",t[nt.CommandType.PopTunnel]="->->",t[nt.CommandType.BeginString]="str",t[nt.CommandType.EndString]="/str",t[nt.CommandType.NoOp]="nop",t[nt.CommandType.ChoiceCount]="choiceCnt",t[nt.CommandType.Turns]="turn",t[nt.CommandType.TurnsSince]="turns",t[nt.CommandType.ReadCount]="readc",t[nt.CommandType.Random]="rnd",t[nt.CommandType.SeedRandom]="srnd",t[nt.CommandType.VisitIndex]="visit",t[nt.CommandType.SequenceShuffleIndex]="seq",t[nt.CommandType.StartThread]="thread",t[nt.CommandType.Done]="done",t[nt.CommandType.End]="end",t[nt.CommandType.ListFromInt]="listInt",t[nt.CommandType.ListRange]="range",t[nt.CommandType.ListRandom]="lrnd",t[nt.CommandType.BeginTag]="#",t[nt.CommandType.EndTag]="/#";for(let e=0;e<nt.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t})();class gt{get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){S.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}constructor(){if(this._threadCounter=0,this._startOfRoot=it.Null,arguments[0]instanceof _t){let t=arguments[0];this._startOfRoot=it.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot.copy()}}Reset(){this._threads=[],this._threads.push(new gt.Thread),this._threads[0].callstack.push(new gt.Element(C.Tunnel,this._startOfRoot))}SetJsonToken(t,e){this._threads.length=0;let n=t.threads;for(let i of n){let t=i,n=new gt.Thread(t,e);this._threads.push(n)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=it.StartOf(e.rootContentContainer)}WriteJson(t){t.WriteObject((t=>{t.WritePropertyStart("threads"),t.WriteArrayStart();for(let e of this._threads)e.WriteJson(t);t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(this._threadCounter),t.WritePropertyEnd()}))}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){let t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==C.FunctionEvaluationFromGame}Push(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=new gt.Element(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOutputStream=n,this.callStack.push(i)}CanPop(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==t||this.currentElement.type==t)}Pop(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==e&&(e=this.currentElementIndex+1);let n=z(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}SetTemporaryVariable(t,e,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;-1==i&&(i=this.currentElementIndex+1);let r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new Error("Could not find temporary variable to set: "+t);let s=z(r.temporaryVariables,t,null);s.exists&&Q.RetainListOriginsForAssignment(s.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){let e=this._threads.filter((e=>{if(e.threadIndex==t)return e}));return e.length>0?e[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new R;for(let e=0;e<this._threads.length;e++){let n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(let e=0;e<n.callstack.length;e++){n.callstack[e].type==C.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let i=n.callstack[e].currentPointer;if(!i.isNull){if(t.Append("<SOMEWHERE IN "),null===i.container)return D("pointer.container");t.Append(i.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}!function(t){class e{constructor(t,e){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=t}Copy(){let t=new e(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}t.Element=e;class n{constructor(){if(this.threadIndex=0,this.previousPointer=it.Null,this.callstack=[],arguments[0]&&arguments[1]){let t=arguments[0],n=arguments[1];this.threadIndex=parseInt(t.threadIndex);let i=t.callstack;for(let s of i){let t,i=s,r=parseInt(i.type),a=it.Null,o=i.cPath;if(void 0!==o){t=o.toString();let e=n.ContentAtPath(new N(t));if(a.container=e.container,a.index=parseInt(i.idx),null==e.obj)throw new Error("When loading state, internal story location couldn't be found: "+t+". Has the story changed since this save data was created?");e.approximate&&(null!==a.container?n.Warning("When loading state, exact internal story location couldn't be found: '"+t+"', so it was approximated to '"+a.container.path.toString()+"' to recover. Has the story changed since this save data was created?"):n.Warning("When loading state, exact internal story location couldn't be found: '"+t+"' and it may not be recoverable. Has the story changed since this save data was created?"))}let l=!!i.exp,h=new e(r,a,l),u=i.temp;void 0!==u?h.temporaryVariables=mt.JObjectToDictionaryRuntimeObjs(u):h.temporaryVariables.clear(),this.callstack.push(h)}let r=t.previousContentObject;if(void 0!==r){let t=new N(r.toString());this.previousPointer=n.PointerAtPath(t)}}}Copy(){let t=new n;t.threadIndex=this.threadIndex;for(let e of this.callstack)t.callstack.push(e.Copy());return t.previousPointer=this.previousPointer.copy(),t}WriteJson(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();for(let e of this.callstack){if(t.WriteObjectStart(),!e.currentPointer.isNull){if(null===e.currentPointer.container)return D("el.currentPointer.container");t.WriteProperty("cPath",e.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",e.currentPointer.index)}t.WriteProperty("exp",e.inExpressionEvaluation),t.WriteIntProperty("type",e.type),e.temporaryVariables.size>0&&(t.WritePropertyStart("temp"),mt.WriteDictionaryRuntimeObjs(t,e.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let e=this.previousPointer.Resolve();if(null===e)return D("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",e.path.toString())}t.WriteObjectEnd()}}t.Thread=n}(gt||(gt={}));class ft extends class{}{variableChangedEvent(t,e){for(let n of this.variableChangedEventCallbacks)n(t,e)}StartVariableObservation(){this._batchObservingVariableChanges=!0,this._changedVariablesForBatchObs=new Set}CompleteVariableObservation(){this._batchObservingVariableChanges=!1;let t=new Map;if(null!=this._changedVariablesForBatchObs)for(let e of this._changedVariablesForBatchObs){let t=this._globalVariables.get(e);this.variableChangedEvent(e,t)}if(null!=this.patch)for(let e of this.patch.changedVariables){let n=this.patch.TryGetGlobal(e,null);n.exists&&t.set(e,n)}return this._changedVariablesForBatchObs=null,t}NotifyObservers(t){for(const[e,n]of t)this.variableChangedEvent(e,n)}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(void 0===e){let e=null;return null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists)?e.result.valueObject:(e=this._globalVariables.get(t),void 0===e&&(e=this._defaultGlobalVariables.get(t)),void 0!==e?e.valueObject:null)}{if(void 0===this._defaultGlobalVariables.get(t))throw new M("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let n=K.Create(e);if(null==n)throw null==e?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,n)}}constructor(t,e){super(),this.variableChangedEventCallbacks=[],this.patch=null,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._batchObservingVariableChanges=!1,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(t,e)=>e in t?t[e]:t.$(e),set:(t,e,n)=>(e in t?t[e]=n:t.$(e,n),!0)})}catch(n){}}ApplyPatch(){if(null===this.patch)return D("this.patch");for(let[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(null!==this._changedVariablesForBatchObs)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(let[e,n]of this._defaultGlobalVariables){let i=t[e];if(void 0!==i){let t=mt.JTokenToRuntimeObject(i);if(null===t)return D("tokenInkObject");this._globalVariables.set(e,t)}else this._globalVariables.set(e,n)}}WriteJson(t){t.WriteObjectStart();for(let[e,n]of this._globalVariables){let i=e,r=n;if(ft.dontSaveDefaultValues&&this._defaultGlobalVariables.has(i)){let t=this._defaultGlobalVariables.get(i);if(this.RuntimeObjectsEqual(r,t))continue}t.WritePropertyStart(i),mt.WriteRuntimeObject(t,r),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(null===t)return D("obj1");if(null===e)return D("obj2");if(t.constructor!==e.constructor)return!1;let n=k(t,U);if(null!==n)return n.value===A(e,U).value;let i=k(t,q);if(null!==i)return i.value===A(e,q).value;let r=k(t,H);if(null!==r)return r.value===A(e,H).value;let s=k(t,K),a=k(e,K);if(null!==s&&null!==a)return W(s.valueObject)&&W(a.valueObject)?s.valueObject.Equals(a.valueObject):s.valueObject===a.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=this.GetRawVariableWithName(t,e),i=k(n,Y);return null!==i&&(n=this.ValueAtVariablePointer(i)),n}TryGetDefaultVariableValue(t){let e=z(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(t,e){let n=null;if(0==e||-1==e){let e=null;if(null!==this.patch&&(e=this.patch.TryGetGlobal(t,null),e.exists))return e.result;if(e=z(this._globalVariables,t,null),e.exists)return e.result;if(null!==this._defaultGlobalVariables&&(e=z(this._defaultGlobalVariables,t,null),e.exists))return e.result;if(null===this._listDefsOrigin)return D("VariablesState._listDefsOrigin");let n=this._listDefsOrigin.FindSingleItemListWithName(t);if(n)return n}return n=this._callStack.GetTemporaryVariableWithName(t,e),n}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let n=t.variableName;if(null===n)return D("name");let i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){let t=k(e,Y);null!==t&&(e=this.ResolveVariablePointer(t))}else{let t=null;do{t=k(this.GetRawVariableWithName(n,i),Y),null!=t&&(n=t.variableName,i=t.contextIndex,r=0==i)}while(null!=t)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let n=A(t,Q),i=A(e,Q);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}SetGlobal(t,e){let n=null;if(null===this.patch&&(n=z(this._globalVariables,t,null)),null!==this.patch&&(n=this.patch.TryGetGlobal(t,null),n.exists||(n=z(this._globalVariables,t,null))),Q.RetainListOriginsForAssignment(n.result,e),null===t)return D("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this._batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return D("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let n=k(this.GetRawVariableWithName(t.variableName,e),Y);return null!=n?n:new Y(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}}ft.dontSaveDefaultValues=!0;class yt{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=48271*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class St{get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){let t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}TryGetGlobal(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}class vt{static TextToDictionary(t){return new vt.Reader(t).ToDictionary()}static TextToArray(t){return new vt.Reader(t).ToArray()}}!function(t){t.Reader=class{constructor(t){this._rootObject=JSON.parse(t)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class e{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let e={};if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(t,e){if(this.WritePropertyStart(t),arguments[1]instanceof Function)(0,arguments[1])(this);else{let t=arguments[1];this.Write(t)}this.WritePropertyEnd()}WriteIntProperty(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}WriteFloatProperty(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}WritePropertyStart(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}WriteArrayStart(){this.StartNewObject(!0);let e=[];if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let t=this._propertyNameStack.pop();this.currentCollection[t]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(t){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null value")}WriteBool(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(t))}WriteInt(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}WriteFloat(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(e){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}toString(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}StartNewObject(e){e?this.Assert(this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array):this.Assert(this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}Assert(t){if(!t)throw Error("Assert failed while writing JSON")}_addToCurrentObject(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}}var n,i;t.Writer=e,(i=(n=e=t.Writer||(t.Writer={})).State||(n.State={}))[i.None=0]="None",i[i.Object=1]="Object",i[i.Array=2]="Array",i[i.Property=3]="Property",i[i.PropertyName=4]="PropertyName",i[i.String=5]="String",n.StateElement=class{constructor(e){this.type=t.Writer.State.None,this.childCount=0,this.type=e}}}(vt||(vt={}));class Ct{constructor(){let t=arguments[0],e=arguments[1];if(this.name=t,this.callStack=new gt(e),arguments[2]){let t=arguments[2];this.callStack.SetJsonToken(t.callstack,e),this.outputStream=mt.JArrayToRuntimeObjList(t.outputStream),this.currentChoices=mt.JArrayToRuntimeObjList(t.currentChoices);let n=t.choiceThreads;void 0!==n&&this.LoadFlowChoiceThreads(n,e)}else this.outputStream=[],this.currentChoices=[]}WriteJson(t){t.WriteObjectStart(),t.WriteProperty("callstack",(t=>this.callStack.WriteJson(t))),t.WriteProperty("outputStream",(t=>mt.WriteListRuntimeObjs(t,this.outputStream)));let e=!1;for(let n of this.currentChoices){if(null===n.threadAtGeneration)return D("c.threadAtGeneration");n.originalThreadIndex=n.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(n.originalThreadIndex)&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(n.originalThreadIndex),n.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",(t=>{t.WriteArrayStart();for(let e of this.currentChoices)mt.WriteChoice(t,e);t.WriteArrayEnd()})),t.WriteObjectEnd()}LoadFlowChoiceThreads(t,e){for(let n of this.currentChoices){let i=this.callStack.ThreadWithIndex(n.originalThreadIndex);if(null!==i)n.threadAtGeneration=i.Copy();else{let i=t[`${n.originalThreadIndex}`];n.threadAtGeneration=new gt.Thread(i,e)}}}}class bt{ToJson(){let t=new vt.Writer;return this.WriteJson(t),t.toString()}toJson(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.ToJson(t)}LoadJson(t){let e=vt.TextToDictionary(t);this.LoadJsonObj(e),null!==this.onDidLoadState&&this.onDidLoadState()}VisitCountAtPathString(t){let e;if(null!==this._patch){let n=this.story.ContentAtPath(new N(t)).container;if(null===n)throw new Error("Content at path not found: "+t);if(e=this._patch.TryGetVisitCount(n,0),e.exists)return e.result}return e=z(this._visitCounts,t,null),e.exists?e.result:0}VisitCountForContainer(t){if(null===t)return D("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){let e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}let e=t.path.toString(),n=z(this._visitCounts,e,null);return n.exists?n.result:0}IncrementVisitCountForContainer(t){if(null!==this._patch){let e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}let e=t.path.toString(),n=z(this._visitCounts,e,null);n.exists?this._visitCounts.set(e,n.result+1):this._visitCounts.set(e,1)}RecordTurnIndexVisitToContainer(t){if(null!==this._patch)return void this._patch.SetTurnIndex(t,this.currentTurnIndex);let e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}TurnsSinceForContainer(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){let e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}let e=t.path.toString(),n=z(this._turnIndices,e,0);return n.exists?this.currentTurnIndex-n.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._currentFlow.outputStream}get currentChoices(){return this.canContinue?[]:this._currentFlow.currentChoices}get generatedChoices(){return this._currentFlow.currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get callStack(){return this._currentFlow.callStack}get evaluationStack(){return this._evaluationStack}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){let t=this.currentPointer;return t.isNull?null:null===t.path?D("pointer.path"):t.path.toString()}get previousPathString(){let t=this.previousPointer;return t.isNull?null:null===t.path?D("previousPointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&this.currentErrors.length>0}get hasWarning(){return null!=this.currentWarnings&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new R,e=!1;for(let n of this.outputStream){let i=k(n,$);if(e||null===i){let t=k(n,nt);null!==t&&(t.commandType==nt.CommandType.BeginTag?e=!0:t.commandType==nt.CommandType.EndTag&&(e=!1))}else t.Append(i.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new R,n=-1,i=0;for(let r=0;r<t.length;r++){let s=t.charAt(r),a=" "==s||"\t"==s;a&&-1==n&&(n=r),a||("\n"!=s&&n>0&&n!=i&&e.Append(" "),n=-1),"\n"==s&&(i=r+1),a||e.Append(s)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];let t=!1,e=new R;for(let n of this.outputStream){let i=k(n,nt);if(null!=i){if(i.commandType==nt.CommandType.BeginTag){if(t&&e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}t=!0}else if(i.commandType==nt.CommandType.EndTag){if(e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}t=!1}}else if(t){let t=k(n,$);null!==t&&e.Append(t.value)}else{let t=k(n,ut);null!=t&&null!=t.text&&t.text.length>0&&this._currentTags.push(t.text)}}if(e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}this._outputStreamTagsDirty=!1}return this._currentTags}get currentFlowName(){return this._currentFlow.name}get currentFlowIsDefaultFlow(){return this._currentFlow.name==this.kDefaultFlowName}get aliveFlowNames(){if(this._aliveFlowNamesDirty){if(this._aliveFlowNames=[],null!=this._namedFlows)for(let t of this._namedFlows.keys())t!=this.kDefaultFlowName&&this._aliveFlowNames.push(t);this._aliveFlowNamesDirty=!1}return this._aliveFlowNames}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}constructor(t){this.kInkSaveStateVersion=10,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=it.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._aliveFlowNames=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this._aliveFlowNamesDirty=!0,this.story=t,this._currentFlow=new Ct(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this._evaluationStack=[],this._variablesState=new ft(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let e=(new Date).getTime();this.storySeed=new yt(e).next()%100,this.previousRandom=0,this.GoToStart()}GoToStart(){this.callStack.currentElement.currentPointer=it.StartOf(this.story.mainContentContainer)}SwitchFlow_Internal(t){if(null===t)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),t===this._currentFlow.name)return;let e,n=z(this._namedFlows,t,null);n.exists?e=n.result:(e=new Ct(t,this.story),this._namedFlows.set(t,e),this._aliveFlowNamesDirty=!0),this._currentFlow=e,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}SwitchToDefaultFlow_Internal(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}RemoveFlow_Internal(t){if(null===t)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return D("this._namedFlows");this._namedFlows.delete(t),this._aliveFlowNamesDirty=!0}CopyAndStartPatching(t){let e=new bt(this.story);if(e._patch=new St(this._patch),e._currentFlow.name=this._currentFlow.name,e._currentFlow.callStack=new gt(this._currentFlow.callStack),e._currentFlow.outputStream.push(...this._currentFlow.outputStream),e.OutputStreamDirty(),t)for(let n of this._currentFlow.currentChoices)e._currentFlow.currentChoices.push(n.Clone());else e._currentFlow.currentChoices.push(...this._currentFlow.currentChoices);if(null!==this._namedFlows){e._namedFlows=new Map;for(let[t,n]of this._namedFlows)e._namedFlows.set(t,n),e._aliveFlowNamesDirty=!0;e._namedFlows.set(this._currentFlow.name,e._currentFlow)}return this.hasError&&(e._currentErrors=[],e._currentErrors.push(...this.currentErrors||[])),this.hasWarning&&(e._currentWarnings=[],e._currentWarnings.push(...this.currentWarnings||[])),e.variablesState=this.variablesState,e.variablesState.callStack=e.callStack,e.variablesState.patch=e._patch,e.evaluationStack.push(...this.evaluationStack),this.divertedPointer.isNull||(e.divertedPointer=this.divertedPointer.copy()),e.previousPointer=this.previousPointer.copy(),e._visitCounts=this._visitCounts,e._turnIndices=this._turnIndices,e.currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(null!==this._patch){this.variablesState.ApplyPatch();for(let[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}WriteJson(t){if(t.WriteObjectStart(),t.WritePropertyStart("flows"),t.WriteObjectStart(),null!==this._namedFlows)for(let[e,n]of this._namedFlows)t.WriteProperty(e,(t=>n.WriteJson(t)));else t.WriteProperty(this._currentFlow.name,(t=>this._currentFlow.WriteJson(t)));if(t.WriteObjectEnd(),t.WritePropertyEnd(),t.WriteProperty("currentFlowName",this._currentFlow.name),t.WriteProperty("variablesState",(t=>this.variablesState.WriteJson(t))),t.WriteProperty("evalStack",(t=>mt.WriteListRuntimeObjs(t,this.evaluationStack))),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return D("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",(t=>mt.WriteIntDictionary(t,this._visitCounts))),t.WriteProperty("turnIndices",(t=>mt.WriteIntDictionary(t,this._turnIndices))),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",_t.inkVersionCurrent),t.WriteObjectEnd()}LoadJsonObj(t){let e=t,n=e.inkSaveVersion;if(null==n)throw new Error("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");let i=e.flows;if(null!=i){let t=i;1===Object.keys(t).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear();let n=Object.entries(t);for(let[e,i]of n){let n=e,r=i,s=new Ct(n,this.story,r);if(1===Object.keys(t).length)this._currentFlow=new Ct(n,this.story,r);else{if(null===this._namedFlows)return D("this._namedFlows");this._namedFlows.set(n,s)}}if(null!=this._namedFlows&&this._namedFlows.size>1){let t=e.currentFlowName;this._currentFlow=this._namedFlows.get(t)}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=mt.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=mt.JArrayToRuntimeObjList(e.currentChoices);let t=e.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(t,this.story)}this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=mt.JArrayToRuntimeObjList(e.evalStack);let r=e.currentDivertTarget;if(null!=r){let t=new N(r.toString());this.divertedPointer=this.story.PointerAtPath(t)}this._visitCounts=mt.JObjectToIntDictionary(e.visitCounts),this._turnIndices=mt.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==t&&this.outputStream.push(...t),this.OutputStreamDirty()}PushToOutputStream(t){let e=k(t,$);if(null!==e){let t=this.TrySplittingHeadTailWhitespace(e);if(null!==t){for(let e of t)this.PushToOutputStreamIndividual(e);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(null===e)return D("single.value");let n=-1,i=-1;for(let h=0;h<e.length;h++){let t=e[h];if("\n"!=t){if(" "==t||"\t"==t)continue;break}-1==n&&(n=h),i=h}let r=-1,s=-1;for(let h=e.length-1;h>=0;h--){let t=e[h];if("\n"!=t){if(" "==t||"\t"==t)continue;break}-1==r&&(r=h),s=h}if(-1==n&&-1==r)return null;let a=[],o=0,l=e.length;if(-1!=n){if(n>0){let t=new $(e.substring(0,n));a.push(t)}a.push(new $("\n")),o=i+1}if(-1!=r&&(l=s),l>o){let t=e.substring(o,l);a.push(new $(t))}if(-1!=r&&s>i&&(a.push(new $("\n")),r<e.length-1)){let t=e.length-r-1,n=new $(e.substring(r+1,r+1+t));a.push(n)}return a}PushToOutputStreamIndividual(t){let e=k(t,et),n=k(t,$),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){let t=-1,e=this.callStack.currentElement;e.type==C.Function&&(t=e.functionStartInOutputStream);let r=-1;for(let n=this.outputStream.length-1;n>=0;n--){let e=this.outputStream[n],i=e instanceof nt?e:null;if(null!=(e instanceof et?e:null)){r=n;break}if(null!=i&&i.commandType==nt.CommandType.BeginString){n>=t&&(t=-1);break}}let s=-1;if(s=-1!=r&&-1!=t?Math.min(t,r):-1!=r?r:t,-1!=s){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(r>-1&&this.RemoveExistingGlue(),t>-1)){let t=this.callStack.elements;for(let e=t.length-1;e>=0;e--){let n=t[e];if(n.type!=C.Function)break;n.functionStartInOutputStream=-1}}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return D("obj");this.outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this.outputStream.length-1;for(;e>=0;){let n=this.outputStream[e],i=k(n,nt),r=k(n,$);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this.outputStream.length;)k(this.outputStream[e],$)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this.outputStream.length-1;t>=0;t--){let e=this.outputStream[t];if(e instanceof et)this.outputStream.splice(t,1);else if(e instanceof nt)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this.outputStream.length>0)for(let t=this.outputStream.length-1;t>=0&&!(this.outputStream[t]instanceof nt);t--){let e=this.outputStream[t];if(e instanceof $){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t of this.outputStream)if(t instanceof $)return!0;return!1}get inStringEvaluation(){for(let t=this.outputStream.length-1;t>=0;t--){let e=k(this.outputStream[t],nt);if(e instanceof nt&&e.commandType==nt.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=k(t,Q);if(e){let t=e.value;if(null===t)return D("rawList");if(null!=t.originNames){t.origins||(t.origins=[]),t.origins.length=0;for(let e of t.originNames){if(null===this.story.listDefinitions)return D("StoryState.story.listDefinitions");let n=this.story.listDefinitions.TryListGetDefinition(e,null);if(null===n.result)return D("StoryState def.result");t.origins.indexOf(n.result)<0&&t.origins.push(n.result)}}}if(null===t)return D("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(void 0===t)return F(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return F(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=it.Null,this.previousPointer=it.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){S.Assert(this.callStack.currentElement.type==C.Function);let t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(let e=this.outputStream.length-1;e>=t;e--){let t=this.outputStream[e],n=k(t,$),i=k(t,nt);if(null!=n){if(i)break;if(!n.isNewline&&!n.isInlineWhitespace)break;this.outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==C.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentFlow.currentChoices.length=0;let n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(C.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=it.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(null!==t)for(let e=0;e<t.length;e++){if(!("number"==typeof t[e]||"string"==typeof t[e]||"boolean"==typeof t[e]||t[e]instanceof B))throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters must benumber, string, bool or InkList. Argument was "+(null===F(t[e])?"null":t[e].constructor.name));this.PushEvaluationStack(K.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==C.FunctionEvaluationFromGame&&(this.currentPointer=it.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=C.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let t=this.PopEvaluationStack();null===e&&(e=t)}if(this.PopCallStack(C.FunctionEvaluationFromGame),e){if(e instanceof lt)return null;let t=A(e,K);return t.valueType==v.DivertTarget?t.valueObject.toString():t.valueObject}return null}AddError(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class wt{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=void 0}}!function(t){t[t.Author=0]="Author",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(b||(b={})),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});class _t extends j{get currentChoices(){let t=[];if(null===this._state)return D("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get currentFlowName(){return this.state.currentFlowName}get currentFlowIsDefaultFlow(){return this.state.currentFlowIsDefaultFlow}get aliveFlowNames(){return this.state.aliveFlowNames}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}constructor(){let t;super(),this.inkVersionMinimumCompatible=18,this.onError=null,this.onDidContinue=null,this.onMakeChoice=null,this.onEvaluateFunction=null,this.onCompleteEvaluateFunction=null,this.onChoosePathString=null,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let e=null,n=null;if(arguments[0]instanceof tt)t=arguments[0],void 0!==arguments[1]&&(e=arguments[1]),this._mainContentContainer=t;else if("string"==typeof arguments[0]){let t=arguments[0];n=vt.TextToDictionary(t)}else n=arguments[0];if(null!=e&&(this._listDefinitions=new pt(e)),this._externals=new Map,null!==n){let t=n,e=t.inkVersion;if(null==e)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let i=parseInt(e);if(i>_t.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(i<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");i!=_t.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let r,s=t.root;if(null==s)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(r=t.listDefs)&&(this._listDefinitions=mt.JTokenToListDefinitions(r)),this._mainContentContainer=A(mt.JTokenToRuntimeObject(s),tt),this.ResetState()}}ToJson(t){let e=!1;if(t||(e=!0,t=new vt.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",_t.inkVersionCurrent),t.WriteProperty("root",(t=>mt.WriteRuntimeContainer(t,this._mainContentContainer))),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();for(let e of this._listDefinitions.lists){t.WritePropertyStart(e.name),t.WriteObjectStart();for(let[n,i]of e.items){let e=G.fromSerializedKey(n),r=i;t.WriteIntProperty(e.itemName,r)}t.WriteObjectEnd(),t.WritePropertyEnd()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),e)return t.toString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new bt(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return D("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return D("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let t=this.state.currentPointer.copy();this.ChoosePath(new N("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}SwitchFlow(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}RemoveFlow(t){this.state.RemoveFlow_Internal(t)}SwitchToDefaultFlow(){this.state.SwitchToDefaultFlow_Internal()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,this._asyncContinueActive)this._asyncContinueActive&&!e&&(this._asyncContinueActive=!1);else{if(this._asyncContinueActive=e,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&this._state.variablesState.StartVariableObservation()}let n=new wt;n.Start();let i=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{i=this.ContinueSingleStep()}catch(s){if(!(s instanceof M))throw s;this.AddError(s.message,void 0,s.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop();let r=null;if(!i&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(C.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(C.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(r=this._state.variablesState.CompleteVariableObservation()),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){let t=new R;throw t.Append("Ink had "),this.state.hasError&&(t.Append(`${this.state.currentErrors.length}`),t.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning&&t.Append(" and ")),this.state.hasWarning&&(t.Append(`${this.state.currentWarnings.length}`),t.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning&&t.Append(" and ")),t.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),t.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new M(t.toString())}if(this.state.hasError)for(let t of this.state.currentErrors)this.onError(t,b.Error);if(this.state.hasWarning)for(let t of this.state.currentWarnings)this.onError(t,b.Warning);this.ResetErrors()}null!=r&&Object.keys(r).length>0&&this._state.variablesState.NotifyObservers(r)}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return D("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return D("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==_t.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==_t.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,n,i){if(null===t)return D("prevText");if(null===e)return D("currText");let r=e.length>=t.length&&t.length>0&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&r)return _t.OutputStateChange.NoChange;if(!r)return _t.OutputStateChange.NewlineRemoved;if(i>n)return _t.OutputStateChange.ExtendedBeyondNewline;for(let s=t.length;s<e.length;s++){let t=e.charAt(s);if(" "!=t&&"\t"!=t)return _t.OutputStateChange.ExtendedBeyondNewline}return _t.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new R;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof tt?e:null}PointerAtPath(t){if(0==t.length)return it.Null;let e=new it,n=t.length,i=null;return null===t.lastComponent?D("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching(!1)}RestoreStateSnapshot(){null===this._stateSnapshotAtLastNewline&&D("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let t=this._state;return this._state=this._state.CopyAndStartPatching(!0),this._asyncSaving=!0,t}BackgroundSaveComplete(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let n=k(e.Resolve(),tt);for(;n&&(this.VisitContainer(n,!0),0!=n.content.length);)e=it.StartOf(n),n=k(e.Resolve(),tt);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(this.state.currentPointer.isNull)return;r&&(t=!1);let s=k(i,st);if(s){let e=this.ProcessChoice(s);e&&this.state.generatedChoices.push(e),i=null,t=!1}if(i instanceof tt&&(t=!1),t){let t=k(i,Y);if(t&&-1==t.contextIndex){let e=this.state.callStack.ContextForVariableNamed(t.variableName);i=new Y(t.variableName,e)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();let a=k(i,nt);a&&a.commandType==nt.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||-1==e.index)return;if(this._prevContainers.length=0,!t.isNull){let e=k(t.Resolve(),tt)||k(t.container,tt);for(;e;)this._prevContainers.push(e),e=k(e.parent,tt)}let n=e.Resolve();if(null==n)return;let i=k(n.parent,tt),r=!0;for(;i&&(this._prevContainers.indexOf(i)<0||i.countingAtStartOnly);){let t=i.content.length>0&&n==i.content[0]&&r;t||(r=!1),this.VisitContainer(i,t),n=i,i=k(i.parent,tt)}}PopChoiceStringAndTags(t){let e=A(this.state.PopEvaluationStack(),$);for(;this.state.evaluationStack.length>0&&null!=k(this.state.PeekEvaluationStack(),ut);){let e=k(this.state.PopEvaluationStack(),ut);e&&t.push(e.text)}return e.value}ProcessChoice(t){let e=!0;if(t.hasCondition){let t=this.state.PopEvaluationStack();this.IsTruthy(t)||(e=!1)}let n="",i="",r=[];if(t.hasChoiceOnlyContent&&(i=this.PopChoiceStringAndTags(r)||""),t.hasStartContent&&(n=this.PopChoiceStringAndTags(r)||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;let s=new ct;return s.targetPath=t.pathOnChoice,s.sourcePath=t.path.toString(),s.isInvisibleDefault=t.isInvisibleDefault,s.threadAtGeneration=this.state.callStack.ForkThread(),s.tags=r.reverse(),s.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),s}IsTruthy(t){if(t instanceof K){let e=t;if(e instanceof X){let t=e;return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(null==t)return!1;if(t instanceof rt){let e=t;if(e.isConditional){let t=this.state.PopEvaluationStack();if(!this.IsTruthy(t))return!0}if(e.hasVariableTarget){let t=e.variableDivertName,n=this.state.variablesState.GetVariableWithName(t);if(null==n)this.Error("Tried to divert using a target from a variable that could not be found ("+t+")");else if(!(n instanceof X)){let e=k(n,q),i="Tried to divert to a target from a variable, but the variable ("+t+") didn't contain a divert target, it ";e instanceof q&&0==e.value?i+="was empty/null (the value 0).":i+="contained '"+n+"'.",this.Error(i)}let i=A(n,X);this.state.divertedPointer=this.PointerAtPath(i.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof nt){let e=t;switch(e.commandType){case nt.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case nt.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case nt.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let t=this.state.PopEvaluationStack();if(!(t instanceof lt)){let e=new $(t.toString());this.state.PushToOutputStream(e)}}break;case nt.CommandType.NoOp:break;case nt.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case nt.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case nt.CommandType.PopFunction:case nt.CommandType.PopTunnel:let t=e.commandType==nt.CommandType.PopFunction?C.Function:C.Tunnel,n=null;if(t==C.Tunnel){let t=this.state.PopEvaluationStack();n=k(t,X),null===n&&this.Assert(t instanceof lt,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==t&&this.state.callStack.canPop)this.state.PopCallStack(),n&&(this.state.divertedPointer=this.PointerAtPath(n.targetPath));else{let e=new Map;e.set(C.Function,"function return statement (~ return)"),e.set(C.Tunnel,"tunnel onwards statement (->->)");let n=e.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(n="end of flow (-> END or choice)");let i="Found "+e.get(t)+", when expected "+n;this.Error(i)}break;case nt.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case nt.CommandType.BeginTag:this.state.PushToOutputStream(e);break;case nt.CommandType.EndTag:if(this.state.inStringEvaluation){let t=[],e=0;for(let r=this.state.outputStream.length-1;r>=0;--r){let n=this.state.outputStream[r];e++;let i=k(n,nt);if(null!=i){if(i.commandType==nt.CommandType.BeginTag)break;this.Error("Unexpected ControlCommand while extracting tag from choice");break}n instanceof $&&t.push(n)}this.state.PopFromOutputStream(e);let n=new R;for(let r of t.reverse())n.Append(r.toString());let i=new ut(this.state.CleanOutputWhitespace(n.toString()));this.state.PushEvaluationStack(i)}else this.state.PushToOutputStream(e);break;case nt.CommandType.EndString:{let t=[],e=[],n=0;for(let r=this.state.outputStream.length-1;r>=0;--r){let i=this.state.outputStream[r];n++;let s=k(i,nt);if(s&&s.commandType==nt.CommandType.BeginString)break;i instanceof ut&&e.push(i),i instanceof $&&t.push(i)}this.state.PopFromOutputStream(n);for(let r of e)this.state.PushToOutputStream(r);t=t.reverse();let i=new R;for(let r of t)i.Append(r.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new $(i.toString()));break}case nt.CommandType.ChoiceCount:let i=this.state.generatedChoices.length;this.state.PushEvaluationStack(new q(i));break;case nt.CommandType.Turns:this.state.PushEvaluationStack(new q(this.state.currentTurnIndex+1));break;case nt.CommandType.TurnsSince:case nt.CommandType.ReadCount:let r=this.state.PopEvaluationStack();if(!(r instanceof X)){let t="";r instanceof q&&(t=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+r+t);break}let s,a=A(r,X),o=k(this.ContentAtPath(a.targetPath).correctObj,tt);null!=o?s=e.commandType==nt.CommandType.TurnsSince?this.state.TurnsSinceForContainer(o):this.state.VisitCountForContainer(o):(s=e.commandType==nt.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+a.targetPath.toString())),this.state.PushEvaluationStack(new q(s));break;case nt.CommandType.Random:{let t=k(this.state.PopEvaluationStack(),q),e=k(this.state.PopEvaluationStack(),q);if(null==e||e instanceof q==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==t||t instanceof q==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return D("maxInt.value");if(null===e.value)return D("minInt.value");let n=t.value-e.value+1;(!isFinite(n)||n>Number.MAX_SAFE_INTEGER)&&(n=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),n<=0&&this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger");let i=this.state.storySeed+this.state.previousRandom,r=new yt(i).next(),s=r%n+e.value;this.state.PushEvaluationStack(new q(s)),this.state.previousRandom=r;break}case nt.CommandType.SeedRandom:let l=k(this.state.PopEvaluationStack(),q);if(null==l||l instanceof q==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===l.value)return D("minInt.value");this.state.storySeed=l.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new lt);break;case nt.CommandType.VisitIndex:let h=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new q(h));break;case nt.CommandType.SequenceShuffleIndex:let u=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new q(u));break;case nt.CommandType.StartThread:break;case nt.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=it.Null);break;case nt.CommandType.End:this.state.ForceEnd();break;case nt.CommandType.ListFromInt:let c=k(this.state.PopEvaluationStack(),q),d=A(this.state.PopEvaluationStack(),$);if(null===c)throw new M("Passed non-integer when creating a list element from a numerical value.");let p=null;if(null===this.listDefinitions)return D("this.listDefinitions");let m=this.listDefinitions.TryListGetDefinition(d.value,null);if(!m.exists)throw new M("Failed to find LIST called "+d.value);{if(null===c.value)return D("minInt.value");let t=m.result.TryGetItemWithValue(c.value,G.Null);t.exists&&(p=new Q(t.result,c.value))}null==p&&(p=new Q),this.state.PushEvaluationStack(p);break;case nt.CommandType.ListRange:let g=k(this.state.PopEvaluationStack(),K),f=k(this.state.PopEvaluationStack(),K),y=k(this.state.PopEvaluationStack(),Q);if(null===y||null===f||null===g)throw new M("Expected list, minimum and maximum for LIST_RANGE");if(null===y.value)return D("targetList.value");let S=y.value.ListWithSubRange(f.valueObject,g.valueObject);this.state.PushEvaluationStack(new Q(S));break;case nt.CommandType.ListRandom:{let t=this.state.PopEvaluationStack();if(null===t)throw new M("Expected list for LIST_RANDOM");let e=t.value,n=null;if(null===e)throw D("list");if(0==e.Count)n=new B;else{let t=this.state.storySeed+this.state.previousRandom,i=new yt(t).next(),r=i%e.Count,s=e.entries();for(let e=0;e<=r-1;e++)s.next();let a=s.next().value,o={Key:G.fromSerializedKey(a[0]),Value:a[1]};if(null===o.Key.originName)return D("randomItem.Key.originName");n=new B(o.Key.originName,this),n.Add(o.Key,o.Value),this.state.previousRandom=i}this.state.PushEvaluationStack(new Q(n));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof ot){let e=t,n=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,n),!0}if(t instanceof at){let e=t,n=null;if(null!=e.pathForCount){let t=e.containerForCount,i=this.state.VisitCountForContainer(t);n=new q(i)}else n=this.state.variablesState.GetVariableWithName(e.name),null==n&&(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),n=new q(0));return this.state.PushEvaluationStack(n),!0}if(t instanceof ht){let e=t,n=this.state.PopEvaluationStack(e.numberOfParameters),i=e.Call(n);return this.state.PushEvaluationStack(i),!0}return!1}ChoosePathString(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(t,n),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==C.Function){let e="",n=this.state.callStack.currentElement.currentPointer.container;throw null!=n&&(e="("+n.path.toString()+") "),new Error("Story was running a function "+e+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new N(t))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let n=e[t];return null!==this.onMakeChoice&&this.onMakeChoice(n),null===n.threadAtGeneration?D("choiceToChoose.threadAtGeneration"):null===n.targetPath?D("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}HasFunction(t){try{return null!=this.KnotContainerWithName(t)}catch(e){return!1}}EvaluateFunction(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");let i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");let r=[];r.push(...this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);let s=new R;for(;this.canContinue;)s.Append(this.Continue());let a=s.toString();this._state.ResetOutput(r);let o=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(t,e,a,o),n?{returned:o,output:a}:o}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(C.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(null===t)return D("funcName");let n=this._externals.get(t),i=null,r=void 0!==n;if(r&&!n.lookAheadSafe&&this._state.inStringEvaluation&&this.Error("External function "+t+' could not be called because 1) it wasn\'t marked as lookaheadSafe when BindExternalFunction was called and 2) the story is in the middle of string generation, either because choice text is being generated, or because you have ink like "hello {func()}". You can work around this by generating the result of your function into a temporary variable before the string or choice gets generated: ~ temp x = '+t+"()"),r&&!n.lookAheadSafe&&null!==this._stateSnapshotAtLastNewline)return void(this._sawLookaheadUnsafeFunctionAfterNewline=!0);if(!r){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(t),this.Assert(null!==i,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(C.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=it.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let s=[];for(let l=0;l<e;++l){let t=A(this.state.PopEvaluationStack(),K).valueObject;s.push(t)}s.reverse();let a=n.function(s),o=null;null!=a?(o=K.Create(a),this.Assert(null!==o,"Could not create ink value from returned object of type "+typeof a)):o=new lt,this.state.PushEvaluationStack(o)}BindExternalFunctionGeneral(t,e){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:n})}TryCoerce(t){return t}BindExternalFunction(t,e){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,(t=>{this.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");let n=[];for(let e=0,i=t.length;e<i;e++)n[e]=this.TryCoerce(t[e]);return e.apply(null,n)}),n)}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof tt&&(t=arguments[0]),arguments[0]instanceof j&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t+=n.size>1?"s":"",t+=": '",t+=Array.from(n).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t)}else if(null!=t){for(let e of t.content)null!=e&&e.hasValidName||this.ValidateExternalBindings(e,n);for(let[,e]of t.namedContent)this.ValidateExternalBindings(k(e,j),n)}else if(null!=e){let t=k(e,rt);if(t&&t.isExternal){let e=t.targetPathString;if(null===e)return D("name");this._externals.has(e)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(e)||n.add(e)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(null!=e){if(this._variableObservers.has(e))if(null!=t){let n=this._variableObservers.get(e);null!=n&&(n.splice(n.indexOf(t),1),0===n.length&&this._variableObservers.delete(e))}else this._variableObservers.delete(e)}else if(null!=t){let e=this._variableObservers.keys();for(let n of e){let e=this._variableObservers.get(n);null!=e&&(e.splice(e.indexOf(t),1),0===e.length&&this._variableObservers.delete(n))}}}VariableStateDidChangeEvent(t,e){if(null===this._variableObservers)return;let n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof K))throw new Error("Tried to get the value of a variable that isn't a standard type");let i=A(e,K);for(let e of n)e(t,i.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let e=new N(t),n=this.ContentAtPath(e).container;if(null===n)return D("flowContainer");for(;;){let t=n.content[0];if(!(t instanceof tt))break;n=t}let i=!1,r=null;for(let s of n.content){let t=k(s,nt);if(null!=t)t.commandType==nt.CommandType.BeginTag?i=!0:t.commandType==nt.CommandType.EndTag&&(i=!1);else{if(!i)break;{let t=k(s,$);null!==t?(null===r&&(r=[]),null!==t.value&&r.push(t.value)):this.Error("Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().")}}}return r}BuildStringOfHierarchy(){let t=new R;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new R;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=it.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(C.Function)?(this.state.PopCallStack(C.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new lt),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return D("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let n=k(e.container.parent,tt);if(n instanceof tt==0)break;let i=n.content.indexOf(e.container);if(-1==i)break;if(e=new it(n,i),e.index++,t=!0,null===e.container)return D("pointer.container")}return t||(e=it.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter((t=>t.isInvisibleDefault));if(0==e.length||t.length>e.length)return!1;let n=e[0];return null===n.targetPath?D("choice.targetPath"):null===n.threadAtGeneration?D("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(n.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=k(this.state.PopEvaluationStack(),q);if(!(t instanceof q))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(null===e)return D("seqContainer");if(null===t.value)return D("numElementsIntVal.value");let n=t.value,i=A(this.state.PopEvaluationStack(),q).value;if(null===i)return D("seqCount");let r=i/n,s=i%n,a=e.path.toString(),o=0;for(let c=0,d=a.length;c<d;c++)o+=a.charCodeAt(c)||0;let l=o+r+this.state.storySeed,h=new yt(Math.floor(l)),u=[];for(let c=0;c<n;++c)u.push(c);for(let c=0;c<=s;++c){let t=h.next()%u.length,e=u[t];if(u.splice(t,1),c==s)return e}throw new Error("Should never reach here")}Error(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=new M(t);throw n.useEndLineNumber=e,n}Warning(t){this.AddError(t,!0)}AddError(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(null!=i){let e=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+r+": '"+i.fileName+"' line "+e+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let n=this.state.callStack.elements.length-1;n>=0;--n)if(e=this.state.callStack.elements[n].currentPointer,!e.isNull&&null!==e.Resolve()&&(t=e.Resolve().debugMetadata,null!==t))return t;for(let n=this.state.outputStream.length-1;n>=0;--n)if(t=this.state.outputStream[n].debugMetadata,null!==t)return t;return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}_t.inkVersionCurrent=21,function(t){var e;(e=t.OutputStateChange||(t.OutputStateChange={}))[e.NoChange=0]="NoChange",e[e.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",e[e.NewlineRemoved=2]="NewlineRemoved"}(_t||(_t={}));class Tt extends n.Scene{constructor(){super("MainGameScene"),e(this,"tile_Layer"),e(this,"test_castle"),e(this,"player"),e(this,"cursors"),e(this,"grid"),e(this,"cellSize"),e(this,"storyBox",null),e(this,"directionInput",new x),e(this,"collisionChecker"),e(this,"debugGraphics"),e(this,"jsonData"),e(this,"backgroundMusic"),this.grid=null,this.cellSize=16}preload(){this.load.pack("preload-asset-pack","assets/preload-asset-pack.json")}editorCreate(){const t=this.add.tilemap("test_castle");t.addTilesetImage("ShadowtideKeepEntranceMap_test_1","ShadowtideKeepEntranceMap_test_1"),this.add.image(1920,1080,"ShadowtideKeepEntranceMap_test_1");const e=t.createLayer("Tile Layer 1",["ShadowtideKeepEntranceMap_test_1"],0,0),n=this.add.image(1920,1080,"mapgrass1");n.scaleX=2,n.scaleY=2,this.add.image(1920,1080,"fantasy_ship");const i=this.add.text(96,96,"",{});i.text="SHADOWTIDE\nISLAND",i.setStyle({align:"right",color:"#ceba96ff",fontSize:"185px",fontStyle:"bold",stroke:"#000000ff",strokeThickness:10,"shadow.offsetX":13,"shadow.offsetY":8,"shadow.blur":5,"shadow.fill":!0}),this.tile_Layer=e,this.test_castle=t,this.events.emit("scene-awake")}create(){var t;this.editorCreate(),this.debugGraphics=this.add.graphics({lineStyle:{width:1,color:16711680,alpha:.8},fillStyle:{color:16711680,alpha:.3}}),this.physics.world.setBounds(0,0,3840,2160),this.grid=new E(this,this.cellSize),this.player=new T(this,5,5,"Warrior_Blue",128,this.grid),this.directionInput.init(),this.test_castle.setCollisionByProperty({collides:!0}),this.cameras.main.setBounds(0,0,3840,2160),this.cameras.main.startFollow(this.player),null==(t=this.input.keyboard)||t.on("keydown-G",(()=>{var t;null==(t=this.grid)||t.toggle()})),this.input.on("pointerdown",(()=>this.player.attack()));const e=this.cache.json.entries.get("chapter_1.ink");if(e){const t=new _t(e);console.log(t.Continue())}else console.error("Failed to load ink story data");const n=new _t(e);this.displayInkContent(n),this.collisionChecker=new P(this,this.tile_Layer,this.grid),this.player.updateOccupiedGrids(),this.visualizeOccupiedGrids(this.player.getOccupiedGrids(),65280),console.log("Occupied Grids:",this.player.getOccupiedGrids()),this.backgroundMusic=this.sound.add("The_Journey_Begins_110bpm_120s"),this.backgroundMusic.play({loop:!0,volume:.5})}displayInkContent(t){var e,n;let i=[];for(t.canContinue&&i.push((null==(e=null==t?void 0:t.Continue())?void 0:e.trim())||"");t.canContinue||t.currentChoices.length>0;)t.canContinue&&i.push((null==(n=null==t?void 0:t.Continue())?void 0:n.trim())||""),t.currentChoices.length>0&&(t.currentChoices.forEach(((t,e)=>{i.push(`${e+1}: ${t.text}`)})),t.ChooseChoiceIndex(0));const r=i.filter((t=>t.length>0));console.log("Story Content:",r.join("\n"));const s={texts:r,style:{fontSize:"40px",backgroundColor:"rgb(199, 147, 99)",textColor:"rgb(24, 18, 12)",padding:"2rem",borderRadius:"2rem",fontFamily:"Copperplate, Papyrus, Playbill, Luminari, Garamond, Georgia, serif"},revealSpeed:30,onComplete:()=>{console.log("Story completed!")}};this.storyBox=new O(this,s),this.storyBox.create()}update(t,e){var n;null==(n=this.storyBox)||n.update();const i=this.directionInput.direction;if(i&&this.player.getCurrentState()===_.IDLE){switch(i){case"up":this.player.moveUp();break;case"down":this.player.moveDown();break;case"left":this.player.moveLeft();break;case"right":this.player.moveRight()}const t=this.player.getOccupiedGrids();if(this.grid){const e=y(t,i),n=this.collisionChecker.isPositionFree(e);if(console.log("Can Move:",n),this.debugGraphics.clear(),this.visualizeOccupiedGrids(this.player.getOccupiedGrids(),65280),this.visualizeOccupiedGrids(e,16711680),n){const t=this.calculateCenterPosition(e),n=t.x,i=t.y;this.player.setPosition(n,i),this.player.updateOccupiedGrids(),this.player.setPlayerState(_.IDLE)}else console.log("Movement blocked."),this.player.stopMoving()}}}calculateCenterPosition(t){if(0===t.length)return console.error("Grids array is empty."),{x:0,y:0};const e=t[0],n=e.x*this.cellSize,i=e.y*this.cellSize,r=n+this.player.width*this.player.scaleX/2,s=i+this.player.height*this.player.scaleY/2;return console.log(`Grid Center World Coords: (${r}, ${s})`),{x:r,y:s}}visualizeOccupiedGrids(t,e){this.debugGraphics.fillStyle(e,.3),t.forEach((t=>{this.debugGraphics.fillRect(t.x*this.cellSize,t.y*this.cellSize,this.cellSize,this.cellSize)}))}shutdown(){var t;null==(t=this.storyBox)||t.destroy(),this.storyBox=null}}class Et extends n.Scene{constructor(){super("Boot")}preload(){this.load.pack("pack","assets/preload-asset-pack.json")}create(){this.scene.start("MainGameScene")}}window.addEventListener("load",(function(){new n.Game({width:1920,height:1080,backgroundColor:"#2f2f2f",parent:"game-container",scale:{mode:n.Scale.ScaleModes.FIT,autoCenter:n.Scale.Center.CENTER_BOTH},scene:[Et,g,p,Tt],dom:{createContainer:!0},physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}}}).scene.start("Boot")}));
